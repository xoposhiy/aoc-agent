
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../gpt-5_1/">
      
      
        <link rel="next" href="../../day_11/gemini-3-pro-preview/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>2025 Day 10 - gpt-5 (2) - AoC Agent Reports</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2025-day-10-gpt-5-2" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="AoC Agent Reports" class="md-header__button md-logo" aria-label="AoC Agent Reports" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AoC Agent Reports
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2025 Day 10 - gpt-5 (2)
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="AoC Agent Reports" class="md-nav__button md-logo" aria-label="AoC Agent Reports" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    AoC Agent Reports
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mission Control Center
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    2025
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    2025
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 01
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 01
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_01/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_01/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_01/gemini-3-pro-preview_1/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview 1
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview 1
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_01/gemini-3-pro-preview_2/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview 2
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview 2
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_01/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_01/gpt-5-mini/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 mini
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 mini
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_01/gpt-5_1/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 1
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 1
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 02
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 02
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_02/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_02/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_02/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 03
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 03
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_03/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_03/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_03/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 04
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 04
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_04/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_04/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_04/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 05
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 05
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_05/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_05/gemini-2.5-flash/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 2.5 flash
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 2.5 flash
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_05/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_05/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_05/gpt-5-mini/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 mini
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 mini
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_05/gpt-5_1/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 1
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 1
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 06
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 06
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_06/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_06/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_06/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_06/gpt-5-mini/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 mini
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 mini
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 07
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 07
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_07/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_07/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_07/gemini-3-pro-preview_1/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview 1
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview 1
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_07/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_07/gpt-5_1/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 1
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 1
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
        
          
          <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 08
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 08
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_08/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_08/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_08/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_08/gpt-5-mini/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 mini
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 mini
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
        
          
          <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 09
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 09
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_09/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_9_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_09/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_9_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_09/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_9_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10" checked>
        
          
          <label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 10
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 10
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_10_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_10_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_10_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_10_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../gpt-5_1/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 1
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_10_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_10_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 1
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10_4" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="./" class="md-nav__link md-nav__link--active">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 2
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_10_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_10_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 2
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11" >
        
          
          <label class="md-nav__link" for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 11
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 11
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_11/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_11_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_11/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_11_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="2025-day-10-gpt-5-2">2025 Day 10 - gpt-5 (2)</h1>
<ul>
<li><img alt="" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f916.svg" title=":robot:" /> <strong>Agent</strong>: MiniAgent (gpt-5 (2))</li>
<li><img alt="" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f1f7-1f1fa.svg" title=":flag_ru:" /> <strong>Language</strong>: python</li>
<li><img alt="" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/23f1.svg" title=":stopwatch:" /> <strong>Duration</strong>: 0.00s</li>
<li><img alt="" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2b50.svg" title=":star:" /> <strong>Stars</strong>: P1:  | P2: </li>
</ul>
<h1 id="10"> 10:   ,     </h1>
<p>    --       . :    ,     ,          .</p>
<p>      .    Python,       ,    .     !</p>
<hr />
<h2 id="_1">  </h2>
<p>     :</p>
<ul>
<li>      []      ( <code>#</code>  , <code>.</code>  ),</li>
<li>     ():       ( 1)    1   ( 2),</li>
<li>  {}     (    1 , ,    2).</li>
</ul>
<p>    AoC     input.txt.         .</p>
<hr />
<h2 id="1"> 1. :   </h2>
<p>:    n   m .     0/1  n: 1    .      2 (GF(2)).   A x = b (  2)          |x|       .</p>
<p>  :</p>
<ul>
<li>      2,     .</li>
<li>    x0.</li>
<li>   (nullspace)  d = m - rank(A).</li>
<li>     x = x0  (   ).  d  22         .     d  3,    .</li>
</ul>
<p> : solve_fast.py</p>
<ul>
<li> (     ): 399      AoC.</li>
</ul>
<hr />
<h2 id="2-ax-t"> 2. :      Ax = t</h2>
<p>      . :</p>
<ul>
<li>x     (    ),</li>
<li>A    0/1-   ,</li>
<li>   1^T x   A x = t (!), x  0, .</li>
</ul>
<p>  (     ):
1)    ,       (    ),     t_i=0.
2)  r     r    B (rr)    |det(B)| ( D=1).      F.
3)  b0 = adj(B)t_R, M = adj(B)A_{R,F}, D = |det(B)|.  x_C = (b0  Mx_F)/D.</p>
<ul>
<li>: x_C  0 , x_F  0 .</li>
<li>: sum(x) = sum(x_F) + sum((b0  M x_F)/D)     x_F.
4)    d = |F|  3 (  ).  d  2        D   (     ),       .  d=3      d=2       .</li>
</ul>
<p>:          .     2:      AoC.</p>
<p>:   2   (.  ).     :          .</p>
<hr />
<h2 id="_2"></h2>
<ul>
<li> viz.py     :       (   ).</li>
<li>    visualization.png.</li>
</ul>
<p><img alt="" src="visualization.png" /></p>
<p>   (  ):</p>
<ul>
<li>    ( )        gif  imageio,     .</li>
</ul>
<hr />
<h2 id="-">-  ()</h2>
<p> A  23, r=2,    C={0,1},    j=2. :</p>
<ul>
<li>B = A[:,C], D = |det(B)|, adj(B)   .</li>
<li>b0 = adj(B)t, M  21.</li>
<li>    x_C = (b0  Ms)/D, x_F = (s),  s   ,    mod D    ( x_C  0  ).   s + sum(x_C).  s   ,       .</li>
</ul>
<hr />
<h2 id="_3">  ()</h2>
<ul>
<li>GF(2) + nullspace ( 1):</li>
<li>
<ul>
<li>, , ;        .</li>
</ul>
</li>
<li>
<p>     .</p>
</li>
<li>
<p>A<em> / IDA</em>   ( 2):</p>
</li>
<li>
<ul>
<li> ,      (    ).</li>
</ul>
</li>
<li>
<p>     ,   .</p>
</li>
<li>
<p>LP/ILP- ( 2):</p>
</li>
<li>
<ul>
<li> ,  .</li>
</ul>
</li>
<li>
<p>           ;      .</p>
</li>
<li>
<p>, ,  D ( 2)   :</p>
</li>
<li>
<ul>
<li>   ;  ; d  3     .  D=1      .</li>
</ul>
</li>
<li>    (  ,  );       .</li>
</ul>
<hr />
<h2 id="_4">  </h2>
<ul>
<li> 1: (nm)   + 2^d    (d  3).   .</li>
<li> 2:    C(m,r)   (m  13, r  10),   22/33 ;  d  3         .      input.txt.</li>
</ul>
<p>:     10 .</p>
<hr />
<h2 id="_5"> </h2>
<ul>
<li> 1: python solve_fast.py &lt; input.txt    399 (    ).</li>
<li> 2:      B/adj/D.      AoC (.  ).</li>
<li>: python viz.py  visualization.png (  ).</li>
</ul>
<hr />
<h2 id="_6"></h2>
<p>    GF(2)-       (   ).  :       .         .</p>
<p>          1.          ,    .</p>
<h1 id="code-executions">Code Executions</h1>
<h2 id="solve_day10py"> solve_day10.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:15:41.233096</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="c1"># We will also optionally create a visualization for the first machine</span>
<span class="c1"># using either networkx+matplotlib or Pillow as a fallback.</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="c1"># Returns (num_lights, target_mask, column_masks)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]</span>
    <span class="c1"># Extract diagram</span>
    <span class="n">m_diagram</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[([.#]+)\]&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m_diagram</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No diagram [] found in line: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">diagram</span> <span class="o">=</span> <span class="n">m_diagram</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">diagram</span><span class="p">)</span>
    <span class="n">b_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">diagram</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
            <span class="n">b_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="c1"># Extract button schematics (parentheses)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="c1"># If there are braces at the end, re.findall will include them? No, braces are {} not (). So ok.</span>
    <span class="n">col_masks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">btn</span> <span class="o">=</span> <span class="n">btn</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">btn</span><span class="p">:</span>
            <span class="c1"># empty button toggles nothing</span>
            <span class="n">col_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Out-of-range indices are ignored per problem? The text implies indices refer to lights.</span>
                <span class="c1"># We&#39;ll still accept and ignore (they do nothing if outside range).</span>
                <span class="k">pass</span>
        <span class="n">col_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># Note: The last pair of parentheses could be from braces if someone used parentheses inside? Unlikely.</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">col_masks</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_basis</span><span class="p">(</span><span class="n">col_masks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a GF(2) column basis for the set of column vectors col_masks (over rows dimension).</span>
<span class="sd">    Returns:</span>
<span class="sd">      basis: dict pivot_row -&gt; (mask, coeffs), where &#39;mask&#39; is the column-space vector (over rows),</span>
<span class="sd">             and &#39;coeffs&#39; is an int with bits over variables (columns) representing combination of original columns.</span>
<span class="sd">      nullspace: list of coefficient vectors (ints over variables) that form a basis of the nullspace (dependencies among columns).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># row -&gt; (mask, coeffs)</span>
    <span class="n">nullspace</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_masks</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">orig_v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_masks</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">orig_v</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span>
        <span class="k">while</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">basis</span><span class="p">:</span>
                <span class="n">bv</span><span class="p">,</span> <span class="n">bc</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">^=</span> <span class="n">bv</span>
                <span class="n">c</span> <span class="o">^=</span> <span class="n">bc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">basis</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># dependent</span>
            <span class="n">nullspace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">basis</span><span class="p">,</span> <span class="n">nullspace</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_particular</span><span class="p">(</span><span class="n">b_mask</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">basis</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reduce b_mask using basis to find one solution coefficients over variables. Returns (ok, coeffs).&quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">b_mask</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">v</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">basis</span><span class="p">:</span>
            <span class="n">bv</span><span class="p">,</span> <span class="n">bc</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">^=</span> <span class="n">bv</span>
            <span class="n">c</span> <span class="o">^=</span> <span class="n">bc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">c</span>


<span class="k">def</span><span class="w"> </span><span class="nf">popcount</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">minimal_weight_solution</span><span class="p">(</span><span class="n">x0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nullspace</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">22</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given particular solution x0 (int over m bits) and nullspace vectors (ints over m bits),</span>
<span class="sd">    find the minimal Hamming weight solution x = x0 XOR sum(t_i * nullspace[i]).</span>
<span class="sd">    Returns (best_weight, best_x).</span>
<span class="sd">    For d &lt;= threshold, brute-force via Gray code.</span>
<span class="sd">    For d &gt; threshold, use a bounded DFS with greedy ordering and pruning.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nullspace</span><span class="p">)</span>
    <span class="n">best_x</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="n">best_w</span> <span class="o">=</span> <span class="n">popcount</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span>
    <span class="c1"># Sort nullspace vectors by how much they overlap with x0 (descending), heuristic to reduce early.</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nullspace</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">popcount</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">x0</span><span class="p">),</span> <span class="n">popcount</span><span class="p">(</span><span class="n">v</span><span class="p">)),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="c1"># Gray code enumeration</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="n">cur_w</span> <span class="o">=</span> <span class="n">best_w</span>
        <span class="n">prev_gray</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># k = 0 already accounted (subset empty)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">d</span><span class="p">):</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">k</span> <span class="o">^</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">g</span> <span class="o">^</span> <span class="n">prev_gray</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">^=</span> <span class="n">ns</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">cur_w</span> <span class="o">=</span> <span class="n">popcount</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cur_w</span> <span class="o">&lt;</span> <span class="n">best_w</span><span class="p">:</span>
                <span class="n">best_w</span> <span class="o">=</span> <span class="n">cur_w</span>
                <span class="n">best_x</span> <span class="o">=</span> <span class="n">cur</span>
                <span class="k">if</span> <span class="n">best_w</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">prev_gray</span> <span class="o">=</span> <span class="n">g</span>
        <span class="k">return</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span>

    <span class="c1"># Fallback: bounded DFS with pruning</span>
    <span class="c1"># Precompute popcounts and overlaps to speed up.</span>
    <span class="n">popc</span> <span class="o">=</span> <span class="p">[</span><span class="n">popcount</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">]</span>

    <span class="c1"># Upper bound starts with best_w</span>
    <span class="c1"># We&#39;ll maintain cur solution and try to reduce weight; branch on include/exclude decision.</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>

    <span class="c1"># We can compute an optimistic lower bound on achievable weight by assuming from remaining vectors we can </span>
    <span class="c1"># cancel all ones that are in the linear span of their projections on current 1-positions. Approximated by</span>
    <span class="c1"># u = number of unique bit positions among remaining vectors that overlap with x -&gt; but computing exact span size is expensive.</span>
    <span class="c1"># We&#39;ll use a cheap bound: for remaining vectors i&gt;=k, the maximum number of 1s we could possibly turn off is at most</span>
    <span class="c1"># the rank (over GF(2)) of the set of restriction of ns[i] to current-1 positions. We&#39;ll approximate rank by greedily building a basis on the fly.</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimistic_bound</span><span class="p">(</span><span class="n">cur_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">ones_mask</span> <span class="o">=</span> <span class="n">cur_x</span>
        <span class="c1"># Build a small basis restricted to ones positions</span>
        <span class="n">basis_rows</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="n">ns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">ones_mask</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">vec</span>
            <span class="k">while</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">basis_rows</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">^=</span> <span class="n">basis_rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">basis_rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">break</span>
        <span class="c1"># The rank equals number of basis vectors we could use to cancel ones</span>
        <span class="n">max_cancellable</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis_rows</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">best_w</span> <span class="o">-</span> <span class="n">max_cancellable</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># not used directly; we want lower bound on final weight</span>

    <span class="n">best_solution</span> <span class="o">=</span> <span class="n">best_x</span>

    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cur_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cur_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">nonlocal</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_solution</span>
        <span class="c1"># Prune by lower bound</span>
        <span class="c1"># Compute an optimistic lower bound on achievable weight from here</span>
        <span class="c1"># Use max(0, cur_w - max_cancellable)</span>
        <span class="c1"># Compute rank approximation lazily (costly per node); trade-off: we also cap recursion by thresholding</span>
        <span class="c1"># We&#39;ll do a cheaper bound: if cur_w &gt;= best_w and even making each remaining vector at best reduce 1, then prune.</span>
        <span class="c1"># Cheap bound: cur_w - min(cur_w, d - idx) &lt; best_w must hold to continue.</span>
        <span class="k">if</span> <span class="n">cur_w</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">cur_w</span><span class="p">,</span> <span class="n">d</span> <span class="o">-</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">best_w</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cur_w</span> <span class="o">&lt;</span> <span class="n">best_w</span><span class="p">:</span>
                <span class="n">best_w</span> <span class="o">=</span> <span class="n">cur_w</span>
                <span class="n">best_solution</span> <span class="o">=</span> <span class="n">cur_x</span>
            <span class="k">return</span>
        <span class="c1"># Heuristic: try the branch that reduces weight more first</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">ns</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">w_if_flip</span> <span class="o">=</span> <span class="n">popcount</span><span class="p">(</span><span class="n">cur_x</span> <span class="o">^</span> <span class="n">v</span><span class="p">)</span>
        <span class="c1"># Order branches: choose flip if it decreases weight</span>
        <span class="k">if</span> <span class="n">w_if_flip</span> <span class="o">&lt;</span> <span class="n">cur_w</span><span class="p">:</span>
            <span class="n">dfs</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cur_x</span> <span class="o">^</span> <span class="n">v</span><span class="p">,</span> <span class="n">w_if_flip</span><span class="p">)</span>
            <span class="c1"># also try not flipping</span>
            <span class="k">if</span> <span class="n">cur_w</span> <span class="o">&lt;</span> <span class="n">best_w</span><span class="p">:</span>
                <span class="n">dfs</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cur_x</span><span class="p">,</span> <span class="n">cur_w</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfs</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cur_x</span><span class="p">,</span> <span class="n">cur_w</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">w_if_flip</span> <span class="o">&lt;</span> <span class="n">best_w</span><span class="p">:</span>
                <span class="n">dfs</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cur_x</span> <span class="o">^</span> <span class="n">v</span><span class="p">,</span> <span class="n">w_if_flip</span><span class="p">)</span>

    <span class="n">dfs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">popcount</span><span class="p">(</span><span class="n">x0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_solution</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_all</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># for visualization: (n, b_mask, col_masks, best_w, best_solution)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">col_masks</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">basis</span><span class="p">,</span> <span class="n">nullspace</span> <span class="o">=</span> <span class="n">build_basis</span><span class="p">(</span><span class="n">col_masks</span><span class="p">)</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">solve_particular</span><span class="p">(</span><span class="n">b_mask</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inconsistent system for a machine; cannot configure lights.&quot;</span><span class="p">)</span>
        <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span> <span class="o">=</span> <span class="n">minimal_weight_solution</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">nullspace</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">best_w</span>
        <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">col_masks</span><span class="p">,</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">total</span><span class="p">,</span> <span class="n">details</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_visual</span><span class="p">(</span><span class="n">details</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;visualization.png&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">col_masks</span><span class="p">,</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_masks</span><span class="p">)</span>
    <span class="n">chosen</span> <span class="o">=</span> <span class="p">[((</span><span class="n">best_x</span> <span class="o">&gt;&gt;</span> <span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="c1"># Try networkx + matplotlib</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="c1"># Add nodes</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">bipartite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;B</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">chosen</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">label</span> <span class="o">+=</span> <span class="s2">&quot;*&quot;</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">bipartite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Add edges</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_masks</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;B</span><span class="si">{</span><span class="n">j</span><span class="si">}{</span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">chosen</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">top_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="n">bottom_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;B</span><span class="si">{</span><span class="n">j</span><span class="si">}{</span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">chosen</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pos</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_nodes</span><span class="p">))</span>
        <span class="n">pos</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bottom_nodes</span><span class="p">))</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gold&#39;</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;skyblue&#39;</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bottom_nodes</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">m</span><span class="o">*</span><span class="mf">0.3</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">n</span><span class="o">*</span><span class="mf">0.3</span><span class="p">)))</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">top_nodes</span><span class="p">)</span><span class="o">+</span><span class="n">colors</span><span class="p">,</span>
                <span class="n">nodelist</span><span class="o">=</span><span class="n">top_nodes</span><span class="o">+</span><span class="n">bottom_nodes</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; :   = </span><span class="si">{</span><span class="n">best_w</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="c1"># Fallback: simple Pillow image with text summary</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span>
        <span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">),</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;  ( matplotlib/networkx).&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">, : </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot; : </span><span class="si">{</span><span class="n">best_w</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot; : </span><span class="si">{</span><span class="p">[</span><span class="n">j</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">chosen</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="mi">24</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># give up silently</span>
        <span class="k">pass</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">total</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">solve_all</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
    <span class="c1"># Also generate a visualization file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">generate_visual</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="s1">&#39;visualization.png&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10py_1"> solve_day10.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:17:34.994849</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_1">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="c1"># We will also optionally create a visualization for the first machine</span>
<span class="c1"># using either networkx+matplotlib or Pillow as a fallback.</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="c1"># Returns (num_lights, target_mask, column_masks)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]</span>
    <span class="c1"># Extract diagram</span>
    <span class="n">m_diagram</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[([.#]+)\]&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m_diagram</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No diagram [] found in line: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">diagram</span> <span class="o">=</span> <span class="n">m_diagram</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">diagram</span><span class="p">)</span>
    <span class="n">b_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">diagram</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
            <span class="n">b_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="c1"># Extract button schematics (parentheses)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">col_masks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">btn</span> <span class="o">=</span> <span class="n">btn</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">btn</span><span class="p">:</span>
            <span class="c1"># empty button toggles nothing</span>
            <span class="n">col_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Ignore out-of-range indices</span>
                <span class="k">pass</span>
        <span class="n">col_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">col_masks</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_basis</span><span class="p">(</span><span class="n">col_masks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a GF(2) column basis for the set of column vectors col_masks (over rows dimension).</span>
<span class="sd">    Returns:</span>
<span class="sd">      basis: dict pivot_row -&gt; (mask, coeffs), where &#39;mask&#39; is the column-space vector (over rows),</span>
<span class="sd">             and &#39;coeffs&#39; is an int with bits over variables (columns) representing combination of original columns.</span>
<span class="sd">      nullspace: list of coefficient vectors (ints over variables) that form a basis of the nullspace (dependencies among columns).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># row -&gt; (mask, coeffs)</span>
    <span class="n">nullspace</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">orig_v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_masks</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">orig_v</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span>
        <span class="k">while</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">basis</span><span class="p">:</span>
                <span class="n">bv</span><span class="p">,</span> <span class="n">bc</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">^=</span> <span class="n">bv</span>
                <span class="n">c</span> <span class="o">^=</span> <span class="n">bc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">basis</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># dependent</span>
            <span class="n">nullspace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">basis</span><span class="p">,</span> <span class="n">nullspace</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_particular</span><span class="p">(</span><span class="n">b_mask</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">basis</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reduce b_mask using basis to find one solution coefficients over variables. Returns (ok, coeffs).&quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">b_mask</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">v</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">basis</span><span class="p">:</span>
            <span class="n">bv</span><span class="p">,</span> <span class="n">bc</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">^=</span> <span class="n">bv</span>
            <span class="n">c</span> <span class="o">^=</span> <span class="n">bc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">c</span>


<span class="k">def</span><span class="w"> </span><span class="nf">popcount</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">minimal_weight_solution</span><span class="p">(</span><span class="n">x0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nullspace</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">22</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given particular solution x0 (int over m bits) and nullspace vectors (ints over m bits),</span>
<span class="sd">    find the minimal Hamming weight solution x = x0 XOR sum(t_i * nullspace[i]).</span>
<span class="sd">    Returns (best_weight, best_x).</span>
<span class="sd">    For d &lt;= threshold, brute-force via Gray code.</span>
<span class="sd">    For d &gt; threshold, use a bounded DFS with greedy ordering and pruning.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nullspace</span><span class="p">)</span>
    <span class="n">best_x</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="n">best_w</span> <span class="o">=</span> <span class="n">popcount</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span>
    <span class="c1"># Sort nullspace vectors by how much they overlap with x0 (descending), heuristic to reduce early.</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nullspace</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="p">(</span><span class="n">popcount</span><span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">x0</span><span class="p">),</span> <span class="n">popcount</span><span class="p">(</span><span class="n">v</span><span class="p">)),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="c1"># Gray code enumeration</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="n">cur_w</span> <span class="o">=</span> <span class="n">best_w</span>
        <span class="n">prev_gray</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># k = 0 already accounted (subset empty)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">d</span><span class="p">):</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">k</span> <span class="o">^</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">g</span> <span class="o">^</span> <span class="n">prev_gray</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">cur</span> <span class="o">^=</span> <span class="n">ns</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">cur_w</span> <span class="o">=</span> <span class="n">popcount</span><span class="p">(</span><span class="n">cur</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cur_w</span> <span class="o">&lt;</span> <span class="n">best_w</span><span class="p">:</span>
                <span class="n">best_w</span> <span class="o">=</span> <span class="n">cur_w</span>
                <span class="n">best_x</span> <span class="o">=</span> <span class="n">cur</span>
                <span class="k">if</span> <span class="n">best_w</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">prev_gray</span> <span class="o">=</span> <span class="n">g</span>
        <span class="k">return</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span>

    <span class="c1"># Fallback: bounded DFS with pruning</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>

    <span class="c1"># Upper bound starts with best_w</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cur_x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cur_w</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span>
        <span class="c1"># Cheap bound: even if each remaining vector reduces weight by 1, can we beat best_w?</span>
        <span class="k">if</span> <span class="n">cur_w</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">cur_w</span><span class="p">,</span> <span class="n">d</span> <span class="o">-</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">best_w</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cur_w</span> <span class="o">&lt;</span> <span class="n">best_w</span><span class="p">:</span>
                <span class="n">best_w</span> <span class="o">=</span> <span class="n">cur_w</span>
                <span class="n">best_x</span> <span class="o">=</span> <span class="n">cur_x</span>
            <span class="k">return</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">ns</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">w_flip</span> <span class="o">=</span> <span class="n">popcount</span><span class="p">(</span><span class="n">cur_x</span> <span class="o">^</span> <span class="n">v</span><span class="p">)</span>
        <span class="c1"># explore better branch first</span>
        <span class="k">if</span> <span class="n">w_flip</span> <span class="o">&lt;</span> <span class="n">cur_w</span><span class="p">:</span>
            <span class="n">dfs</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cur_x</span> <span class="o">^</span> <span class="n">v</span><span class="p">,</span> <span class="n">w_flip</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cur_w</span> <span class="o">&lt;</span> <span class="n">best_w</span><span class="p">:</span>
                <span class="n">dfs</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cur_x</span><span class="p">,</span> <span class="n">cur_w</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dfs</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cur_x</span><span class="p">,</span> <span class="n">cur_w</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">w_flip</span> <span class="o">&lt;</span> <span class="n">best_w</span><span class="p">:</span>
                <span class="n">dfs</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cur_x</span> <span class="o">^</span> <span class="n">v</span><span class="p">,</span> <span class="n">w_flip</span><span class="p">)</span>

    <span class="n">dfs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">best_w</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_all</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># for visualization: (n, b_mask, col_masks, best_w, best_solution)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">col_masks</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">basis</span><span class="p">,</span> <span class="n">nullspace</span> <span class="o">=</span> <span class="n">build_basis</span><span class="p">(</span><span class="n">col_masks</span><span class="p">)</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">solve_particular</span><span class="p">(</span><span class="n">b_mask</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inconsistent system for a machine; cannot configure lights.&quot;</span><span class="p">)</span>
        <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span> <span class="o">=</span> <span class="n">minimal_weight_solution</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">nullspace</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">best_w</span>
        <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">col_masks</span><span class="p">,</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">total</span><span class="p">,</span> <span class="n">details</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_visual</span><span class="p">(</span><span class="n">details</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;visualization.png&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">col_masks</span><span class="p">,</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_masks</span><span class="p">)</span>
    <span class="n">chosen</span> <span class="o">=</span> <span class="p">[((</span><span class="n">best_x</span> <span class="o">&gt;&gt;</span> <span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="c1"># Try networkx + matplotlib</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="c1"># Add nodes</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">bipartite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;B</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">chosen</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">label</span> <span class="o">+=</span> <span class="s2">&quot;*&quot;</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">bipartite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Add edges</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_masks</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;B</span><span class="si">{</span><span class="n">j</span><span class="si">}{</span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">chosen</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">top_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="n">bottom_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;B</span><span class="si">{</span><span class="n">j</span><span class="si">}{</span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">chosen</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pos</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_nodes</span><span class="p">))</span>
        <span class="n">pos</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bottom_nodes</span><span class="p">))</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gold&#39;</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;skyblue&#39;</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">bottom_nodes</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">m</span><span class="o">*</span><span class="mf">0.3</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">n</span><span class="o">*</span><span class="mf">0.3</span><span class="p">)))</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">top_nodes</span><span class="p">)</span><span class="o">+</span><span class="n">colors</span><span class="p">,</span>
                <span class="n">nodelist</span><span class="o">=</span><span class="n">top_nodes</span><span class="o">+</span><span class="n">bottom_nodes</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; :   = </span><span class="si">{</span><span class="n">best_w</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="c1"># Fallback: simple Pillow image with text summary</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span>
        <span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">),</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;  ( matplotlib/networkx).&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">, : </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot; : </span><span class="si">{</span><span class="n">best_w</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot; : </span><span class="si">{</span><span class="p">[</span><span class="n">j</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">chosen</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="mi">24</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># give up silently</span>
        <span class="k">pass</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">solve_all</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
    <span class="c1"># Also generate a visualization file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">generate_visual</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="s1">&#39;visualization.png&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10py_2"> solve_day10.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:20:17.062660</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_2">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="c1"># Returns (num_lights, target_mask, column_masks)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]</span>
    <span class="n">m_diagram</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[([.#]+)\]&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m_diagram</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No diagram [] found in line: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">diagram</span> <span class="o">=</span> <span class="n">m_diagram</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">diagram</span><span class="p">)</span>
    <span class="n">b_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">diagram</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
            <span class="n">b_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">col_masks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">btn</span> <span class="o">=</span> <span class="n">btn</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">btn</span><span class="p">:</span>
            <span class="n">col_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="n">col_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">col_masks</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bfs_min_presses</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">b_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Remove zero columns (they don&#39;t change state); but a zero column can still be pressed but never helpful for shortest path.</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">b_mask</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">q</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">s</span> <span class="o">^</span> <span class="n">c</span>
            <span class="k">if</span> <span class="n">dist</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ns</span> <span class="o">==</span> <span class="n">b_mask</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">nd</span>
                <span class="n">dist</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd</span>
                <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist</span><span class="p">[</span><span class="n">b_mask</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_all</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]]]:</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># (n, b_mask, cols, best_w)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">presses</span> <span class="o">=</span> <span class="n">bfs_min_presses</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">presses</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Machine is unsatisfiable with given buttons.&quot;</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">presses</span>
        <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">presses</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">total</span><span class="p">,</span> <span class="n">details</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_visual</span><span class="p">(</span><span class="n">details</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;visualization.png&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">presses</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="c1"># Try networkx + matplotlib to draw bipartite graph lights-buttons</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
        <span class="n">lights</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">i</span><span class="si">}{</span><span class="s1">&#39;#&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">b_mask</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;.&#39;</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
        <span class="n">buttons</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;B</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">lights</span><span class="p">,</span> <span class="n">bipartite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_nodes_from</span><span class="p">(</span><span class="n">buttons</span><span class="p">,</span> <span class="n">bipartite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">lights</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">buttons</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">pos</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lights</span><span class="p">))</span>
        <span class="n">pos</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">m</span><span class="o">*</span><span class="mf">0.25</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">n</span><span class="o">*</span><span class="mf">0.3</span><span class="p">)))</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">lights</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;skyblue&#39;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">),</span>
                <span class="n">nodelist</span><span class="o">=</span><span class="n">lights</span><span class="o">+</span><span class="n">buttons</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">800</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; : =</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">, =</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">,  =</span><span class="si">{</span><span class="n">presses</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="c1"># Fallback: Pillow text</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>
        <span class="n">W</span><span class="p">,</span> <span class="n">H</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">300</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">),</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;  ( matplotlib/networkx).&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;: </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">, : </span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot; : </span><span class="si">{</span><span class="n">presses</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">t</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="mi">24</span>
        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">solve_all</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">generate_visual</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="s1">&#39;visualization.png&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10py_3"> solve_day10.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:22:07.020611</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_3">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="c1"># Returns (num_lights, target_mask, column_masks)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]</span>
    <span class="n">m_diagram</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[([.#]+)\]&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m_diagram</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No diagram [] found in line: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">diagram</span> <span class="o">=</span> <span class="n">m_diagram</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">diagram</span><span class="p">)</span>
    <span class="n">b_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">diagram</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
            <span class="n">b_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">col_masks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">btn</span> <span class="o">=</span> <span class="n">btn</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">btn</span><span class="p">:</span>
            <span class="n">col_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="n">col_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">col_masks</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bfs_min_presses</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">b_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">dist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">q</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">s</span> <span class="o">^</span> <span class="n">c</span>
            <span class="k">if</span> <span class="n">dist</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ns</span> <span class="o">==</span> <span class="n">b_mask</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">nd</span>
                <span class="n">dist</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd</span>
                <span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dist</span><span class="p">[</span><span class="n">b_mask</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_all</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]]]:</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># (n, b_mask, cols, best_w)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">presses</span> <span class="o">=</span> <span class="n">bfs_min_presses</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">presses</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Machine is unsatisfiable with given buttons.&quot;</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">presses</span>
        <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">presses</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">total</span><span class="p">,</span> <span class="n">details</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_visual</span><span class="p">(</span><span class="n">details</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]],</span> <span class="n">outfile</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;visualization.png&#39;</span><span class="p">):</span>
    <span class="c1"># Lightweight Pillow visualization of first machine</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">presses</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">W</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">40</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
    <span class="n">H</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">m</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">),</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="c1"># Draw lights as circles on top row</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">spacing</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">spacing</span> <span class="o">+</span> <span class="n">spacing</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">on</span> <span class="o">=</span> <span class="p">(</span><span class="n">b_mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;gold&#39;</span> <span class="k">if</span> <span class="n">on</span> <span class="k">else</span> <span class="s1">&#39;lightgray&#39;</span>
        <span class="n">d</span><span class="o">.</span><span class="n">ellipse</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">r</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">r</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">14</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="c1"># Draw buttons as small bars per column mask</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="mi">120</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">16</span>
        <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">6</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;B</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">spacing</span> <span class="o">+</span> <span class="n">spacing</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">d</span><span class="o">.</span><span class="n">rectangle</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mi">6</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">6</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="n">H</span> <span class="o">-</span> <span class="mi">30</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;    : </span><span class="si">{</span><span class="n">presses</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">solve_all</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">generate_visual</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="s1">&#39;visualization.png&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10py_4"> solve_day10.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:23:56.387717</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_4">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="c1"># Efficient linear algebra over GF(2) with bitmasks</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]</span>
    <span class="n">m_diagram</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[([.#]+)\]&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m_diagram</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No diagram [] found in line: </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">diagram</span> <span class="o">=</span> <span class="n">m_diagram</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">diagram</span><span class="p">)</span>
    <span class="n">b_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">diagram</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
            <span class="n">b_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">col_masks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">btn</span> <span class="o">=</span> <span class="n">btn</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">btn</span><span class="p">:</span>
            <span class="n">col_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="n">col_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">col_masks</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_basis_and_nullspace</span><span class="p">(</span><span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs column-wise Gaussian elimination on list of column vectors (bitmasks over rows).</span>
<span class="sd">    Returns:</span>
<span class="sd">      basis: list of (pivot_row, coeffs) where coeffs is combination of original columns giving the basis column vector.</span>
<span class="sd">      nullspace: list of coefficient vectors for dependencies among columns (basis of nullspace).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># pivot_row -&gt; (vec_mask, coeffs_mask)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># to maintain order of insertion</span>
    <span class="n">nullspace</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v0</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span>
        <span class="k">while</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">basis</span><span class="p">:</span>
                <span class="n">bv</span><span class="p">,</span> <span class="n">bc</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">^=</span> <span class="n">bv</span>
                <span class="n">c</span> <span class="o">^=</span> <span class="n">bc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">basis</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># dependent</span>
            <span class="n">nullspace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[(</span><span class="n">r</span><span class="p">,</span> <span class="n">basis</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">order</span><span class="p">],</span> <span class="n">nullspace</span>


<span class="k">def</span><span class="w"> </span><span class="nf">particular_solution</span><span class="p">(</span><span class="n">b_mask</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">basis</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]],</span> <span class="n">pivot_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reduce b using the basis; also compute one set of coefficients x0 (over variables).&quot;&quot;&quot;</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">b_mask</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">v</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pivot_map</span><span class="p">:</span>
            <span class="n">bv</span><span class="p">,</span> <span class="n">bc</span> <span class="o">=</span> <span class="n">pivot_map</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">^=</span> <span class="n">bv</span>
            <span class="n">c</span> <span class="o">^=</span> <span class="n">bc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">c</span>


<span class="k">def</span><span class="w"> </span><span class="nf">minimal_weight_solution</span><span class="p">(</span><span class="n">x0</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nullspace</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nullspace</span><span class="p">)</span>
    <span class="n">best_x</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="n">best_w</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span>
    <span class="c1"># Enumerate all 2^d choices; d is small (&lt;= m - rank &lt;= max(0, m - n))</span>
    <span class="c1"># For safety, if d is large, limit to 22 as fallback Gray code, but here d is small in puzzle.</span>
    <span class="c1"># Use Gray code for speed.</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">nullspace</span>
    <span class="n">cur</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="n">cur_w</span> <span class="o">=</span> <span class="n">best_w</span>
    <span class="n">prev_gray</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">k</span> <span class="o">^</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">g</span> <span class="o">^</span> <span class="n">prev_gray</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">cur</span> <span class="o">^=</span> <span class="n">ns</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">cur_w</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cur_w</span> <span class="o">&lt;</span> <span class="n">best_w</span><span class="p">:</span>
            <span class="n">best_w</span> <span class="o">=</span> <span class="n">cur_w</span>
            <span class="n">best_x</span> <span class="o">=</span> <span class="n">cur</span>
            <span class="k">if</span> <span class="n">best_w</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">prev_gray</span> <span class="o">=</span> <span class="n">g</span>
    <span class="k">return</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_all</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">,</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]]]:</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">details</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># (n, b, cols, best_w, best_x)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="c1"># Build basis</span>
        <span class="n">basis_pairs</span><span class="p">,</span> <span class="n">nullspace</span> <span class="o">=</span> <span class="n">build_basis_and_nullspace</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="c1"># map for reduction (pivot row -&gt; (vec, coeffs))</span>
        <span class="n">pivot_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># reconstruct vec from coeffs: vec = sum_j coeff_bit_j * cols[j]</span>
        <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">coeffs</span> <span class="ow">in</span> <span class="n">basis_pairs</span><span class="p">:</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">coeffs</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">lb</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">c</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">vec</span> <span class="o">^=</span> <span class="n">cols</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">c</span> <span class="o">^=</span> <span class="n">lb</span>
                <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">pivot_map</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">)</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">particular_solution</span><span class="p">(</span><span class="n">b_mask</span><span class="p">,</span> <span class="n">basis_pairs</span><span class="p">,</span> <span class="n">pivot_map</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Inconsistent system; cannot configure lights for a machine.&quot;</span><span class="p">)</span>
        <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span> <span class="o">=</span> <span class="n">minimal_weight_solution</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">nullspace</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">best_w</span>
        <span class="n">details</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">total</span><span class="p">,</span> <span class="n">details</span>


<span class="k">def</span><span class="w"> </span><span class="nf">generate_visual</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="s1">&#39;visualization.png&#39;</span><span class="p">):</span>
    <span class="c1"># Small Pillow visualization for the first machine</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">details</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">best_w</span><span class="p">,</span> <span class="n">best_x</span> <span class="o">=</span> <span class="n">details</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">W</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">40</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
    <span class="n">H</span> <span class="o">=</span> <span class="mi">220</span> <span class="o">+</span> <span class="mi">18</span> <span class="o">*</span> <span class="n">m</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">),</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">spacing</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">spacing</span> <span class="o">+</span> <span class="n">spacing</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">on</span> <span class="o">=</span> <span class="p">(</span><span class="n">b_mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;gold&#39;</span> <span class="k">if</span> <span class="n">on</span> <span class="k">else</span> <span class="s1">&#39;lightgray&#39;</span>
        <span class="n">d</span><span class="o">.</span><span class="n">ellipse</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">r</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">r</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">14</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">chosen</span> <span class="o">=</span> <span class="p">[((</span><span class="n">best_x</span> <span class="o">&gt;&gt;</span> <span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">16</span>
        <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">6</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;B</span><span class="si">{</span><span class="n">j</span><span class="si">}{</span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">chosen</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">spacing</span> <span class="o">+</span> <span class="n">spacing</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;deepskyblue&#39;</span> <span class="k">if</span> <span class="n">chosen</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;lightblue&#39;</span>
                <span class="n">d</span><span class="o">.</span><span class="n">rectangle</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mi">6</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">6</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="n">H</span> <span class="o">-</span> <span class="mi">30</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;    : </span><span class="si">{</span><span class="n">best_w</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">total</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">solve_all</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">generate_visual</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="s1">&#39;visualization.png&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="debug_statspy"> debug_stats.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:25:25.936556</li>
<li><strong>Duration</strong>: 0.13s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout">Stdout</h3>
<div class="highlight"><pre><span></span><code>157 machines
max n 10
max m 13
avg m 7.222929936305732
</code></pre></div>
<h3 id="code_5">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">m_diagram</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[([.#]+)\]&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">diagram</span> <span class="o">=</span> <span class="n">m_diagram</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">diagram</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stats</span><span class="p">),</span> <span class="s1">&#39;machines&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;max n&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;max m&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">m</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;avg m&#39;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">m</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">stats</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_fastpy"> solve_fast.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:26:05.391051</li>
<li><strong>Duration</strong>: 0.10s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout_1">Stdout</h3>
<div class="highlight"><pre><span></span><code>399
</code></pre></div>
<h3 id="code_6">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">m_diagram</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[([.#]+)\]&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">diagram</span> <span class="o">=</span> <span class="n">m_diagram</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">diagram</span><span class="p">)</span>
    <span class="n">b_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">diagram</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
            <span class="n">b_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">b_mask</span><span class="p">,</span> <span class="n">cols</span>


<span class="k">def</span><span class="w"> </span><span class="nf">gauss_cols</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">order</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nullspace</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v0</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span>
        <span class="k">while</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">basis</span><span class="p">:</span>
                <span class="n">bv</span><span class="p">,</span> <span class="n">bc</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">^=</span> <span class="n">bv</span>
                <span class="n">c</span> <span class="o">^=</span> <span class="n">bc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">basis</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nullspace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c1"># build pivot map fully materialized vecs</span>
    <span class="n">pivot_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">coeffs</span>
        <span class="k">while</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">c</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">vec</span> <span class="o">^=</span> <span class="n">cols</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">c</span> <span class="o">^=</span> <span class="n">lb</span>
        <span class="n">pivot_map</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">order</span><span class="p">,</span> <span class="n">pivot_map</span><span class="p">,</span> <span class="n">nullspace</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="n">order</span><span class="p">,</span> <span class="n">pivot_map</span><span class="p">,</span> <span class="n">nullspace</span> <span class="o">=</span> <span class="n">gauss_cols</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="c1"># reduce b</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">b</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">v</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pivot_map</span><span class="p">:</span>
            <span class="n">vec</span><span class="p">,</span> <span class="n">coeffs</span> <span class="o">=</span> <span class="n">pivot_map</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">^=</span> <span class="n">vec</span>
            <span class="n">x0</span> <span class="o">^=</span> <span class="n">coeffs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># inconsistent</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="n">best_w</span> <span class="o">=</span> <span class="n">best</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nullspace</span><span class="p">)</span>
    <span class="c1"># enumerate all additions from nullspace (d small: &lt;= m - rank &lt;= max(0, m-n) &lt;= 3 typically)</span>
    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">d</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">mm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mm</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">^=</span> <span class="n">nullspace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">mm</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">best_w</span><span class="p">:</span>
            <span class="n">best_w</span> <span class="o">=</span> <span class="n">w</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">return</span> <span class="n">best_w</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">n</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;inconsistent&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">w</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2py"> solve_day10_part2.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:27:47.729677</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_7">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">m_diagram</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m_diagram</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No joltage braces&#39;</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m_diagram</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># length-k vectors with 0/1 entries</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="c1"># We need nonnegative integer x minimizing sum(x) s.t. A x = t over integers, where A is 0/1 matrix.</span>
    <span class="c1"># This is a classic minimum-sum nonnegative solution to linear system with 0/1 entries.</span>
    <span class="c1"># Observation: Work over integers; because columns are 0/1, the parity constraints must hold: A x mod 2 = t mod 2.</span>
    <span class="c1"># Strategy:</span>
    <span class="c1"># - Enumerate a parity solution x_parity over GF(2) to match t mod 2 with minimum Hamming weight (like part 1 but over counters dim).</span>
    <span class="c1"># - Then, to increase any coordinate by 2 without changing parity, we can add any vector y in the lattice L = {A z : z in (2Z)^m}.</span>
    <span class="c1">#   Equivalently, increase selected buttons by 2 multiples. This increases sum(x) by 2*sum(z).</span>
    <span class="c1"># - To reach exact integer targets t, we need x such that A x = t. Let x = x_parity + 2 u, u &gt;= 0 integer. Then A x_parity + 2 A u = t.</span>
    <span class="c1">#   Let r = (t - A x_parity) / 2, which is integer vector. We need to solve A u = r with u &gt;= 0 minimizing sum(u).</span>
    <span class="c1"># Now A u = r is a nonnegative integer least-1-norm solution problem. Because sizes are tiny (k&lt;=10, m&lt;=13), we can solve with BFS on states r.</span>

    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="c1"># Build row masks for columns; here rows are counters.</span>
    <span class="c1"># First phase: parity optimization identical to part 1 but roles flipped: columns are button vectors over k-dim space.</span>
    <span class="c1"># Build basis and nullspace of columns in GF(2)</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">order</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nullspace</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">v0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v0</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span>
        <span class="k">while</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">basis</span><span class="p">:</span>
                <span class="n">bv</span><span class="p">,</span> <span class="n">bc</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
                <span class="n">v</span> <span class="o">^=</span> <span class="n">bv</span>
                <span class="n">c</span> <span class="o">^=</span> <span class="n">bc</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">basis</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
                <span class="n">order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nullspace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="c1"># materialize pivot vectors and coeffs</span>
    <span class="n">pivot_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">basis</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">coeffs</span>
        <span class="k">while</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">c</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">vec</span> <span class="o">^=</span> <span class="n">cols</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">c</span> <span class="o">^=</span> <span class="n">lb</span>
        <span class="n">pivot_map</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">coeffs</span><span class="p">)</span>
    <span class="c1"># reduce targets parity</span>
    <span class="n">t_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">t_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">t_mask</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">v</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">pivot_map</span><span class="p">:</span>
            <span class="n">vec</span><span class="p">,</span> <span class="n">coeffs</span> <span class="o">=</span> <span class="n">pivot_map</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">^=</span> <span class="n">vec</span>
            <span class="n">x0</span> <span class="o">^=</span> <span class="n">coeffs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Parity infeasible</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Parity infeasible&#39;</span><span class="p">)</span>
    <span class="c1"># Minimize Hamming weight among parity solutions</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="n">best_w</span> <span class="o">=</span> <span class="n">best</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nullspace</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">d</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">mm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mm</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">^=</span> <span class="n">nullspace</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">mm</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">&lt;</span> <span class="n">best_w</span><span class="p">:</span>
            <span class="n">best_w</span> <span class="o">=</span> <span class="n">w</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">x_par</span> <span class="o">=</span> <span class="n">best</span>
    <span class="c1"># Compute residual r = (t - A x_par)/2, represented as small ints vector</span>
    <span class="c1"># Compute y = A x_par as int vector</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">x_par</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">c</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">lb</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="mi">1</span>  <span class="c1"># over GF(2), but we just need parity; we&#39;ll add to t and divide by 2</span>
        <span class="n">c</span> <span class="o">^=</span> <span class="n">lb</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># must be even by construction</span>
        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diff</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Now we need A u = r with u&gt;=0 minimizing sum(u). Small k,m; we can do multi-source BFS on state vector r decreasing to zero by subtracting columns.</span>
    <span class="c1"># But r entries can be up to ~ 254; k up to 10. That&#39;s a lot for naive BFS.</span>
    <span class="c1"># Observe: sum(r) equals lower bound for sum(u)? Each button press increases many counters by 1; to produce total sum of r increments across counters, we need at least ceil(sum(r)/max_ones_per_col). But that&#39;s weak.</span>
    <span class="c1"># Better: This is an uncapacitated set cover counted with multiplicity. Solve via min-cost flow: build bipartite expansion per unit? Too big.</span>
    <span class="c1"># Instead, use A* search over u-sum with admissible heuristic: h(state) = max_i ceil(rem_i / deg_i_max) where deg_i_max is number of buttons that touch i? Still weak but admissible.</span>
    <span class="c1"># However inputs are small; we can do Dijkstra in compressed residue space modulo a small bounding box using meet-in-the-middle on columns.</span>

    <span class="c1"># Alternate exact approach: Solve integer LP via nonnegative least 1-norm using DP over columns: For each column j, we can add it any number times; but targets up to 127 typically; branching large.</span>

    <span class="c1"># We&#39;ll instead compute a minimum-cost solution using integer nonnegative least squares with simplex via dynamic programming on total cost bound.</span>

    <span class="c1"># Practical trick: since k&lt;=10 and m&lt;=13, we can compute shortest path in a layered graph over residues modulo small M per dimension, augmented with sum to enforce exact equality.</span>
    <span class="c1"># Choose modulus M as the lcm of 1,2,... maybe 1; but parity already handled, so 2 factors; residues mod 2 vanish. Use modulus 1 -&gt; trivial.</span>

    <span class="c1"># We&#39;ll use greedy + improvement via local search that is exact due to unimodularity? Not guaranteed.</span>

    <span class="c1"># Wait: matrix A is totally unimodular (0/1 columns), but not necessarily; columns overlap, but TU requires network matrices, not generally true.</span>

    <span class="c1"># Given constraints, we can use integer linear programming with branch-and-bound over x_j, bounded by max(targets).</span>

    <span class="c1"># We&#39;ll do best-first search on u with heuristic h = ceil(max_i rem_i / deg_i_j_best) using a priority queue; limit branching by picking a column index j and deciding how many times to press at most need_j = min_i rem_i if col covers that i.</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">heapq</span>

    <span class="c1"># Precompute coverage lists</span>
    <span class="n">cover</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="p">]</span>
    <span class="c1"># Order columns by coverage (more coverage first)</span>
    <span class="n">order_cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">cover</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">cover</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>

    <span class="c1"># initial residual r</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="c1"># admissible heuristic: h(r) &gt;= max_i ceil(r[i] / max_cover_i), where max_cover_i = number of columns covering i</span>
    <span class="n">max_cover_i</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">heuristic</span><span class="p">(</span><span class="n">rem</span><span class="p">):</span>
        <span class="n">h</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">max_cover_i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c1"># each press can contribute at most 1 to rem[i]</span>
            <span class="n">h</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="n">start_h</span> <span class="o">=</span> <span class="n">heuristic</span><span class="p">(</span><span class="n">r0</span><span class="p">)</span>
    <span class="n">pq</span> <span class="o">=</span> <span class="p">[(</span><span class="n">start_h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">r0</span><span class="p">)]</span>  <span class="c1"># (f=g+h, g, residual)</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="n">r0</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="k">while</span> <span class="n">pq</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rem</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">pq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rem</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span><span class="p">):</span>
            <span class="n">presses_u</span> <span class="o">=</span> <span class="n">g</span>
            <span class="k">return</span> <span class="n">x_par</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">presses_u</span>
        <span class="k">if</span> <span class="n">g</span> <span class="o">&gt;</span> <span class="n">seen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="mi">18</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># choose a counter i with largest rem</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">rem</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># skip zeros by recomputing</span>
            <span class="k">continue</span>
        <span class="c1"># Try pressing any column that covers i</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">order_cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># we can press multiple times; but branching many times is heavy. We&#39;ll try one step and rely on heuristic to repeat.</span>
            <span class="n">new</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">cover</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">new</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">new</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">newt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
            <span class="n">ng</span> <span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">ng</span> <span class="o">&lt;</span> <span class="n">seen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">newt</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="mi">18</span><span class="p">):</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">heuristic</span><span class="p">(</span><span class="n">newt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">h</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">seen</span><span class="p">[</span><span class="n">newt</span><span class="p">]</span> <span class="o">=</span> <span class="n">ng</span>
                <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">pq</span><span class="p">,</span> <span class="p">(</span><span class="n">ng</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">newt</span><span class="p">))</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Search failed&#39;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">presses</span> <span class="o">=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">presses</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_lppy"> solve_day10_part2_lp.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:29:11.660111</li>
<li><strong>Duration</strong>: 0.21s</li>
<li><strong>Exit Code</strong>: 1</li>
<li><strong>Error</strong>: Non-zero exit code</li>
</ul>
<h3 id="stderr">Stderr</h3>
<div class="highlight"><pre><span></span><code>Traceback (most recent call last):
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_09-09-09_2025_10_python_gpt-5_949554a9\solve_day10_part2_lp.py&quot;, line 112, in &lt;module&gt;
    main()
    ~~~~^^
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_09-09-09_2025_10_python_gpt-5_949554a9\solve_day10_part2_lp.py&quot;, line 108, in main
    total += solve_machine(targets, A)
             ~~~~~~~~~~~~~^^^^^^^^^^^^
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_09-09-09_2025_10_python_gpt-5_949554a9\solve_day10_part2_lp.py&quot;, line 95, in solve_machine
    raise ValueError(&#39;No feasible LP basis found&#39;)
ValueError: No feasible LP basis found
</code></pre></div>
<h3 id="code_8">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">btn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">A</span>


<span class="k">def</span><span class="w"> </span><span class="nf">gauss_solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="c1"># Solve Ax = b with A square (n x n) using Gaussian elimination with partial pivoting (floats)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="c1"># Make copies</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="p">[:]</span>
    <span class="c1"># Forward elimination</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="c1"># find pivot</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">piv_val</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">piv_val</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">r</span>
                <span class="n">piv_val</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">if</span> <span class="n">piv_val</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># singular</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># normalize row</span>
        <span class="n">div</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">div</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv</span>
        <span class="c1"># eliminate below</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="c1"># Back substitution</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">-=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>  <span class="c1"># M[i][i] is 1</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">k</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c1"># enumerate bases of size k</span>
    <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_sum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="n">cols_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="c1"># Pretranspose columns for speed? We&#39;ll directly construct A_B as kxk matrix of selected columns</span>
    <span class="k">for</span> <span class="n">B</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">cols_indices</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
        <span class="c1"># build A_B</span>
        <span class="n">AB</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">B</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
        <span class="n">xB</span> <span class="o">=</span> <span class="n">gauss_solve</span><span class="p">(</span><span class="n">AB</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">xB</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># check nonnegativity</span>
        <span class="n">feas</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">xB</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e-9</span><span class="p">:</span>
                <span class="n">feas</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="n">tot</span> <span class="o">+=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">feas</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># check exactly equals: AB xB approx targets already; Accept</span>
        <span class="k">if</span> <span class="n">tot</span> <span class="o">&lt;</span> <span class="n">best_sum</span> <span class="o">-</span> <span class="mf">1e-9</span><span class="p">:</span>
            <span class="n">best_sum</span> <span class="o">=</span> <span class="n">tot</span>
            <span class="n">best</span> <span class="o">=</span> <span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">xB</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># If no feasible BFS, fall back to A* approach? For now, raise</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No feasible LP basis found&#39;</span><span class="p">)</span>
    <span class="c1"># We assume integer optimum equals LP optimum; round to nearest int</span>
    <span class="c1"># Because objective is sum, and true answer must be integer, we&#39;ll round best_sum to nearest integer</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">best_sum</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_lp2py"> solve_day10_part2_lp2.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:30:48.591287</li>
<li><strong>Duration</strong>: 0.31s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout_2">Stdout</h3>
<div class="highlight"><pre><span></span><code>15611
</code></pre></div>
<h3 id="code_9">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">btn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">A</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">A</span>


<span class="k">def</span><span class="w"> </span><span class="nf">independent_rows</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="c1"># Return list of independent row indices using Gaussian elimination (float) with partial pivoting</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="n">piv_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="c1"># find pivot row &gt;= r with |M[row][c]| &gt; eps</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">piv_val</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">piv_val</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="n">piv_val</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">piv_val</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># swap row r and piv</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="c1"># normalize pivot row to 1</span>
        <span class="n">div</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">div</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv</span>
        <span class="c1"># eliminate in other rows below to get row echelon (not full RREF)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-12</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">piv_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">indep_rows</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[:</span><span class="n">r</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">indep_rows</span>


<span class="k">def</span><span class="w"> </span><span class="nf">gauss_solve_square</span><span class="p">(</span><span class="n">AB</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="c1"># Solve AB x = b for square AB (r x r) using Gaussian elimination with partial pivoting</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">AB</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">AB</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">b</span><span class="p">[:]</span>
    <span class="c1"># forward</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">piv_val</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">piv_val</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">t</span>
                <span class="n">piv_val</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">if</span> <span class="n">piv_val</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv</span>
        <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1e-12</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
                <span class="n">y</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="c1"># back-substitute</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">r</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">-=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">A</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">indep</span> <span class="o">=</span> <span class="n">independent_rows</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indep</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">A_red</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indep</span><span class="p">]</span>
    <span class="n">t_red</span> <span class="o">=</span> <span class="p">[</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indep</span><span class="p">]</span>
    <span class="n">best_sum</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">B</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="c1"># build square matrix AB</span>
        <span class="n">AB</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A_red</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">B</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
        <span class="n">xB</span> <span class="o">=</span> <span class="n">gauss_solve_square</span><span class="p">(</span><span class="n">AB</span><span class="p">,</span> <span class="n">t_red</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xB</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># nonnegativity check with tolerance</span>
        <span class="n">feas</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">xB</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e-9</span><span class="p">:</span>
                <span class="n">feas</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">feas</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># compute objective sum</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xB</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tot</span> <span class="o">+</span> <span class="mf">1e-9</span> <span class="o">&lt;</span> <span class="n">best_sum</span><span class="p">:</span>
            <span class="c1"># verify full constraints approximately</span>
            <span class="c1"># Compute x vector of length m with basics at B as xB and nonbasics 0</span>
            <span class="c1"># Then Ax equals linear combo of columns selected; check equals targets</span>
            <span class="c1"># compute Ax for all k rows</span>
            <span class="n">Ax</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span>
            <span class="k">for</span> <span class="n">j_idx</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
                <span class="n">coef</span> <span class="o">=</span> <span class="n">xB</span><span class="p">[</span><span class="n">j_idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">coef</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-12</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">Aj</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                    <span class="n">Ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Aj</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">coef</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">best_sum</span> <span class="o">=</span> <span class="n">tot</span>
    <span class="k">if</span> <span class="n">best_sum</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;LP has no feasible BFS (infeasible or numeric issues)&#39;</span><span class="p">)</span>
    <span class="c1"># The true optimal must be integer; round to nearest integer</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">best_sum</span><span class="p">))</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_exactpy"> solve_day10_part2_exact.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:34:19.856776</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_10">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># deduplicate columns</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">.</span><span class="n">bit_count</span><span class="p">(),</span> <span class="n">m</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span>


<span class="k">def</span><span class="w"> </span><span class="nf">precompute_bounds</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
    <span class="n">full</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span>
    <span class="c1"># cap_T[T] = max over j of popcount(cols[j] &amp; T)</span>
    <span class="n">cap_T</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
    <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="n">cap</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">cap</span><span class="p">:</span>
                <span class="n">cap</span> <span class="o">=</span> <span class="n">c</span>
                <span class="k">if</span> <span class="n">cap</span> <span class="o">==</span> <span class="nb">bin</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">):</span>
                    <span class="k">break</span>
        <span class="n">cap_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="n">cap</span>
    <span class="c1"># For each column j, contrib_j[T] = popcount(cols[j] &amp; T)</span>
    <span class="n">contrib</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
        <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
        <span class="n">contrib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="c1"># For fast allowed check, store indices list per column</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cap_T</span><span class="p">,</span> <span class="n">contrib</span><span class="p">,</span> <span class="n">idxs</span>


<span class="k">def</span><span class="w"> </span><span class="nf">lower_bound_from_sums</span><span class="p">(</span><span class="n">sums_T</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cap_T</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sums_T</span><span class="p">)):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">cap</span> <span class="o">=</span> <span class="n">cap_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>  <span class="c1"># infeasible</span>
        <span class="c1"># ceil(s / cap)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">cap</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">cap</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No buttons but nonzero targets&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">cap_T</span><span class="p">,</span> <span class="n">contrib</span><span class="p">,</span> <span class="n">idxs</span> <span class="o">=</span> <span class="n">precompute_bounds</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">full</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span>
    <span class="c1"># initial sums_T</span>
    <span class="n">sums_T</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
    <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">T</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
    <span class="c1"># quick infeasibility check</span>
    <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cap_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible: some counters cannot be increased by any button&#39;</span><span class="p">)</span>
    <span class="c1"># pos_mask and rem</span>
    <span class="n">rem</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:]</span>
    <span class="n">pos_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rem</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pos_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>

    <span class="c1"># Order columns by descending size to try larger coverage first</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="n">order</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>

    <span class="c1"># Precompute allowed check uses bit operations</span>

    <span class="c1"># IDA* search</span>
    <span class="n">bound</span> <span class="o">=</span> <span class="n">lower_bound_from_sums</span><span class="p">(</span><span class="n">sums_T</span><span class="p">,</span> <span class="n">cap_T</span><span class="p">)</span>
    <span class="c1"># Additional simple bounds</span>
    <span class="n">s_all</span> <span class="o">=</span> <span class="n">sums_T</span><span class="p">[</span><span class="n">full</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">smax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">c</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">bound</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bound</span><span class="p">,</span> <span class="p">(</span><span class="n">s_all</span> <span class="o">+</span> <span class="n">smax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">smax</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">rem</span><span class="p">))</span>

    <span class="n">target_zero</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span><span class="p">)</span>

    <span class="c1"># Memoization of visited states best g (depth)</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">choose_pivot</span><span class="p">(</span><span class="n">rem_list</span><span class="p">,</span> <span class="n">pos_m</span><span class="p">):</span>
        <span class="c1"># choose counter with largest residual; break ties by smaller index</span>
        <span class="n">best_i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_v</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="n">pos_m</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">pm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pm</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">rem_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best_v</span><span class="p">:</span>
                    <span class="n">best_v</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">best_i</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">pm</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">best_i</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">heuristic</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">lower_bound_from_sums</span><span class="p">(</span><span class="n">sums_T</span><span class="p">,</span> <span class="n">cap_T</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">bound_local</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># f = g + h</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">heuristic</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="n">h</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">bound_local</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">if</span> <span class="n">pos_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># found</span>
        <span class="c1"># memo prune</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev</span> <span class="o">&lt;=</span> <span class="n">g</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="n">seen</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
        <span class="c1"># choose pivot counter with largest rem</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">choose_pivot</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="n">pos_mask</span><span class="p">)</span>
        <span class="c1"># build candidate buttons covering i and allowed</span>
        <span class="n">best_next</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="c1"># Precompute current allowed mask: any button j must have its mask subset of pos_mask</span>
        <span class="n">allowed_mask</span> <span class="o">=</span> <span class="n">pos_mask</span>
        <span class="c1"># Build candidate list in good order: larger coverage within current pos</span>
        <span class="n">cand</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">msk</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">msk</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">msk</span> <span class="o">&amp;</span> <span class="n">allowed_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msk</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># coverage count within pos</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="p">(</span><span class="n">msk</span> <span class="o">&amp;</span> <span class="n">allowed_mask</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
            <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">((</span> <span class="o">-</span><span class="n">cov</span><span class="p">,</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">j</span><span class="p">))</span>
        <span class="n">cand</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cand</span><span class="p">:</span>
            <span class="c1"># apply move j</span>
            <span class="n">msk</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="c1"># update rem and pos_mask and sums_T</span>
            <span class="c1"># save changed indices to restore</span>
            <span class="n">changed_idx</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># clear bit from pos_mask</span>
                    <span class="n">nonlocal_pos_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ii</span><span class="p">)</span>
                <span class="n">changed_idx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="c1"># update sums_T by subtracting contrib[j][T]</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">contrib</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
                <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">-=</span> <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bound_local</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">best_next</span><span class="p">:</span>
                <span class="n">best_next</span> <span class="o">=</span> <span class="n">t</span>
            <span class="c1"># restore sums_T</span>
            <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
                <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">+=</span> <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
            <span class="c1"># restore rem and pos_mask</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">changed_idx</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nonlocal_pos_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ii</span><span class="p">)</span>  <span class="c1"># will be incremented next line; but careful logic: we decremented, so to restore we increment; if zero now, will become 1</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">best_next</span>

    <span class="c1"># To allow modifying pos_mask inside nested scope, wrap in list</span>
    <span class="n">nonlocal_pos_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos_mask</span><span class="p">]</span>

    <span class="c1"># Monkey-patch pos_mask accesses inside dfs and choose_pivot via closure variables is tricky.</span>
    <span class="c1"># We&#39;ll adjust functions to refer to nonlocal_pos_mask[0]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">choose_pivot_cl</span><span class="p">():</span>
        <span class="n">best_i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_v</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="n">nonlocal_pos_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">pm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pm</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best_v</span><span class="p">:</span>
                    <span class="n">best_v</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">best_i</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">pm</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">best_i</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dfs2</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">bound_local</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">heuristic</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="n">h</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">bound_local</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">if</span> <span class="n">nonlocal_pos_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev</span> <span class="o">&lt;=</span> <span class="n">g</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="n">seen</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">choose_pivot_cl</span><span class="p">()</span>
        <span class="n">best_next</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="n">allowed_mask</span> <span class="o">=</span> <span class="n">nonlocal_pos_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cand</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">msk</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">msk</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">msk</span> <span class="o">&amp;</span> <span class="n">allowed_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msk</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="p">(</span><span class="n">msk</span> <span class="o">&amp;</span> <span class="n">allowed_mask</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
            <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">cov</span><span class="p">,</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">j</span><span class="p">))</span>
        <span class="n">cand</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">__</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cand</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">contrib</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="c1"># apply</span>
            <span class="n">changed_zero</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">changed_zero</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ii</span><span class="p">)</span>
            <span class="n">nonlocal_pos_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">changed_zero</span>
            <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
                <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">-=</span> <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">dfs2</span><span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bound_local</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">best_next</span><span class="p">:</span>
                <span class="n">best_next</span> <span class="o">=</span> <span class="n">t</span>
            <span class="c1"># undo</span>
            <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
                <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">+=</span> <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
            <span class="n">nonlocal_pos_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">changed_zero</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">best_next</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">dfs2</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bound</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bound</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">8</span><span class="p">:</span>
            <span class="c1"># give up</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Search exploded&#39;</span><span class="p">)</span>
        <span class="n">bound</span> <span class="o">=</span> <span class="n">res</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_idapy"> solve_day10_part2_ida.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:35:17.281172</li>
<li><strong>Duration</strong>: 6.87s</li>
<li><strong>Exit Code</strong>: 1</li>
<li><strong>Error</strong>: Non-zero exit code</li>
</ul>
<h3 id="stderr_1">Stderr</h3>
<div class="highlight"><pre><span></span><code>Traceback (most recent call last):
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_09-09-09_2025_10_python_gpt-5_949554a9\solve_day10_part2_ida.py&quot;, line 205, in &lt;module&gt;
    main()
    ~~~~^^
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_09-09-09_2025_10_python_gpt-5_949554a9\solve_day10_part2_ida.py&quot;, line 201, in main
    total += solve_machine(targets, cols)
             ~~~~~~~~~~~~~^^^^^^^^^^^^^^^
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_09-09-09_2025_10_python_gpt-5_949554a9\solve_day10_part2_ida.py&quot;, line 186, in solve_machine
    res = dfs(0, b)
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_09-09-09_2025_10_python_gpt-5_949554a9\solve_day10_part2_ida.py&quot;, line 170, in dfs
    t = dfs(g + 1, bound)
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_09-09-09_2025_10_python_gpt-5_949554a9\solve_day10_part2_ida.py&quot;, line 170, in dfs
    t = dfs(g + 1, bound)
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_09-09-09_2025_10_python_gpt-5_949554a9\solve_day10_part2_ida.py&quot;, line 170, in dfs
    t = dfs(g + 1, bound)
  [Previous line repeated 46 more times]
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_09-09-09_2025_10_python_gpt-5_949554a9\solve_day10_part2_ida.py&quot;, line 151, in dfs
    if (msk &amp; (1 &lt;&lt; i)) == 0:
               ~~^^~~
ValueError: negative shift count
</code></pre></div>
<h3 id="code_11">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># deduplicate</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">bit_count</span><span class="p">(),</span> <span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span>


<span class="k">def</span><span class="w"> </span><span class="nf">precompute</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
    <span class="n">full</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span>
    <span class="c1"># cap_T[T] = max over columns j of popcount(cols[j] &amp; T)</span>
    <span class="n">cap_T</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
    <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">if</span> <span class="n">best</span> <span class="o">==</span> <span class="nb">bin</span><span class="p">(</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">):</span>
                    <span class="k">break</span>
        <span class="n">cap_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="n">best</span>
    <span class="c1"># contrib[j][T] = popcount(cols[j] &amp; T)</span>
    <span class="n">contrib</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
        <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
        <span class="n">contrib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cap_T</span><span class="p">,</span> <span class="n">contrib</span><span class="p">,</span> <span class="n">idxs</span>


<span class="k">def</span><span class="w"> </span><span class="nf">lower_bound</span><span class="p">(</span><span class="n">sums_T</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cap_T</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Iterate all subsets T; start from larger T to prune? Not necessary.</span>
    <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sums_T</span><span class="p">)):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">cap</span> <span class="o">=</span> <span class="n">cap_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">cap</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">cap</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible (no columns)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">cap_T</span><span class="p">,</span> <span class="n">contrib</span><span class="p">,</span> <span class="n">idxs</span> <span class="o">=</span> <span class="n">precompute</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">full</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span>
    <span class="n">sums_T</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
    <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
    <span class="c1"># infeasible quick check</span>
    <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cap_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible subset&#39;</span><span class="p">)</span>
    <span class="n">rem</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:]</span>
    <span class="n">pos_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rem</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pos_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="c1"># sort columns by decreasing ones</span>
    <span class="n">order</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>

    <span class="c1"># initial bound</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">lower_bound</span><span class="p">(</span><span class="n">sums_T</span><span class="p">,</span> <span class="n">cap_T</span><span class="p">)</span>
    <span class="c1"># also global sum bound</span>
    <span class="n">s_all</span> <span class="o">=</span> <span class="n">sums_T</span><span class="p">[</span><span class="n">full</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">max_cov</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">c</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">s_all</span> <span class="o">+</span> <span class="n">max_cov</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">max_cov</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">rem</span><span class="p">))</span>

    <span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">heuristic</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">lower_bound</span><span class="p">(</span><span class="n">sums_T</span><span class="p">,</span> <span class="n">cap_T</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pick_pivot</span><span class="p">(</span><span class="n">pm</span><span class="p">):</span>
        <span class="c1"># pick index with max rem; ties broken by index</span>
        <span class="k">if</span> <span class="n">pm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_v</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pm</span>
        <span class="k">while</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best_v</span><span class="p">:</span>
                    <span class="n">best_v</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">best_i</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">best_i</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">bound</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">heuristic</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="n">h</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">bound</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">if</span> <span class="n">pos_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev</span> <span class="o">&lt;=</span> <span class="n">g</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="n">seen</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">pick_pivot</span><span class="p">(</span><span class="n">pos_mask</span><span class="p">)</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="n">pos_mask</span>
        <span class="n">cand</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">msk</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">msk</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">msk</span> <span class="o">&amp;</span> <span class="n">allowed</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msk</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="p">(</span><span class="n">msk</span> <span class="o">&amp;</span> <span class="n">allowed</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
            <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">cov</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
        <span class="n">cand</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">best_next</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cand</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">contrib</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="c1"># apply</span>
            <span class="n">changed_zero_mask</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">changed_zero_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ii</span><span class="p">)</span>
            <span class="n">nonlocal_pos_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">changed_zero_mask</span>
            <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
                <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">-=</span> <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bound</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">best_next</span><span class="p">:</span>
                <span class="n">best_next</span> <span class="o">=</span> <span class="n">t</span>
            <span class="c1"># undo</span>
            <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
                <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">+=</span> <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
            <span class="n">nonlocal_pos_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">changed_zero_mask</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">best_next</span>

    <span class="n">nonlocal_pos_mask</span> <span class="o">=</span> <span class="p">[</span><span class="n">pos_mask</span><span class="p">]</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">8</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Search exploded&#39;</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">res</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_idapy_1"> solve_day10_part2_ida.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:37:12.150269</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_12">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># deduplicate</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">bit_count</span><span class="p">(),</span> <span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span>


<span class="k">def</span><span class="w"> </span><span class="nf">precompute</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
    <span class="n">full</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span>
    <span class="c1"># cap_T[T] = max over columns j of popcount(cols[j] &amp; T)</span>
    <span class="n">cap_T</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
    <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">if</span> <span class="n">best</span> <span class="o">==</span> <span class="n">T</span><span class="o">.</span><span class="n">bit_count</span><span class="p">():</span>
                    <span class="k">break</span>
        <span class="n">cap_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="n">best</span>
    <span class="c1"># contrib[j][T] = popcount(cols[j] &amp; T)</span>
    <span class="n">contrib</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
        <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
        <span class="n">contrib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cap_T</span><span class="p">,</span> <span class="n">contrib</span><span class="p">,</span> <span class="n">idxs</span>


<span class="k">def</span><span class="w"> </span><span class="nf">lower_bound</span><span class="p">(</span><span class="n">sums_T</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cap_T</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sums_T</span><span class="p">)):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">cap</span> <span class="o">=</span> <span class="n">cap_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">cap</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">cap</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible (no columns)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">cap_T</span><span class="p">,</span> <span class="n">contrib</span><span class="p">,</span> <span class="n">idxs</span> <span class="o">=</span> <span class="n">precompute</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">full</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span>
    <span class="n">sums_T</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
    <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
    <span class="c1"># infeasible quick check</span>
    <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cap_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible subset&#39;</span><span class="p">)</span>
    <span class="n">rem</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:]</span>
    <span class="n">pos_mask_box</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rem</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="c1"># sort columns by decreasing ones</span>
    <span class="n">order</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>

    <span class="c1"># initial bound</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">lower_bound</span><span class="p">(</span><span class="n">sums_T</span><span class="p">,</span> <span class="n">cap_T</span><span class="p">)</span>
    <span class="c1"># also global sum bound</span>
    <span class="n">s_all</span> <span class="o">=</span> <span class="n">sums_T</span><span class="p">[</span><span class="n">full</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">max_cov</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">c</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">))</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">s_all</span> <span class="o">+</span> <span class="n">max_cov</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">max_cov</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">rem</span><span class="p">))</span>

    <span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">heuristic</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">lower_bound</span><span class="p">(</span><span class="n">sums_T</span><span class="p">,</span> <span class="n">cap_T</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pick_pivot</span><span class="p">(</span><span class="n">pm</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_v</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pm</span>
        <span class="k">while</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best_v</span><span class="p">:</span>
                    <span class="n">best_v</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">best_i</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">best_i</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">bound</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">heuristic</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="n">h</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">bound</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">if</span> <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev</span> <span class="o">&lt;=</span> <span class="n">g</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="n">seen</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">pick_pivot</span><span class="p">(</span><span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cand</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="n">msk</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">msk</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">msk</span> <span class="o">&amp;</span> <span class="n">allowed</span><span class="p">)</span> <span class="o">!=</span> <span class="n">msk</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="p">(</span><span class="n">msk</span> <span class="o">&amp;</span> <span class="n">allowed</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
            <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">cov</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
        <span class="n">cand</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">best_next</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cand</span><span class="p">:</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">contrib</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="c1"># apply</span>
            <span class="n">changed_zero_mask</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">changed_zero_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ii</span><span class="p">)</span>
            <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">changed_zero_mask</span>
            <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
                <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">-=</span> <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bound</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">best_next</span><span class="p">:</span>
                <span class="n">best_next</span> <span class="o">=</span> <span class="n">t</span>
            <span class="c1"># undo</span>
            <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
                <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">+=</span> <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
            <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">changed_zero_mask</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">best_next</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">b</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">8</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Search exploded&#39;</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">res</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="analyze_inputpy"> analyze_input.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:37:47.869318</li>
<li><strong>Duration</strong>: 0.14s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout_3">Stdout</h3>
<div class="highlight"><pre><span></span><code>machines 157
max k 10
max m 13
max max_t 254
max sum_t 1604
avg sum_t 388.5222929936306
</code></pre></div>
<h3 id="code_13">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">mcols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">k</span><span class="p">,</span> <span class="n">mcols</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">[</span><span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;machines&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;max k&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;max m&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">m</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;max max_t&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">mx</span> <span class="k">for</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">mx</span><span class="p">,</span> <span class="n">__</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;max sum_t&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;avg sum_t&#39;</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">s</span> <span class="k">for</span> <span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">stats</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">stats</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_fastpy"> solve_day10_part2_fast.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:39:05.292084</li>
<li><strong>Duration</strong>: 0.32s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout_4">Stdout</h3>
<div class="highlight"><pre><span></span><code>15260
</code></pre></div>
<h3 id="code_14">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># deduplicate identical columns (pressing either is equivalent)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">bit_count</span><span class="p">(),</span> <span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span>


<span class="k">def</span><span class="w"> </span><span class="nf">greedy_upper_bound</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">rem</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:]</span>
    <span class="n">pos_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rem</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pos_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pos_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">coverers</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="n">m</span>
        <span class="k">while</span> <span class="n">mm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mm</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">coverers</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">mm</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="c1"># At each step choose pivot i with largest rem, then pick column covering most remaining counters</span>
    <span class="n">presses</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">pos_mask</span><span class="p">:</span>
        <span class="c1"># pick pivot i</span>
        <span class="n">best_i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_v</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pos_mask</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best_v</span><span class="p">:</span>
                    <span class="n">best_v</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">best_i</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># pick best column covering i</span>
        <span class="n">best_j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_cov</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">coverers</span><span class="p">[</span><span class="n">best_i</span><span class="p">]:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">pos_mask</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cov</span> <span class="o">&gt;</span> <span class="n">best_cov</span><span class="p">:</span>
                <span class="n">best_cov</span> <span class="o">=</span> <span class="n">cov</span>
                <span class="n">best_j</span> <span class="o">=</span> <span class="n">j</span>
        <span class="c1"># apply once</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">best_j</span><span class="p">]</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="n">m</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">changed_zero_mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">mm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mm</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">changed_zero_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ii</span><span class="p">)</span>
            <span class="n">mm</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">pos_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">changed_zero_mask</span>
        <span class="n">presses</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">presses</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">:</span>
        <span class="c1"># infeasible if any target nonzero</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible machine: no buttons but positive targets&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Precompute helper structures</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
    <span class="n">max_w</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span> <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">coverers</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
            <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="c1"># Quick infeasibility: if some counter i has no covering column but target&gt;0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible: uncovered counter&#39;</span><span class="p">)</span>

    <span class="n">rem</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:]</span>
    <span class="n">pos_mask_box</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rem</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>

    <span class="n">sum_rem_box</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">rem</span><span class="p">)]</span>

    <span class="c1"># initial bound via greedy UB</span>
    <span class="n">bound</span> <span class="o">=</span> <span class="n">greedy_upper_bound</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>

    <span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">heuristic</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># max of (max rem[i], ceil(sum_rem / max_w))</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># max rem</span>
        <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pm</span>
        <span class="k">while</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
                    <span class="n">best</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># sum bound</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">sum_rem_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">max_w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">max_w</span>
            <span class="k">if</span> <span class="n">b2</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">b2</span>
        <span class="k">return</span> <span class="n">best</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pick_pivot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">best_i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_v</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pm</span>
        <span class="k">while</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best_v</span><span class="p">:</span>
                    <span class="n">best_v</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">best_i</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">best_i</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">g</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">heuristic</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="n">h</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">limit</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">if</span> <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">rem</span><span class="p">))</span>
        <span class="n">best_g</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">best_g</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">best_g</span> <span class="o">&lt;=</span> <span class="n">g</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="n">seen</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">pick_pivot</span><span class="p">()</span>
        <span class="c1"># Build candidate columns covering i, sorted by coverage on remaining</span>
        <span class="n">allowed</span> <span class="o">=</span> <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cand</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">msk</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">msk</span> <span class="o">&amp;</span> <span class="n">allowed</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># must cover something remaining; always true because covers i</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="p">(</span><span class="n">msk</span> <span class="o">&amp;</span> <span class="n">allowed</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
                <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">cov</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
        <span class="n">cand</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">best_next</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cand</span><span class="p">:</span>
            <span class="c1"># apply move j once</span>
            <span class="n">changed_zero_mask</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">changed_zero_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ii</span><span class="p">)</span>
            <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">changed_zero_mask</span>
            <span class="n">sum_rem_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>
            <span class="c1"># undo</span>
            <span class="n">sum_rem_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">changed_zero_mask</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">best_next</span><span class="p">:</span>
                <span class="n">best_next</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">return</span> <span class="n">best_next</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">seen</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bound</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bound</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">8</span><span class="p">:</span>
            <span class="c1"># fallback: return greedy bound</span>
            <span class="k">return</span> <span class="n">bound</span>
        <span class="n">bound</span> <span class="o">=</span> <span class="n">res</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_astar2py"> solve_day10_part2_astar2.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:41:52.307075</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_15">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">heapq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># deduplicate identical columns</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">bit_count</span><span class="p">(),</span> <span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible: no columns but positive target&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">coverers</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="c1"># feasibility: any target i with no coverers -&gt; infeasible</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible row: uncovered&#39;</span><span class="p">)</span>
    <span class="n">max_cov</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    <span class="c1"># pair capacities</span>
    <span class="n">pair_cap</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                <span class="n">pair_cap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># singletons cap</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cap</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="n">cap</span><span class="p">:</span>
                        <span class="n">cap</span> <span class="o">=</span> <span class="n">c</span>
                        <span class="k">if</span> <span class="n">cap</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="n">pair_cap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">cap</span>
    <span class="c1"># heuristic function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">heuristic</span><span class="p">(</span><span class="n">rem</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># singles</span>
        <span class="n">maxr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">srem</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rem</span><span class="p">:</span>
            <span class="n">srem</span> <span class="o">+=</span> <span class="n">v</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">maxr</span><span class="p">:</span>
                <span class="n">maxr</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">maxr</span>
        <span class="c1"># all rows</span>
        <span class="k">if</span> <span class="n">srem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="p">(</span><span class="n">srem</span> <span class="o">+</span> <span class="n">max_cov</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">max_cov</span>
            <span class="k">if</span> <span class="n">b2</span> <span class="o">&gt;</span> <span class="n">h</span><span class="p">:</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">b2</span>
        <span class="c1"># pairs</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">vi</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">vi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                <span class="n">vj</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">vj</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">cap</span> <span class="o">=</span> <span class="n">pair_cap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">cap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
                <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">vi</span> <span class="o">+</span> <span class="n">vj</span> <span class="o">+</span> <span class="n">cap</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">cap</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">h</span><span class="p">:</span>
                    <span class="n">h</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">h</span>

    <span class="n">start</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">start</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># PQ entries: (f, g, rem_tuple)</span>
    <span class="n">pq</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">g0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">h0</span> <span class="o">=</span> <span class="n">heuristic</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">pq</span><span class="p">,</span> <span class="p">(</span><span class="n">g0</span> <span class="o">+</span> <span class="n">h0</span><span class="p">,</span> <span class="n">g0</span><span class="p">,</span> <span class="n">start</span><span class="p">))</span>
    <span class="n">best_g</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="k">while</span> <span class="n">pq</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rem</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">pq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">best_g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="mi">18</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">g</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rem</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span>
        <span class="c1"># generate moves</span>
        <span class="c1"># pick pivot i with largest rem to reduce branching maybe; but we&#39;ll try all allowed buttons</span>
        <span class="c1"># Allowed button: all indices in its cover must have rem&gt;0</span>
        <span class="n">rem_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">rem_list</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># apply one press</span>
            <span class="n">child</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rem_list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">child</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">child_t</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="n">ng</span> <span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">best_g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">child_t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ng</span> <span class="o">&lt;</span> <span class="n">old</span><span class="p">:</span>
                <span class="n">best_g</span><span class="p">[</span><span class="n">child_t</span><span class="p">]</span> <span class="o">=</span> <span class="n">ng</span>
                <span class="n">hh</span> <span class="o">=</span> <span class="n">heuristic</span><span class="p">(</span><span class="n">child_t</span><span class="p">)</span>
                <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">pq</span><span class="p">,</span> <span class="p">(</span><span class="n">ng</span> <span class="o">+</span> <span class="n">hh</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">child_t</span><span class="p">))</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Search failed&#39;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_ilppy"> solve_day10_part2_ilp.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:45:23.326155</li>
<li><strong>Duration</strong>: 0.32s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout_5">Stdout</h3>
<div class="highlight"><pre><span></span><code>14359
</code></pre></div>
<h3 id="code_16">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="n">EPS</span> <span class="o">=</span> <span class="mf">1e-9</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Simplex</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="n">b</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">var_cost</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
        <span class="c1"># problem: maximize c^T x subject to A x = b, x &gt;= 0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>  <span class="c1"># rows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">var_cost</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>  <span class="c1"># m x n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">var_cost</span><span class="p">[:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">))</span>  <span class="c1"># indices of basic variables; will adjust in Phase I</span>
        <span class="c1"># We&#39;ll build tableau including artificial variables for Phase I</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">build_phase1</span><span class="p">(</span><span class="n">A</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="n">b</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="c1"># Extend with artificial variables I_m</span>
        <span class="n">T</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">m</span> <span class="o">+</span> <span class="p">[</span><span class="n">bi</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">bi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)]</span>  <span class="c1"># m rows</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">n</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="c1"># Objective row for maximize with c&#39; = [-0 for original, -1 for artificial]</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]</span><span class="o">*</span><span class="n">m</span>
        <span class="c1"># Set to reduced costs r = c - sum_i c_B[i] * row_i; c_B = -1 for artificials</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">m</span><span class="p">):</span>
            <span class="n">obj</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">obj</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>  <span class="c1"># -1.0</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">EPS</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">obj</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">basic</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">T</span><span class="p">,</span> <span class="n">basic</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pivot</span><span class="p">(</span><span class="n">T</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="n">basic</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">enter_col</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">leave_row</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basic</span><span class="p">)</span>
        <span class="n">n_all</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">leave_row</span><span class="p">][</span><span class="n">enter_col</span><span class="p">]</span>
        <span class="c1"># Normalize pivot row</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">piv</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">leave_row</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_all</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv</span>
        <span class="c1"># Eliminate other rows</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">leave_row</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">enter_col</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">EPS</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_all</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">r</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># Eliminate objective row (last row in T)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="n">enter_col</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">EPS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_all</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">obj</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">basic</span><span class="p">[</span><span class="n">leave_row</span><span class="p">]</span> <span class="o">=</span> <span class="n">enter_col</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">choose_entering</span><span class="p">(</span><span class="n">obj_row</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># choose column with positive reduced cost (maximize)</span>
        <span class="n">n_all</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_row</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">best_col</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_val</span> <span class="o">=</span> <span class="n">EPS</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_all</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">obj_row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best_val</span> <span class="o">+</span> <span class="mf">0.0</span><span class="p">:</span>  <span class="c1"># strictly &gt; EPS</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best_val</span> <span class="o">+</span> <span class="mf">1e-12</span><span class="p">:</span>
                    <span class="n">best_val</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">best_col</span> <span class="o">=</span> <span class="n">j</span>
        <span class="k">return</span> <span class="n">best_col</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">choose_leaving</span><span class="p">(</span><span class="n">T</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">best_row</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">EPS</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">a</span>
                <span class="k">if</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="n">best_ratio</span> <span class="o">-</span> <span class="mf">1e-12</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ratio</span> <span class="o">-</span> <span class="n">best_ratio</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-12</span> <span class="ow">and</span> <span class="p">(</span><span class="n">best_row</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">best_row</span><span class="p">)):</span>
                    <span class="n">best_ratio</span> <span class="o">=</span> <span class="n">ratio</span>
                    <span class="n">best_row</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">best_row</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_solution</span><span class="p">(</span><span class="n">T</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="n">basic</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">n_vars</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="c1"># n_vars = number of original variables in current tableau (not including artificials)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_vars</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">basic</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">var</span> <span class="o">&lt;</span> <span class="n">n_vars</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="n">b</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">c_obj</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="c1"># maximize c_obj^T x with A x = b, x&gt;=0</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">c_obj</span><span class="p">)</span>
        <span class="c1"># Build Phase I tableau</span>
        <span class="n">T</span><span class="p">,</span> <span class="n">basic</span> <span class="o">=</span> <span class="n">Simplex</span><span class="o">.</span><span class="n">build_phase1</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
        <span class="c1"># append objective row to tableau</span>
        <span class="n">T</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">])</span>
        <span class="c1"># Run Phase I simplex</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">enter</span> <span class="o">=</span> <span class="n">Simplex</span><span class="o">.</span><span class="n">choose_entering</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">enter</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">leave</span> <span class="o">=</span> <span class="n">Simplex</span><span class="o">.</span><span class="n">choose_leaving</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">enter</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">leave</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># unbounded</span>
                <span class="k">return</span> <span class="s1">&#39;unbounded&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="n">Simplex</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">basic</span><span class="p">,</span> <span class="n">enter</span><span class="p">,</span> <span class="n">leave</span><span class="p">)</span>
        <span class="c1"># Check feasibility: objective value should be zero (since maximizing -sum y)</span>
        <span class="c1"># We can compute sum of artificial variables as -obj_rhs</span>
        <span class="n">obj_rhs</span> <span class="o">=</span> <span class="n">T</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">obj_rhs</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">1e-6</span> <span class="ow">or</span> <span class="n">obj_rhs</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
            <span class="c1"># Not zero -&gt; infeasible</span>
            <span class="k">return</span> <span class="s1">&#39;infeasible&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="mf">0.0</span>
        <span class="c1"># Remove artificial variables from basis and tableau</span>
        <span class="c1"># If artificial var is basic, try to pivot it out. If not possible (row all zeros except artificial), drop the row.</span>
        <span class="n">n_all</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">m</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">basic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">var</span> <span class="o">&gt;=</span> <span class="n">n</span><span class="p">:</span>
                <span class="c1"># try to find entering non-artificial column with nonzero coefficient</span>
                <span class="n">enter_col</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">EPS</span><span class="p">:</span>
                        <span class="n">enter_col</span> <span class="o">=</span> <span class="n">j</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">enter_col</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># drop row i: remove from tableau and basic</span>
                    <span class="n">T</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">basic</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">m</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">continue</span>  <span class="c1"># do not increment i</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Simplex</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">basic</span><span class="p">,</span> <span class="n">enter_col</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                    <span class="c1"># Now basic[i] becomes enter_col (&lt; n)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Remove artificial columns from tableau</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">T</span><span class="p">:</span>
            <span class="c1"># Keep first n columns (original vars); drop artificial columns</span>
            <span class="k">del</span> <span class="n">row</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="n">n_all</span><span class="p">]</span>
        <span class="c1"># Now set Phase II objective c_obj and compute reduced costs row from scratch</span>
        <span class="c1"># Rebuild objective row as c - sum_i c_B * row_i</span>
        <span class="c1"># Replace last row with zeros then add c then subtract for basic rows</span>
        <span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">c_obj</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">basic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">c_obj</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">EPS</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># Phase II simplex</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">enter</span> <span class="o">=</span> <span class="n">Simplex</span><span class="o">.</span><span class="n">choose_entering</span><span class="p">(</span><span class="n">T</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">enter</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">leave</span> <span class="o">=</span> <span class="n">Simplex</span><span class="o">.</span><span class="n">choose_leaving</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">enter</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">leave</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;unbounded&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="n">Simplex</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">basic</span><span class="p">,</span> <span class="n">enter</span><span class="p">,</span> <span class="n">leave</span><span class="p">)</span>
        <span class="c1"># Return optimal solution</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">Simplex</span><span class="o">.</span><span class="n">current_solution</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">basic</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="c1"># objective value c^T x</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">c_obj</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">obj</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="c1"># remove zero columns</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># dedup columns</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">))</span>
    <span class="c1"># Build A matrix k x m with 0/1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">A</span>


<span class="k">def</span><span class="w"> </span><span class="nf">greedy_upper_bound</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">A</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">k</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">rem</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:]</span>
    <span class="n">coverers</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="c1"># infeasible quick check</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">presses</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">pos</span><span class="p">:</span>
        <span class="c1"># pick i with largest rem</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">rem</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
        <span class="c1"># choose column that covers i and maximizes coverage over pos</span>
        <span class="n">best_j</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_cov</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">pos</span> <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cov</span> <span class="o">&gt;</span> <span class="n">best_cov</span><span class="p">:</span>
                <span class="n">best_cov</span> <span class="o">=</span> <span class="n">cov</span>
                <span class="n">best_j</span> <span class="o">=</span> <span class="n">j</span>
        <span class="c1"># apply once</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">best_j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="n">pos</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="n">presses</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">presses</span>


<span class="k">def</span><span class="w"> </span><span class="nf">branch_and_bound_ilp</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">A</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">A</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1"># initial upper bound via greedy</span>
    <span class="n">ub</span> <span class="o">=</span> <span class="n">greedy_upper_bound</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="c1"># LP relaxation</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">solve_lp_with_bounds</span><span class="p">(</span><span class="n">bounds_leq</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">bounds_geq</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]):</span>
        <span class="c1"># Build augmented Aeq and beq with additional bounds as equalities</span>
        <span class="n">Aeq</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
        <span class="n">beq</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:]</span>
        <span class="c1"># Additional rows</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">U</span> <span class="ow">in</span> <span class="n">bounds_leq</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">m</span>
            <span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">Aeq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">beq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">L</span> <span class="ow">in</span> <span class="n">bounds_geq</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">m</span>
            <span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
            <span class="n">Aeq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
            <span class="n">beq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">L</span><span class="p">)</span>
        <span class="c1"># costs for maximize: c_j = -1 for original variables</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]</span><span class="o">*</span><span class="n">m</span>
        <span class="n">simp</span> <span class="o">=</span> <span class="n">Simplex</span><span class="p">(</span><span class="n">Aeq</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">beq</span><span class="p">],</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">simp</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">Aeq</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">beq</span><span class="p">],</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;infeasible&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">obj</span><span class="p">)</span>  <span class="c1"># return x, LP_min_value</span>

    <span class="n">best</span> <span class="o">=</span> <span class="n">ub</span>

    <span class="c1"># Node stack: (bounds_leq, bounds_geq)</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="p">[([],</span> <span class="p">[])]</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
        <span class="n">bounds_leq</span><span class="p">,</span> <span class="n">bounds_geq</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">bounds_leq</span><span class="p">)),</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">bounds_geq</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">solve_lp_with_bounds</span><span class="p">(</span><span class="n">bounds_leq</span><span class="p">,</span> <span class="n">bounds_geq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">x_relax</span><span class="p">,</span> <span class="n">lb</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">if</span> <span class="n">lb</span> <span class="o">&gt;=</span> <span class="n">best</span> <span class="o">-</span> <span class="mf">1e-9</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Check integer feasibility</span>
        <span class="n">x_int</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x_relax</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x_relax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_int</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)):</span>
            <span class="c1"># Verify Ax = b</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_int</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">x_int</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                    <span class="n">best</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">continue</span>
        <span class="c1"># Branch on most fractional variable among those with largest fractional part</span>
        <span class="n">frac_j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">frac_amt</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">x_relax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">val</span> <span class="o">-</span> <span class="nb">round</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">frac_amt</span> <span class="o">+</span> <span class="mf">1e-9</span><span class="p">:</span>
                <span class="n">frac_amt</span> <span class="o">=</span> <span class="n">f</span>
                <span class="n">frac_j</span> <span class="o">=</span> <span class="n">j</span>
        <span class="k">if</span> <span class="n">frac_j</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Shouldn&#39;t happen</span>
            <span class="k">continue</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">x_relax</span><span class="p">[</span><span class="n">frac_j</span><span class="p">]</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span> <span class="o">//</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># Branch: x_j &lt;= lo and x_j &gt;= hi</span>
        <span class="c1"># Push branch with larger lb later (DFS)</span>
        <span class="c1"># Estimate child LB by adjusting bounds and resolving maybe; but we&#39;ll just push both</span>
        <span class="k">if</span> <span class="n">lo</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bounds_leq</span> <span class="o">+</span> <span class="p">[(</span><span class="n">frac_j</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">lo</span><span class="p">))],</span> <span class="n">bounds_geq</span><span class="p">))</span>
        <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bounds_leq</span><span class="p">,</span> <span class="n">bounds_geq</span> <span class="o">+</span> <span class="p">[(</span><span class="n">frac_j</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">hi</span><span class="p">))]))</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total1</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">branch_and_bound_ilp</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
        <span class="n">total1</span> <span class="o">+=</span> <span class="n">val</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total1</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_milppy"> solve_day10_part2_milp.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:47:11.912773</li>
<li><strong>Duration</strong>: 0.35s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout_6">Stdout</h3>
<div class="highlight"><pre><span></span><code>15062
</code></pre></div>
<h3 id="code_17">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<span class="n">EPS</span> <span class="o">=</span> <span class="mf">1e-9</span>

<span class="c1"># Simplex for: maximize c^T x subject to A x = b, x &gt;= 0</span>
<span class="c1"># We&#39;ll construct A including slack variables for inequality bounds so that all constraints are equalities.</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Simplex</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">A</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span> <span class="n">b</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">c</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="c1"># Build initial tableau with Phase I artificials</span>
        <span class="c1"># Tableau dimensions: (m + 1) rows, (n + m + 1) cols (including RHS)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="p">[</span><span class="n">bi</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">bi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="c1"># Objective row will be appended later</span>
        <span class="c1"># Initial basic variables are artificials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)]</span>
        <span class="c1"># Build Phase I objective: maximize -sum(artificials)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>
            <span class="n">obj</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="c1"># Reduce objective by basic rows (since artificials are basic)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">obj</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pivot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enter_col</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">leave_row</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span>
        <span class="n">n_all</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">leave_row</span><span class="p">][</span><span class="n">enter_col</span><span class="p">]</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">piv</span>
        <span class="c1"># Normalize leaving row</span>
        <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">leave_row</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_all</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv</span>
        <span class="c1"># Eliminate in all other rows including objective</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">leave_row</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">enter_col</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">EPS</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_all</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">r</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">basic</span><span class="p">[</span><span class="n">leave_row</span><span class="p">]</span> <span class="o">=</span> <span class="n">enter_col</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">choose_entering</span><span class="p">(</span><span class="n">obj_row</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">n_all</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj_row</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">best</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_val</span> <span class="o">=</span> <span class="n">EPS</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_all</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">obj_row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best_val</span> <span class="o">+</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">best_val</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">j</span>
        <span class="k">return</span> <span class="n">best</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">choose_leaving</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="n">best_row</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_ratio</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">EPS</span><span class="p">:</span>
                <span class="n">ratio</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">a</span>
                <span class="k">if</span> <span class="n">ratio</span> <span class="o">&lt;</span> <span class="n">best_ratio</span> <span class="o">-</span> <span class="mf">1e-12</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ratio</span> <span class="o">-</span> <span class="n">best_ratio</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-12</span> <span class="ow">and</span> <span class="p">(</span><span class="n">best_row</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">best_row</span><span class="p">)):</span>
                    <span class="n">best_ratio</span> <span class="o">=</span> <span class="n">ratio</span>
                    <span class="n">best_row</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">best_row</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run_phase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objective</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
        <span class="c1"># If objective is provided, replace last row with it (assumed already reduced w.r.t. current basis)</span>
        <span class="k">if</span> <span class="n">objective</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">objective</span><span class="p">[:]</span>
        <span class="c1"># Simplex iterations</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">enter</span> <span class="o">=</span> <span class="n">Simplex</span><span class="o">.</span><span class="n">choose_entering</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">enter</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">leave</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">choose_leaving</span><span class="p">(</span><span class="n">enter</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">leave</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;unbounded&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">enter</span><span class="p">,</span> <span class="n">leave</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;opt&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">phase1</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_phase</span><span class="p">()</span>
        <span class="c1"># After Phase I, objective should be 0</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">1e-6</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_phase2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
        <span class="c1"># Remove artificial columns</span>
        <span class="n">n_all</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">n_phase2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>  <span class="c1"># number of real variables (original + slacks)</span>
        <span class="c1"># Determine which columns are artificials: last m columns before RHS</span>
        <span class="n">art_start</span> <span class="o">=</span> <span class="n">n_all</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span>
        <span class="c1"># If any artificial remains basic, try pivoting it out</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">:</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">var</span> <span class="o">&gt;=</span> <span class="n">art_start</span> <span class="ow">and</span> <span class="n">var</span> <span class="o">&lt;</span> <span class="n">n_all</span><span class="p">:</span>
                <span class="c1"># find entering non-artificial with nonzero coeff</span>
                <span class="n">enter_col</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_phase2</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">EPS</span><span class="p">:</span>
                        <span class="n">enter_col</span> <span class="o">=</span> <span class="n">j</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">enter_col</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># row is redundant; drop it</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">basic</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">enter_col</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Now delete artificial columns from all rows</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">row</span><span class="p">[</span><span class="n">n_phase2</span><span class="p">:</span><span class="n">n_all</span><span class="p">]</span>
        <span class="c1"># Rebuild objective row as c - sum(cb_i * row_i)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span> <span class="p">(</span><span class="n">n_phase2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_phase2</span><span class="p">):</span>
            <span class="n">obj</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">obj</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="k">if</span> <span class="n">var</span> <span class="o">&lt;</span> <span class="n">n_phase2</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">EPS</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_phase2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">obj</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">cb</span> <span class="o">*</span> <span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_vars</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">n_vars</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m</span><span class="p">):</span>
            <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">var</span> <span class="o">&lt;</span> <span class="n">n_vars</span><span class="p">:</span>
                <span class="n">x</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># dedup</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">))</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">A</span>


<span class="k">def</span><span class="w"> </span><span class="nf">greedy_upper_bound</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">A</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">k</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">rem</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:]</span>
    <span class="n">coverers</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="c1"># quick infeasibility</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">}</span>
    <span class="n">presses</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">pos</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">rem</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
        <span class="n">best_j</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_cov</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">pos</span> <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cov</span> <span class="o">&gt;</span> <span class="n">best_cov</span><span class="p">:</span>
                <span class="n">best_cov</span> <span class="o">=</span> <span class="n">cov</span>
                <span class="n">best_j</span> <span class="o">=</span> <span class="n">j</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">best_j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                    <span class="n">pos</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="n">presses</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">presses</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine_ilp</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">A_base</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A_base</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">k</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># global UB via greedy</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">greedy_upper_bound</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">A_base</span><span class="p">)</span>

    <span class="c1"># BnB stack of bounds: each node has a dict of bounds {j: (L, U)}</span>
    <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">()]</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">while</span> <span class="n">stack</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bounds</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="c1"># build augmented A and b with slack variables for bounds</span>
        <span class="n">Aeq</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A_base</span><span class="p">]</span>
        <span class="n">beq</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:]</span>
        <span class="c1"># For each bound x_j in [L,U], we add constraints x_j + s = U and -x_j + t = -L, with s,t &gt;= 0</span>
        <span class="c1"># We&#39;ll add columns for slack variables.</span>
        <span class="n">n_base</span> <span class="o">=</span> <span class="n">m</span>
        <span class="n">Acols_extra</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">rows_extra</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rhs_extra</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span> <span class="ow">in</span> <span class="n">bounds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">U</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">n_base</span>
                <span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">rows_extra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">rhs_extra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">U</span><span class="p">))</span>
                <span class="n">Acols_extra</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># slack s &gt;= 0</span>
            <span class="k">if</span> <span class="n">L</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">L</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">n_base</span>
                <span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
                <span class="n">rows_extra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
                <span class="n">rhs_extra</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="o">-</span><span class="n">L</span><span class="p">))</span>
                <span class="n">Acols_extra</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># slack t &gt;= 0</span>
        <span class="c1"># Build full A matrix with extra slack columns</span>
        <span class="k">if</span> <span class="n">rows_extra</span><span class="p">:</span>
            <span class="c1"># expand existing rows with zeros for slack columns</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Aeq</span><span class="p">)):</span>
                <span class="n">Aeq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">Acols_extra</span><span class="p">)</span>
            <span class="c1"># build rows with slack identity in extras space</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">rhs</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rows_extra</span><span class="p">,</span> <span class="n">rhs_extra</span><span class="p">):</span>
                <span class="n">rr</span> <span class="o">=</span> <span class="n">row</span><span class="p">[:]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">Acols_extra</span>
                <span class="n">rr</span><span class="p">[</span><span class="n">n_base</span> <span class="o">+</span> <span class="n">cur</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                <span class="n">cur</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">Aeq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
                <span class="n">beq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># still need to align sizes</span>
            <span class="k">pass</span>
        <span class="c1"># cost vector: -1 for original vars, 0 for slacks</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]</span><span class="o">*</span><span class="n">n_base</span> <span class="o">+</span> <span class="p">([</span><span class="mf">0.0</span><span class="p">]</span><span class="o">*</span><span class="n">Acols_extra</span> <span class="k">if</span> <span class="n">rows_extra</span> <span class="k">else</span> <span class="p">[])</span>
        <span class="c1"># Solve LP</span>
        <span class="n">simp</span> <span class="o">=</span> <span class="n">Simplex</span><span class="p">(</span><span class="n">Aeq</span><span class="p">,</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">beq</span><span class="p">],</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">simp</span><span class="o">.</span><span class="n">phase1</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">simp</span><span class="o">.</span><span class="n">build_phase2</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">status</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">simp</span><span class="o">.</span><span class="n">run_phase</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;opt&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="o">-</span><span class="n">obj</span>  <span class="c1"># since maximizing -sum x</span>
        <span class="k">if</span> <span class="n">lb</span> <span class="o">&gt;=</span> <span class="n">best</span> <span class="o">-</span> <span class="mf">1e-9</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">x_relax</span> <span class="o">=</span> <span class="n">simp</span><span class="o">.</span><span class="n">get_solution</span><span class="p">(</span><span class="n">n_base</span><span class="p">)</span>
        <span class="c1"># Check integrality</span>
        <span class="n">x_int</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x_relax</span><span class="p">]</span>
        <span class="n">integral</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x_relax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_int</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mf">1e-8</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_base</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">integral</span><span class="p">:</span>
            <span class="c1"># verify Ax = b</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_base</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">A_base</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_int</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">x_int</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                    <span class="n">best</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">continue</span>
        <span class="c1"># pick branching variable: most fractional</span>
        <span class="n">frac_j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">frac_amt</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_base</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">x_relax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="nb">round</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">frac_amt</span> <span class="o">+</span> <span class="mf">1e-9</span><span class="p">:</span>
                <span class="n">frac_amt</span> <span class="o">=</span> <span class="n">f</span>
                <span class="n">frac_j</span> <span class="o">=</span> <span class="n">j</span>
        <span class="k">if</span> <span class="n">frac_j</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">x_relax</span><span class="p">[</span><span class="n">frac_j</span><span class="p">]</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">v</span> <span class="o">//</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># Push branches: x_j &lt;= lo and x_j &gt;= hi</span>
        <span class="n">b1</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">L0</span><span class="p">,</span> <span class="n">U0</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">frac_j</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">lo</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">U0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lo</span> <span class="o">&lt;</span> <span class="n">U0</span><span class="p">:</span>
            <span class="n">b1</span><span class="p">[</span><span class="n">frac_j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">L0</span><span class="p">,</span> <span class="n">lo</span><span class="p">)</span>
            <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">L0</span><span class="p">,</span> <span class="n">U0</span> <span class="o">=</span> <span class="n">b2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">frac_j</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="c1"># increase lower bound to hi</span>
        <span class="k">if</span> <span class="n">hi</span> <span class="o">&gt;</span> <span class="n">L0</span><span class="p">:</span>
            <span class="c1"># but also must be &lt;= U0 if exists</span>
            <span class="k">if</span> <span class="n">U0</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">hi</span> <span class="o">&lt;=</span> <span class="n">U0</span><span class="p">:</span>
                <span class="n">b2</span><span class="p">[</span><span class="n">frac_j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">U0</span><span class="p">)</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">solve_machine_ilp</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_bnbpy"> solve_day10_part2_bnb.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:50:30.635064</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_18">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># deduplicate identical columns</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">bit_count</span><span class="p">(),</span> <span class="n">x</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span>


<span class="k">def</span><span class="w"> </span><span class="nf">precompute</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">full</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
    <span class="n">contrib</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># contrib[j][T] = popcount(cols[j] &amp; T)</span>
    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
        <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
        <span class="n">contrib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="c1"># cap_T_suffix[s][T] = max_{j&gt;=s} contrib[j][T]</span>
    <span class="n">cap_T_suffix</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">cap_T_suffix</span><span class="p">[</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="n">cap_T_suffix</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">cj</span> <span class="o">=</span> <span class="n">contrib</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">cj</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
            <span class="n">pv</span> <span class="o">=</span> <span class="n">prev</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
            <span class="n">cur</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">pv</span> <span class="k">else</span> <span class="n">pv</span>
    <span class="c1"># max_cov_suffix[s] = max bitcount of cols[j] for j&gt;=s</span>
    <span class="n">max_cov_suffix</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">max_cov_suffix</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_cov_suffix</span><span class="p">[</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">cols</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">bit_count</span><span class="p">())</span>
    <span class="c1"># cover_counts_suffix[s][i] = number of columns j&gt;=s that cover counter i</span>
    <span class="n">cover_counts_suffix</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">k</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">cover_counts_suffix</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cover_counts_suffix</span><span class="p">[</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="p">((</span><span class="n">cols</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">idxs</span><span class="p">,</span> <span class="n">contrib</span><span class="p">,</span> <span class="n">cap_T_suffix</span><span class="p">,</span> <span class="n">max_cov_suffix</span><span class="p">,</span> <span class="n">cover_counts_suffix</span>


<span class="k">def</span><span class="w"> </span><span class="nf">lower_bound_from_sums</span><span class="p">(</span><span class="n">sums_T</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cap_T</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sums_T</span><span class="p">)):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">cap_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">c</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">greedy_upper_bound</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">idxs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">rem</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:]</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pos</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">presses</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Precompute coverage lists per i</span>
    <span class="n">coverers</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">idxs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">pos</span><span class="p">:</span>
        <span class="c1"># pick i with largest rem</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">rem</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
        <span class="c1"># pick column covering i maximizing coverage on pos</span>
        <span class="n">best_j</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_cov</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">pos</span> <span class="k">if</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">cov</span> <span class="o">&gt;</span> <span class="n">best_cov</span><span class="p">:</span>
                <span class="n">best_cov</span> <span class="o">=</span> <span class="n">cov</span>
                <span class="n">best_j</span> <span class="o">=</span> <span class="n">j</span>
        <span class="c1"># press it once</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">best_j</span><span class="p">]:</span>
            <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                <span class="n">pos</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="n">presses</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">presses</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">t</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Quick infeasibility: any i with t_i&gt;0 and not covered by any column</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span> <span class="ow">and</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible (uncovered counter)&#39;</span><span class="p">)</span>
    <span class="n">idxs</span><span class="p">,</span> <span class="n">contrib</span><span class="p">,</span> <span class="n">cap_T_suffix</span><span class="p">,</span> <span class="n">max_cov_suffix</span><span class="p">,</span> <span class="n">cover_counts_suffix</span> <span class="o">=</span> <span class="n">precompute</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">full</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span>
    <span class="c1"># initial sums_T</span>
    <span class="n">sums_T</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
    <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">T</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
    <span class="c1"># Initial upper bound via greedy</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">greedy_upper_bound</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">idxs</span><span class="p">)</span>

    <span class="n">rem</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:]</span>

    <span class="c1"># DFS with branch and bound over columns</span>
    <span class="n">sys_best</span> <span class="o">=</span> <span class="p">[</span><span class="n">best</span><span class="p">]</span>
    <span class="n">visited</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">search</span><span class="p">(</span><span class="n">j</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">g</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># lower bound from subset caps on remaining columns</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">lower_bound_from_sums</span><span class="p">(</span><span class="n">sums_T</span><span class="p">,</span> <span class="n">cap_T_suffix</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">g</span> <span class="o">+</span> <span class="n">lb</span> <span class="o">&gt;=</span> <span class="n">sys_best</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="c1"># quick bound from sum and max coverage</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">sums_T</span><span class="p">[</span><span class="n">full</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">max_cov_suffix</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">max_cov_suffix</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">g</span> <span class="o">+</span> <span class="n">b2</span> <span class="o">&gt;=</span> <span class="n">sys_best</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="k">return</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">m</span><span class="p">:</span>
            <span class="c1"># must have all zeros</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rem</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">g</span> <span class="o">&lt;</span> <span class="n">sys_best</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">sys_best</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
            <span class="k">return</span>
        <span class="c1"># memo prune</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rem</span><span class="p">))</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">visited</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev</span> <span class="o">&lt;=</span> <span class="n">g</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">visited</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
        <span class="c1"># forced unique coverage counts</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ids</span><span class="p">:</span>
            <span class="n">search</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># compute c_max</span>
        <span class="n">c_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c_max</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">search</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># forced c if unique coverage</span>
        <span class="n">uniques</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span> <span class="k">if</span> <span class="n">cover_counts_suffix</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">uniques</span><span class="p">:</span>
            <span class="n">forced_vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">uniques</span><span class="p">}</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">forced_vals</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span>  <span class="c1"># infeasible down this branch</span>
            <span class="n">c_forced</span> <span class="o">=</span> <span class="n">forced_vals</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c_forced</span> <span class="o">&gt;</span> <span class="n">c_max</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="c1"># apply forced c</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">contrib</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="c1"># update sums_T</span>
            <span class="k">if</span> <span class="n">c_forced</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
                    <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">-=</span> <span class="n">c_forced</span> <span class="o">*</span> <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
            <span class="c1"># update rem</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="n">c_forced</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># undo and return</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                        <span class="n">rem</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c_forced</span>
                    <span class="k">if</span> <span class="n">c_forced</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
                            <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c_forced</span> <span class="o">*</span> <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
                    <span class="k">return</span>
                <span class="n">changed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="n">search</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">g</span> <span class="o">+</span> <span class="n">c_forced</span><span class="p">)</span>
            <span class="c1"># undo</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">changed</span><span class="p">:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c_forced</span>
            <span class="k">if</span> <span class="n">c_forced</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
                    <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c_forced</span> <span class="o">*</span> <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
            <span class="k">return</span>
        <span class="c1"># Try values for c in descending order to find good solution early</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">contrib</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># Also cap by remaining budget</span>
        <span class="n">budget</span> <span class="o">=</span> <span class="n">sys_best</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">g</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">budget</span> <span class="o">&lt;</span> <span class="n">c_max</span><span class="p">:</span>
            <span class="n">c_max</span> <span class="o">=</span> <span class="n">budget</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c_max</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
                    <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">-=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
            <span class="c1"># quick LB prune</span>
            <span class="n">lb2</span> <span class="o">=</span> <span class="n">lower_bound_from_sums</span><span class="p">(</span><span class="n">sums_T</span><span class="p">,</span> <span class="n">cap_T_suffix</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">g</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="n">lb2</span> <span class="o">&lt;</span> <span class="n">sys_best</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1"># apply rem update</span>
                <span class="n">feasible</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                    <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="n">c</span>
                    <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="n">changed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">feasible</span><span class="p">:</span>
                    <span class="n">search</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">g</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">changed</span><span class="p">:</span>
                    <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span>
            <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
                    <span class="n">sums_T</span><span class="p">[</span><span class="n">T</span><span class="p">]</span> <span class="o">+=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">arr</span><span class="p">[</span><span class="n">T</span><span class="p">]</span>
            <span class="c1"># Fast prune: if c is 0 and next LB already &gt;= best, we can break early</span>
            <span class="c1"># but loop ends anyway</span>
        <span class="k">return</span>

    <span class="n">search</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sys_best</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_componentspy"> solve_day10_part2_components.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:53:17.225003</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_19">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># Remove columns that touch zero-target rows (cannot be pressed even once)</span>
    <span class="n">zero_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">zero_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">zero_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Deduplicate</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">filtered</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span>


<span class="k">def</span><span class="w"> </span><span class="nf">components</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="c1"># Build adjacency among counters via columns</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">union</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">ra</span><span class="p">,</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ra</span> <span class="o">!=</span> <span class="n">rb</span><span class="p">:</span>
            <span class="n">parent</span><span class="p">[</span><span class="n">rb</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra</span>

    <span class="c1"># Only consider counters with t&gt;0</span>
    <span class="n">active</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="c1"># Union counters that appear in same column</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="c1"># extract indices</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="n">m</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">mm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mm</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">mm</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">union</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
    <span class="c1"># Map counters to comp id</span>
    <span class="n">comp_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">active</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">comp_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">comps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">comp_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># columns that are subset of nodes set</span>
        <span class="n">mask_nodes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">mask_nodes</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">comp_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask_nodes</span><span class="p">:</span>
                <span class="c1"># column touches outside; ignore in this component</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">&amp;</span> <span class="n">mask_nodes</span><span class="p">:</span>
                <span class="n">comp_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nodes</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">comp_cols</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">comps</span>


<span class="k">def</span><span class="w"> </span><span class="nf">greedy_upper_bound_comp</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># simple greedy: at each step pick i with largest rem, then column covering i with maximum coverage among remaining positive rows</span>
    <span class="n">rem</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">}</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">presses</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># Precompute coverage lists per i</span>
    <span class="n">coverers</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">pos</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">rem</span><span class="p">[</span><span class="n">t</span><span class="p">])</span>
        <span class="c1"># choose column m covering i maximizing |covered in pos|</span>
        <span class="n">best_m</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_cov</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">pos</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">ii</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">cov</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">cov</span> <span class="o">&gt;</span> <span class="n">best_cov</span><span class="p">:</span>
                <span class="n">best_cov</span> <span class="o">=</span> <span class="n">cov</span>
                <span class="n">best_m</span> <span class="o">=</span> <span class="n">m</span>
        <span class="c1"># apply once</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pos</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">best_m</span> <span class="o">&gt;&gt;</span> <span class="n">ii</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pos</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
        <span class="n">presses</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">presses</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_component</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># Remap indices to 0..k-1 for component</span>
    <span class="n">idx_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodes</span><span class="p">)}</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Build local targets and local cols masks</span>
    <span class="n">T</span> <span class="o">=</span> <span class="p">[</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]</span>
    <span class="n">local_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">msk</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">msk</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">lm</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">lm</span><span class="p">:</span>
            <span class="n">local_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lm</span><span class="p">)</span>
    <span class="c1"># Dedup again</span>
    <span class="n">local_cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">local_cols</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_cols</span><span class="p">)</span>
    <span class="c1"># Trivial: if single counter</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Only columns that touch it are allowed; each press increments by 1; minimal presses equals target</span>
        <span class="k">return</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Precompute arrays</span>
    <span class="n">full</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span>
    <span class="c1"># contrib per col to any subset T</span>
    <span class="n">contrib</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">local_cols</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm</span> <span class="o">&amp;</span> <span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
        <span class="n">contrib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="c1"># cap_T = max over cols of contrib[j][T]</span>
    <span class="n">cap_T</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
    <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">contrib</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">S</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">if</span> <span class="n">best</span> <span class="o">==</span> <span class="n">S</span><span class="o">.</span><span class="n">bit_count</span><span class="p">():</span>
                    <span class="k">break</span>
        <span class="n">cap_T</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="n">best</span>
    <span class="n">sums_T</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
    <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="c1"># sum of targets over rows in S</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">S</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">sums_T</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
    <span class="c1"># infeasible quick check</span>
    <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sums_T</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">cap_T</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible component&#39;</span><span class="p">)</span>
    <span class="c1"># Upper bound via greedy</span>
    <span class="n">ub</span> <span class="o">=</span> <span class="n">greedy_upper_bound_comp</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>

    <span class="n">rem</span> <span class="o">=</span> <span class="n">T</span><span class="p">[:]</span>
    <span class="n">best</span> <span class="o">=</span> <span class="p">[</span><span class="n">ub</span><span class="p">]</span>
    <span class="c1"># memo</span>
    <span class="n">seen</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Precompute index lists per column</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">local_cols</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">cm</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">lower_bound</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># subset bound</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">S</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">t</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">cap_T</span><span class="p">[</span><span class="n">S</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">c</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">lb</span><span class="p">:</span>
                <span class="n">lb</span> <span class="o">=</span> <span class="n">v</span>
        <span class="c1"># sum bound by max column weight</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">total</span><span class="p">:</span>
            <span class="n">maxw</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idxs</span><span class="p">)))</span>
            <span class="n">b2</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">maxw</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">maxw</span>
            <span class="k">if</span> <span class="n">b2</span> <span class="o">&gt;</span> <span class="n">lb</span><span class="p">:</span>
                <span class="n">lb</span> <span class="o">=</span> <span class="n">b2</span>
        <span class="c1"># simple per-row bound</span>
        <span class="n">mr</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span> <span class="k">if</span> <span class="n">rem</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">mr</span> <span class="o">&gt;</span> <span class="n">lb</span><span class="p">:</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">mr</span>
        <span class="k">return</span> <span class="n">lb</span>

    <span class="c1"># choose pivot row with largest rem</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pick_pivot</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">best_i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">best_v</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best_v</span><span class="p">:</span>
                <span class="n">best_v</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">best_i</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">return</span> <span class="n">best_i</span>

    <span class="c1"># DFS with pruning, tries pressing columns that cover pivot</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">g</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">lower_bound</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">g</span> <span class="o">+</span> <span class="n">lb</span> <span class="o">&gt;=</span> <span class="n">best</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rem</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">g</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">best</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
            <span class="k">return</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev</span> <span class="o">&lt;=</span> <span class="n">g</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">seen</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">pick_pivot</span><span class="p">()</span>
        <span class="c1"># candidate columns that cover i, sorted by coverage on positive positions</span>
        <span class="n">pos_mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pos_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ii</span><span class="p">)</span>
        <span class="n">cand</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">cm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">local_cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">cm</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cm</span> <span class="o">&amp;</span> <span class="n">pos_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cm</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm</span> <span class="o">&amp;</span> <span class="n">pos_mask</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
            <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">cov</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
        <span class="n">cand</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cand</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="c1"># Apply once</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">dfs</span><span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># undo</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">dfs</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">best</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">comps</span> <span class="o">=</span> <span class="n">components</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">comps</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">comp_cols</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">solve_component</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">comp_cols</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">total</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_exact2py"> solve_day10_part2_exact2.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:57:14.321007</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_20">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># Remove columns that touch zero-target rows</span>
    <span class="n">zero_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">zero_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">zero_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Keep only rows with t&gt;0</span>
    <span class="n">active_map</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">active_map</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">remapped</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">new_i</span><span class="p">,</span> <span class="n">old_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">active_map</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">old_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">mm</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">new_i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mm</span><span class="p">:</span>
            <span class="n">remapped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span>
    <span class="c1"># dedup</span>
    <span class="n">remapped</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">remapped</span><span class="p">))</span>
    <span class="n">targets_act</span> <span class="o">=</span> <span class="p">[</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">active_map</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">targets_act</span><span class="p">,</span> <span class="n">remapped</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_matrix</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">m</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span>


<span class="k">def</span><span class="w"> </span><span class="nf">row_echelon</span><span class="p">(</span><span class="n">A</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]):</span>
    <span class="c1"># Gaussian elimination over rationals to find independent rows and pivot columns</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">k</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">piv_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">row_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="c1"># find pivot at or below row with nonzero in column</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">r</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># swap</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="c1"># normalize pivot row</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">pivv</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv</span>
        <span class="c1"># eliminate other rows</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">row</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="n">piv_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">row_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">piv_cols</span><span class="p">)</span>
    <span class="n">indep_rows</span> <span class="o">=</span> <span class="n">row_ids</span><span class="p">[:]</span>
    <span class="c1"># Map independent rows to original indices since we swapped rows internally; but we used in-place M, but row_ids are indices after swaps relative to original? After swap, row &#39;row&#39; refers to original &#39;piv&#39;. However row_ids is sequence of pivot row indices referring to current M; However original A rows were permuted; To track original indices, we would need to maintain permutation.</span>
    <span class="c1"># For simplicity, we recompute independent rows via a second pass using integer arithmetic: find a maximal independent set of rows by incremental check.</span>
    <span class="n">indep_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">B</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># current independent row set as list of vectors</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
        <span class="c1"># check if v is linear combination of B</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">B</span><span class="p">]</span>
        <span class="n">vv</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:]</span>
        <span class="n">rr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># perform elimination against tmp</span>
        <span class="c1"># build augmented matrix to check rank increase</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="c1"># find pivot</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">tmp</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">pr</span> <span class="o">=</span> <span class="n">r</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">vv</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># eliminate using tmp[pr]</span>
                    <span class="n">inv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">tmp</span><span class="p">[</span><span class="n">pr</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
                    <span class="c1"># Use multiple of pivot row to eliminate vv[col]</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">vv</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">*</span> <span class="n">inv</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
                        <span class="n">vv</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">[</span><span class="n">pr</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># This column can be pivot for vv, so independent</span>
                    <span class="n">indep_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="c1"># normalize vv and add to tmp</span>
                    <span class="n">invv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vv</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
                        <span class="n">vv</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*=</span> <span class="n">invv</span>
                    <span class="n">B</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vv</span><span class="p">)</span>
                    <span class="n">rr</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># loop exhausted without finding pivot -&gt; dependent</span>
            <span class="k">pass</span>
    <span class="c1"># Now determine pivot columns relative to these indep rows</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indep_rows</span><span class="p">)</span>
    <span class="c1"># Build submatrix of these rows and perform column elimination to find pivot columns</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">M2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indep_rows</span><span class="p">]</span>
    <span class="n">piv_cols2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">row2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="c1"># find pivot in this column</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">rrow</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row2</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M2</span><span class="p">[</span><span class="n">rrow</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">rrow</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">row2</span><span class="p">:</span>
            <span class="n">M2</span><span class="p">[</span><span class="n">row2</span><span class="p">],</span> <span class="n">M2</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M2</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M2</span><span class="p">[</span><span class="n">row2</span><span class="p">]</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">M2</span><span class="p">[</span><span class="n">row2</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">pv</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="n">M2</span><span class="p">[</span><span class="n">row2</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv</span>
        <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rr</span> <span class="o">==</span> <span class="n">row2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">M2</span><span class="p">[</span><span class="n">rr</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
                    <span class="n">M2</span><span class="p">[</span><span class="n">rr</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M2</span><span class="p">[</span><span class="n">row2</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="n">piv_cols2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">row2</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">row2</span> <span class="o">==</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">indep_rows</span><span class="p">,</span> <span class="n">piv_cols2</span>


<span class="k">def</span><span class="w"> </span><span class="nf">invert_matrix_int</span><span class="p">(</span><span class="n">B</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]):</span>
    <span class="c1"># Return (det, adj_matrix) with integer entries using Fractions exact inverse</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
    <span class="c1"># Augment with identity to compute inverse via Gauss-Jordan</span>
    <span class="n">inv</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="c1"># find pivot row with nonzero</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">col</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">inv</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">inv</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">inv</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">sign</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
        <span class="n">det</span> <span class="o">*=</span> <span class="n">pv</span>
        <span class="n">inv_pv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">pv</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv_pv</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">inv</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv_pv</span>
        <span class="c1"># eliminate other rows</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">col</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                    <span class="n">inv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">inv</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">det</span> <span class="o">*</span> <span class="n">sign</span>
    <span class="c1"># adjugate = det * inverse</span>
    <span class="n">adj</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">((</span><span class="n">det</span> <span class="o">*</span> <span class="n">inv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">numerator</span> <span class="o">//</span> <span class="p">(</span><span class="n">det</span> <span class="o">*</span> <span class="n">inv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
    <span class="c1"># Verify integers</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">det</span><span class="o">.</span><span class="n">numerator</span> <span class="o">//</span> <span class="n">det</span><span class="o">.</span><span class="n">denominator</span><span class="p">),</span> <span class="n">adj</span>


<span class="k">def</span><span class="w"> </span><span class="nf">extended_gcd</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">g</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">extended_gcd</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span> <span class="o">//</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">y1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">crt_combine</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="c1"># Solve X  x (mod m), X  a (mod n) -&gt; (X mod lcm, lcm) or (None, None) if no solution</span>
    <span class="n">g</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">extended_gcd</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">lcm</span> <span class="o">=</span> <span class="n">m</span> <span class="o">//</span> <span class="n">g</span> <span class="o">*</span> <span class="n">n</span>
    <span class="c1"># X = x + m * s * ((a - x)/g) mod lcm</span>
    <span class="n">k</span> <span class="o">=</span> <span class="p">((</span><span class="n">a</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="n">g</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="n">k</span> <span class="o">%</span> <span class="p">(</span><span class="n">n</span> <span class="o">//</span> <span class="n">g</span><span class="p">)))</span> <span class="o">%</span> <span class="n">lcm</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">lcm</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">targets</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible: no usable buttons for positive targets&#39;</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">build_matrix</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="c1"># Quick infeasibility: any row with no 1s</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">))):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible row&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">indep_rows</span><span class="p">,</span> <span class="n">piv_cols</span> <span class="o">=</span> <span class="n">row_echelon</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># no constraints, but targets positive -&gt; impossible</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No rank but positive targets&#39;</span><span class="p">)</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">indep_rows</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">piv_cols</span><span class="p">[:</span><span class="n">r</span><span class="p">]</span>
    <span class="n">F</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">))</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">C</span><span class="p">]</span>
    <span class="c1"># Build B and A_F using rows R</span>
    <span class="n">B</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">C</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="n">D</span><span class="p">,</span> <span class="n">adj</span> <span class="o">=</span> <span class="n">invert_matrix_int</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Shouldn&#39;t happen if we picked pivots</span>
        <span class="c1"># Try to choose some other set of r columns that forms invertible matrix</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_det</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">C2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">B2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">C2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
            <span class="n">D2</span><span class="p">,</span> <span class="n">adj2</span> <span class="o">=</span> <span class="n">invert_matrix_int</span><span class="p">(</span><span class="n">B2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">D2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ad</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">D2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">best_det</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ad</span> <span class="o">&lt;</span> <span class="n">best_det</span><span class="p">:</span>
                    <span class="n">best_det</span> <span class="o">=</span> <span class="n">ad</span>
                    <span class="n">best</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">C2</span><span class="p">),</span> <span class="n">D2</span><span class="p">,</span> <span class="n">adj2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ad</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">break</span>
        <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No invertible basis found&#39;</span><span class="p">)</span>
        <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">adj</span> <span class="o">=</span> <span class="n">best</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">best</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">best</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">F</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">))</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">C</span><span class="p">]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">C</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="c1"># Now M = adj(B) * A_F, b0 = adj(B) * t_R</span>
    <span class="n">rdim</span> <span class="o">=</span> <span class="n">r</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="c1"># Build A_F rows R</span>
    <span class="n">A_F_R</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">F</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="c1"># Compute b0</span>
    <span class="n">t_R</span> <span class="o">=</span> <span class="p">[</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">adj</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">t_R</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
    <span class="c1"># Compute M</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">sum</span><span class="p">(</span><span class="n">adj</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">A_F_R</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
    <span class="n">Dabs</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="c1"># Now we need x_F &gt;= 0 such that M x_F  b0 (mod Dabs) and M x_F  b0 component-wise.</span>
    <span class="c1"># Objective: total presses = sum(x_F) + sum((b0 - M x_F)/Dabs)</span>
    <span class="c1"># Return minimal.</span>

    <span class="c1"># Handle d==0</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># require b0 divisible by D and nonnegative after divide</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="n">Dabs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No solution (divisibility)&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">Dabs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Negative base solution&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">Dabs</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">))</span>

    <span class="c1"># Precompute column vectors m_j and column sums</span>
    <span class="n">mj</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="p">]</span>
    <span class="n">sum_mj</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">mj</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
    <span class="c1"># upper bounds per var from inequality M x_F  b0</span>
    <span class="n">ub</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">u</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mj</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">u</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">mj</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">u</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
            <span class="c1"># This column does not affect constraints in R =&gt; free to press? But would not change equality; Actually if its vector is zero, it&#39;s in kernel on R rows, meaning it only affects dependent rows; but those are linear combos; if zero on R, it&#39;s actually zero column in A restricted to independent rows; that implies column is linear combination within dependent rows only -&gt; Pressing it would break those dependent rows, contradiction. So such F should be empty; but to be safe, set ub 0.</span>
            <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
    <span class="c1"># We&#39;ll search by reducing dimension to 1 via CRT combining on last variable</span>

    <span class="c1"># Precompute modulo constraints per row: we will use last variable index &#39;last&#39; with mj[last]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">combine_for_last</span><span class="p">(</span><span class="n">prefix_vals</span><span class="p">):</span>
        <span class="c1"># prefix_vals is list length d-1 with chosen x for first d-1 vars</span>
        <span class="c1"># Compute residual r_i = b0_i - sum_{j&lt;d} m_{ij} x_j</span>
        <span class="n">rvec</span> <span class="o">=</span> <span class="p">[</span><span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">prefix_vals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                <span class="n">rvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">mj</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">prefix_vals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># Now constraints for x_d: for rows where m_d_i == 0 require r_i  0 (mod D); if not, infeasible</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">d</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># initial congruence X  a mod mod</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="n">md</span> <span class="o">=</span> <span class="n">mj</span><span class="p">[</span><span class="n">last</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="n">bi</span> <span class="o">=</span> <span class="n">rvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">md</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bi</span> <span class="o">%</span> <span class="n">Dabs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># infeasible</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="c1"># Solve md * x  bi (mod D)</span>
            <span class="n">g</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">extended_gcd</span><span class="p">(</span><span class="n">md</span> <span class="o">%</span> <span class="n">Dabs</span><span class="p">,</span> <span class="n">Dabs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bi</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="c1"># Reduce: (md/g) x  (bi/g) (mod D/g)</span>
            <span class="n">mdg</span> <span class="o">=</span> <span class="p">(</span><span class="n">md</span> <span class="o">//</span> <span class="n">g</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">Dabs</span> <span class="o">//</span> <span class="n">g</span><span class="p">)</span>
            <span class="n">big</span> <span class="o">=</span> <span class="n">bi</span> <span class="o">//</span> <span class="n">g</span>
            <span class="n">inv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">mdg</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Dabs</span> <span class="o">//</span> <span class="n">g</span><span class="p">)</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">big</span> <span class="o">*</span> <span class="n">inv</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">Dabs</span> <span class="o">//</span> <span class="n">g</span><span class="p">)</span>
            <span class="c1"># Combine x  xi (mod D/g)</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="n">crt_combine</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">Dabs</span> <span class="o">//</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Now we have x_d  a (mod mod)</span>
        <span class="c1"># Also need inequality constraints: rvec - md * x_d  0 =&gt; for md&gt;0: x_d  rvec[i] // md</span>
        <span class="n">ub_d</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="n">last</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="n">md</span> <span class="o">=</span> <span class="n">mj</span><span class="p">[</span><span class="n">last</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">md</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lim</span> <span class="o">=</span> <span class="n">rvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">md</span>
                <span class="k">if</span> <span class="n">lim</span> <span class="o">&lt;</span> <span class="n">ub_d</span><span class="p">:</span>
                    <span class="n">ub_d</span> <span class="o">=</span> <span class="n">lim</span>
        <span class="k">if</span> <span class="n">ub_d</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Lower bound x_d  0</span>
        <span class="n">lb_d</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Find minimal x_d &gt;= lb_d such that x_d  a (mod mod)</span>
        <span class="c1"># The set is {a + k*mod}, take smallest  0; compute a_mod = (a % mod)</span>
        <span class="n">a_mod</span> <span class="o">=</span> <span class="n">a</span> <span class="o">%</span> <span class="n">mod</span>
        <span class="c1"># minimal feasible x_d is x0 = a_mod (&gt;=0). But ensure  ub_d.</span>
        <span class="c1"># Consider multiple values separated by mod up to ub_d. For objective we may need largest if delta negative.</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">rvec</span><span class="p">,</span> <span class="n">a_mod</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">ub_d</span><span class="p">)</span>

    <span class="c1"># Objective components</span>
    <span class="n">const_sum_b0</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">b0</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_presses</span><span class="p">(</span><span class="n">sum_MxF</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">sum_xF</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># sum of x_B = (const_sum_b0 - sum_MxF)/Dabs</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">const_sum_b0</span> <span class="o">-</span> <span class="n">sum_MxF</span><span class="p">)</span> <span class="o">//</span> <span class="n">Dabs</span> <span class="o">+</span> <span class="n">sum_xF</span>

    <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">try_with_prefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">best</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">combine_for_last</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">rvec</span><span class="p">,</span> <span class="n">a_mod</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">ub_d</span> <span class="o">=</span> <span class="n">res</span>
        <span class="n">last</span> <span class="o">=</span> <span class="n">d</span><span class="o">-</span><span class="mi">1</span>
        <span class="c1"># sum_MxF for prefix only</span>
        <span class="n">sum_M_pref</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sum_x_pref</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">prefix</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">sum_M_pref</span> <span class="o">+=</span> <span class="n">sum_mj</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">prefix</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">sum_x_pref</span> <span class="o">+=</span> <span class="n">prefix</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># delta for last variable per unit</span>
        <span class="n">delta_M</span> <span class="o">=</span> <span class="n">sum_mj</span><span class="p">[</span><span class="n">last</span><span class="p">]</span>
        <span class="c1"># Decide candidate x_d values: either minimal feasible (a_mod) or maximal  ub_d with same residue</span>
        <span class="k">if</span> <span class="n">mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># shouldn&#39;t happen, but guard</span>
            <span class="n">xs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># compute first feasible &gt;=0</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">a_mod</span>
            <span class="c1"># minimal</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">x0</span> <span class="o">&lt;=</span> <span class="n">ub_d</span><span class="p">:</span>
                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
            <span class="c1"># maximal: largest &lt;= ub_d congruent to a_mod mod mod</span>
            <span class="k">if</span> <span class="n">ub_d</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">ub_d</span> <span class="o">-</span> <span class="n">a_mod</span><span class="p">)</span> <span class="o">//</span> <span class="n">mod</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">a_mod</span> <span class="o">+</span> <span class="n">k</span> <span class="o">*</span> <span class="n">mod</span>
                <span class="k">if</span> <span class="n">x1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span> <span class="ow">or</span> <span class="n">x1</span> <span class="o">!=</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span>
            <span class="c1"># maybe try one interior near objective slope zero? But delta for last variable effect on objective is integer slope: delta_obj = 1 - delta_M/D</span>
            <span class="c1"># Note that objective in x_d is linear; min at boundary as chosen above.</span>
            <span class="c1"># Evaluate candidates</span>
            <span class="k">for</span> <span class="n">xd</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                <span class="c1"># verify nonnegativity for all rows: rvec - md*xd &gt;= 0 guaranteed by ub_d bound</span>
                <span class="n">sum_M</span> <span class="o">=</span> <span class="n">sum_M_pref</span> <span class="o">+</span> <span class="n">delta_M</span> <span class="o">*</span> <span class="n">xd</span>
                <span class="n">sum_x</span> <span class="o">=</span> <span class="n">sum_x_pref</span> <span class="o">+</span> <span class="n">xd</span>
                <span class="c1"># Additional check: resulting x_B entries should be nonnegative integers: (rvec[i] - md_i*xd) % D == 0 and  0</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">rvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">mj</span><span class="p">[</span><span class="n">last</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">xd</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">%</span> <span class="n">Dabs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">total</span> <span class="o">=</span> <span class="n">total_presses</span><span class="p">(</span><span class="n">sum_M</span><span class="p">,</span> <span class="n">sum_x</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">total</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">):</span>
                    <span class="n">best</span> <span class="o">=</span> <span class="n">total</span>

    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">try_with_prefix</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">best</span> <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>

    <span class="c1"># d &gt;= 2: loop over first d-1 variables with bounds and simple pruning by objective</span>
    <span class="c1"># Determine iteration order: sort variables by slope to prefer negative slope later as last var to exploit boundaries</span>
    <span class="c1"># We&#39;ll keep last var as index d-1 already; assume that&#39;s with potentially largest effect; We can permute F columns to put most impactful as last</span>
    <span class="c1"># Find index with maximal |1 - sum_mj/D| negativity</span>
    <span class="n">slopes</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">Fraction</span><span class="p">(</span><span class="n">sum_mj</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">Dabs</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
    <span class="c1"># choose last as one with most negative slope; swap columns accordingly</span>
    <span class="n">last_idx</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="p">(</span><span class="n">slopes</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="o">-</span><span class="n">sum_mj</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">last_idx</span> <span class="o">!=</span> <span class="n">d</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># swap columns in mj, sum_mj, ub, and M columns</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">last_idx</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">d</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">d</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">last_idx</span><span class="p">]</span>
        <span class="n">mj</span><span class="p">[</span><span class="n">last_idx</span><span class="p">],</span> <span class="n">mj</span><span class="p">[</span><span class="n">d</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mj</span><span class="p">[</span><span class="n">d</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mj</span><span class="p">[</span><span class="n">last_idx</span><span class="p">]</span>
        <span class="n">sum_mj</span><span class="p">[</span><span class="n">last_idx</span><span class="p">],</span> <span class="n">sum_mj</span><span class="p">[</span><span class="n">d</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_mj</span><span class="p">[</span><span class="n">d</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">sum_mj</span><span class="p">[</span><span class="n">last_idx</span><span class="p">]</span>
        <span class="n">ub</span><span class="p">[</span><span class="n">last_idx</span><span class="p">],</span> <span class="n">ub</span><span class="p">[</span><span class="n">d</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="n">d</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ub</span><span class="p">[</span><span class="n">last_idx</span><span class="p">]</span>
    <span class="c1"># Prepare recursive loops</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">x0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">try_with_prefix</span><span class="p">([</span><span class="n">x0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">best</span> <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="c1"># Precompute quick bounds to prune: compute minimal possible total presses lower bound using sum target and max coverage; But we can compute dynamic per prefix later.</span>
        <span class="k">for</span> <span class="n">x0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># update b0 for prefix partially to compute ub for next var quickly? We&#39;ll keep using combine_for_last which recomputes.</span>
            <span class="c1"># Optionally, prune by minimal objective possible with remaining variables: Use that sum_MxF increases with presses by at most sum_mj; Hard.</span>
            <span class="k">for</span> <span class="n">x1</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ub</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">try_with_prefix</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">best</span> <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># d &gt; 3 shouldn&#39;t happen with m&lt;=13,k&lt;=10 -&gt; d&lt;=3 likely, but handle generically by recursion with modulus on last</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">rec</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">d</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">try_with_prefix</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ub</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">prefix</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">rec</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">prefix</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">rec</span><span class="p">([],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best</span> <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">ans</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="rank_statspy"> rank_stats.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T09:58:42.435721</li>
<li><strong>Duration</strong>: 0.18s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout_7">Stdout</h3>
<div class="highlight"><pre><span></span><code>nullity distribution: {0: 81, 1: 36, 2: 32, 3: 8}
max nullity 3
</code></pre></div>
<h3 id="code_21">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># build matrix k x m</span>
    <span class="n">mcols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">)):</span>
        <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">mcols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="n">col</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">mcols</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">A</span>

<span class="k">def</span><span class="w"> </span><span class="nf">rank</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">r</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">==</span><span class="n">k</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">r</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">ds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">k</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">rank</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;nullity distribution:&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">items</span><span class="p">())))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;max nullity&#39;</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">ds</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_ida3py"> solve_day10_part2_ida3.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T10:01:32.060369</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_22">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># discard columns that touch zero-target counters (can&#39;t press them at all)</span>
    <span class="n">zero_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">zero_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">zero_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="c1"># dedup</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span>


<span class="k">def</span><span class="w"> </span><span class="nf">components</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="c1"># active counters (t&gt;0)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">find</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="n">x</span><span class="p">:</span>
            <span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">union</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
        <span class="n">ra</span><span class="p">,</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ra</span> <span class="o">!=</span> <span class="n">rb</span><span class="p">:</span>
            <span class="n">parent</span><span class="p">[</span><span class="n">rb</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra</span>

    <span class="c1"># Union counters that appear together in a column</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">((</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">union</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
    <span class="n">comp_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">active</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">comp_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">comps</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">comp_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">node_mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">node_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">comp_cols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">node_mask</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">&amp;</span> <span class="n">node_mask</span><span class="p">:</span>
                <span class="n">comp_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="n">comps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nodes</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">comp_cols</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">comps</span>


<span class="k">def</span><span class="w"> </span><span class="nf">greedy_upper_bound_local</span><span class="p">(</span><span class="n">T</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols_local</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
    <span class="n">rem</span> <span class="o">=</span> <span class="n">T</span><span class="p">[:]</span>
    <span class="n">pos_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rem</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pos_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pos_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Precompute coverers per i</span>
    <span class="n">coverers</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols_local</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">coverers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="n">presses</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">pos_mask</span><span class="p">:</span>
        <span class="c1"># i with max rem</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pos_mask</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">best_i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">best_v</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">while</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_v</span><span class="p">:</span>
                    <span class="n">best_v</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">best_i</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># choose j covering i with maximum coverage on pos</span>
        <span class="n">best_j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_cov</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">coverers</span><span class="p">[</span><span class="n">best_i</span><span class="p">]:</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="n">cols_local</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm</span> <span class="o">&amp;</span> <span class="n">pos_mask</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cov</span> <span class="o">&gt;</span> <span class="n">best_cov</span><span class="p">:</span>
                <span class="n">best_cov</span> <span class="o">=</span> <span class="n">cov</span>
                <span class="n">best_j</span> <span class="o">=</span> <span class="n">j</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">cols_local</span><span class="p">[</span><span class="n">best_j</span><span class="p">]</span>
        <span class="c1"># apply once</span>
        <span class="n">mm</span> <span class="o">=</span> <span class="n">cm</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">clear</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">mm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mm</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">clear</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ii</span><span class="p">)</span>
            <span class="n">mm</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">ii</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">pos_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">clear</span>
        <span class="n">presses</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">presses</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_component</span><span class="p">(</span><span class="n">T_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols_all</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="c1"># Remap rows and columns to local indices</span>
    <span class="n">idx_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nodes</span><span class="p">)}</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="p">[</span><span class="n">T_all</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols_all</span><span class="p">:</span>
        <span class="n">lm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">old_i</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">old_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">lm</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx_map</span><span class="p">[</span><span class="n">old_i</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">lm</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lm</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">))</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="c1"># Quick infeasibility</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(((</span><span class="n">cm</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible row in component&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Precompute contrib per column for updating sums</span>
    <span class="n">full</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span>
    <span class="n">contrib</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm</span> <span class="o">&amp;</span> <span class="n">S</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cm</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">contrib</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
    <span class="c1"># Precompute for each pos_mask: allowed columns, max_cov, cap_map and cover_count per row</span>
    <span class="n">allowed</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">full</span><span class="p">)]</span>
    <span class="n">allowed_masks</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">full</span><span class="p">)]</span>
    <span class="n">max_cov</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
    <span class="n">cover_count</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">k</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">full</span><span class="p">)]</span>
    <span class="n">cap_map</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">full</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">pm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">full</span><span class="p">):</span>
        <span class="c1"># allowed cols are those subset of pm</span>
        <span class="n">a_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">a_masks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cc_row</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">k</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">cm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cm</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">pm</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">a_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="n">a_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cm</span><span class="p">)</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="n">mc</span><span class="p">:</span>
                    <span class="n">mc</span> <span class="o">=</span> <span class="n">w</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cm</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">cc_row</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">allowed</span><span class="p">[</span><span class="n">pm</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_list</span>
        <span class="n">allowed_masks</span><span class="p">[</span><span class="n">pm</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_masks</span>
        <span class="n">max_cov</span><span class="p">[</span><span class="n">pm</span><span class="p">]</span> <span class="o">=</span> <span class="n">mc</span>
        <span class="n">cover_count</span><span class="p">[</span><span class="n">pm</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc_row</span>
        <span class="c1"># Precompute cap for all S subset pm</span>
        <span class="n">cap_d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">pm</span>
        <span class="k">while</span> <span class="n">sub</span><span class="p">:</span>
            <span class="n">cap</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="n">a_masks</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">cm</span> <span class="o">&amp;</span> <span class="n">sub</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">cap</span><span class="p">:</span>
                    <span class="n">cap</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">if</span> <span class="n">cap</span> <span class="o">==</span> <span class="n">sub</span><span class="o">.</span><span class="n">bit_count</span><span class="p">():</span>
                        <span class="k">break</span>
            <span class="n">cap_d</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span> <span class="o">=</span> <span class="n">cap</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pm</span>
        <span class="n">cap_map</span><span class="p">[</span><span class="n">pm</span><span class="p">]</span> <span class="o">=</span> <span class="n">cap_d</span>
    <span class="c1"># initial sums array</span>
    <span class="n">sums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
    <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">S</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">sums</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
    <span class="c1"># UB via greedy</span>
    <span class="n">ub</span> <span class="o">=</span> <span class="n">greedy_upper_bound_local</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>

    <span class="n">rem</span> <span class="o">=</span> <span class="n">T</span><span class="p">[:]</span>
    <span class="n">pos_mask_box</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rem</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_press</span><span class="p">(</span><span class="n">j</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="c1"># apply pressing column j times</span>
        <span class="k">if</span> <span class="n">times</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">contrib</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># update sums</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
            <span class="n">sums</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">-=</span> <span class="n">times</span> <span class="o">*</span> <span class="n">arr</span><span class="p">[</span><span class="n">S</span><span class="p">]</span>
        <span class="c1"># update rem and pos_mask</span>
        <span class="n">clear</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
            <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">times</span>
            <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">clear</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">clear</span>
        <span class="k">return</span> <span class="n">times</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">undo_press</span><span class="p">(</span><span class="n">j</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">times</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">cm</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">contrib</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># restore sums</span>
        <span class="k">for</span> <span class="n">S</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
            <span class="n">sums</span><span class="p">[</span><span class="n">S</span><span class="p">]</span> <span class="o">+=</span> <span class="n">times</span> <span class="o">*</span> <span class="n">arr</span><span class="p">[</span><span class="n">S</span><span class="p">]</span>
        <span class="c1"># restore rem and pos_mask</span>
        <span class="n">setmask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">setmask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">times</span>
        <span class="c1"># recompute bits that should be set: if after adding, value&gt;0, set bit</span>
        <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">setmask</span>

    <span class="c1"># Forced reduction</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">reduce_forced</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">presses_acc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">pm</span> <span class="o">=</span> <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">presses_acc</span>
            <span class="c1"># infeasible check: any row with cover_count 0</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">cover_count</span><span class="p">[</span><span class="n">pm</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">pm</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">presses_acc</span>
            <span class="c1"># find unique rows</span>
            <span class="n">unique_rows</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># column j -&gt; list of rows for which it&#39;s unique</span>
            <span class="n">any_unique</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">pm</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">any_unique</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># find that column</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">[</span><span class="n">pm</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">unique_rows</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">any_unique</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">presses_acc</span>
            <span class="c1"># For each column with unique rows, enforce equal rem and press that many</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">unique_rows</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">req</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">presses_acc</span>
                <span class="k">if</span> <span class="n">req</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">apply_press</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
                    <span class="n">presses_acc</span> <span class="o">+=</span> <span class="n">req</span>

    <span class="c1"># Lower bound for current state</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lower_bound</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># subset bound: iterate submasks of pm</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">pm</span>
        <span class="n">cap_d</span> <span class="o">=</span> <span class="n">cap_map</span><span class="p">[</span><span class="n">pm</span><span class="p">]</span>
        <span class="k">while</span> <span class="n">sub</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">sums</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cap</span> <span class="o">=</span> <span class="n">cap_d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">cap</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">cap</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">lb</span><span class="p">:</span>
                    <span class="n">lb</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pm</span>
        <span class="c1"># sum bound by max_cov</span>
        <span class="n">mc</span> <span class="o">=</span> <span class="n">max_cov</span><span class="p">[</span><span class="n">pm</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">tot</span> <span class="o">=</span> <span class="n">sums</span><span class="p">[</span><span class="n">pm</span><span class="p">]</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="p">(</span><span class="n">tot</span> <span class="o">+</span> <span class="n">mc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">mc</span>
            <span class="k">if</span> <span class="n">v2</span> <span class="o">&gt;</span> <span class="n">lb</span><span class="p">:</span>
                <span class="n">lb</span> <span class="o">=</span> <span class="n">v2</span>
        <span class="c1"># per-row bound</span>
        <span class="c1"># lb = max(lb, max rem)</span>
        <span class="c1"># Faster to compute from rem list</span>
        <span class="n">maxr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">pm</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxr</span><span class="p">:</span>
                    <span class="n">maxr</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">t</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">maxr</span> <span class="o">&gt;</span> <span class="n">lb</span><span class="p">:</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">maxr</span>
        <span class="k">return</span> <span class="n">lb</span>

    <span class="c1"># Search</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">ub</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">g</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">bound</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">nonlocal</span> <span class="n">best</span>
        <span class="n">ok</span><span class="p">,</span> <span class="n">forced_p</span> <span class="o">=</span> <span class="n">reduce_forced</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="c1"># undo forced presses before returning: But we can&#39;t undo because we didn&#39;t record per-step. Instead, we apply reduce_forced then immediately undo after recursive returns.</span>
            <span class="c1"># To support undo, we need to record the sequence. We&#39;ll adapt: replace reduce_forced to produce a stack of (j, times) moves applied.</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;reduce_forced called in wrong context&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># found at depth g + forced_p, but caller will add forced_p externally</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">lower_bound</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="n">h</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">bound</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="c1"># pick pivot i with largest rem</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">best_i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_v</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">tbits</span> <span class="o">=</span> <span class="n">pm</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">tbits</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tbits</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best_v</span><span class="p">:</span>
                    <span class="n">best_v</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">best_i</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">tbits</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># build candidates: allowed columns covering i, sort by coverage descending</span>
        <span class="n">cand</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">[</span><span class="n">pm</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">best_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">pm</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
                <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">cov</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
        <span class="n">cand</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">best_next</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cand</span><span class="p">:</span>
            <span class="n">apply_press</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bound</span><span class="p">)</span>
            <span class="n">undo_press</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">best_next</span><span class="p">:</span>
                <span class="n">best_next</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">return</span> <span class="n">best_next</span>

    <span class="c1"># We need a version of dfs that tracks and undoes forced presses</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dfs_with_forced</span><span class="p">(</span><span class="n">g</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">bound</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="c1"># Apply forced moves, recording them</span>
        <span class="n">forced_moves</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">pm</span> <span class="o">=</span> <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">g</span> <span class="o">&lt;=</span> <span class="n">bound</span> <span class="k">else</span> <span class="n">g</span>
                <span class="c1"># undo forced</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">times</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">forced_moves</span><span class="p">):</span>
                    <span class="n">undo_press</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">cc</span> <span class="o">=</span> <span class="n">cover_count</span><span class="p">[</span><span class="n">pm</span><span class="p">]</span>
            <span class="c1"># infeasible</span>
            <span class="n">infeas</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">pm</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">infeas</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">infeas</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">times</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">forced_moves</span><span class="p">):</span>
                    <span class="n">undo_press</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
            <span class="c1"># unique</span>
            <span class="n">unique_rows</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">any_unique</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">pm</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">any_unique</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">[</span><span class="n">pm</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">unique_rows</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">any_unique</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">unique_rows</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">req</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="n">rows</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="k">if</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">req</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">times</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">forced_moves</span><span class="p">):</span>
                            <span class="n">undo_press</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
                        <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
                <span class="k">if</span> <span class="n">req</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">apply_press</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">req</span><span class="p">)</span>
                    <span class="n">forced_moves</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="n">req</span><span class="p">))</span>
                    <span class="n">g</span> <span class="o">+=</span> <span class="n">req</span>
        <span class="c1"># bound check</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">lower_bound</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="n">h</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">bound</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">times</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">forced_moves</span><span class="p">):</span>
                <span class="n">undo_press</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="c1"># choose pivot and recurse</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="n">pos_mask_box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># if goal reached after forced moves</span>
        <span class="k">if</span> <span class="n">pm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">times</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">forced_moves</span><span class="p">):</span>
                <span class="n">undo_press</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># pivot row i with largest rem</span>
        <span class="n">best_i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_v</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">tbits</span> <span class="o">=</span> <span class="n">pm</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">tbits</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tbits</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best_v</span><span class="p">:</span>
                    <span class="n">best_v</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="n">best_i</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">tbits</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># candidate columns</span>
        <span class="n">cand</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">[</span><span class="n">pm</span><span class="p">]:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">best_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">pm</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
                <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">cov</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
        <span class="n">cand</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">best_next</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cand</span><span class="p">:</span>
            <span class="n">apply_press</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">dfs_with_forced</span><span class="p">(</span><span class="n">g</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bound</span><span class="p">)</span>
            <span class="n">undo_press</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">times</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">forced_moves</span><span class="p">):</span>
                    <span class="n">undo_press</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">best_next</span><span class="p">:</span>
                <span class="n">best_next</span> <span class="o">=</span> <span class="n">t</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">times</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">forced_moves</span><span class="p">):</span>
            <span class="n">undo_press</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">times</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">best_next</span>

    <span class="n">bound</span> <span class="o">=</span> <span class="n">ub</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">dfs_with_forced</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">bound</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bound</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">8</span><span class="p">:</span>
            <span class="c1"># fallback to greedy</span>
            <span class="k">return</span> <span class="n">bound</span>
        <span class="n">bound</span> <span class="o">=</span> <span class="n">res</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">comps</span> <span class="o">=</span> <span class="n">components</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">comps</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">comp_cols</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">solve_component</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">comp_cols</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">total</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_finalpy"> solve_day10_part2_final.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T10:04:03.630467</li>
<li><strong>Duration</strong>: 0.73s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout_8">Stdout</h3>
<div class="highlight"><pre><span></span><code>25000012092
</code></pre></div>
<h3 id="code_23">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># Remove columns that touch zero-target counters (can&#39;t press them at all)</span>
    <span class="n">zero_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">zero_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">zero_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Keep only active rows and remap columns to active rows</span>
    <span class="n">active_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">active_rows</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">new_targets</span> <span class="o">=</span> <span class="p">[</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">active_rows</span><span class="p">]</span>
    <span class="n">remapped_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">new_i</span><span class="p">,</span> <span class="n">old_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">active_rows</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">old_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nm</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">new_i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nm</span><span class="p">:</span>
            <span class="n">remapped_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
    <span class="c1"># Deduplicate</span>
    <span class="n">remapped_cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">remapped_cols</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">new_targets</span><span class="p">,</span> <span class="n">remapped_cols</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_matrix</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">m</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rank_and_pivots</span><span class="p">(</span><span class="n">A</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="c1"># Gaussian elimination over rationals to obtain pivot rows and columns</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="n">row_perm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="n">piv_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">piv_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">row_perm</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">row_perm</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_perm</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">row_perm</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="c1"># normalize and eliminate</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">pv</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">r</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">piv_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_perm</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="n">piv_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">piv_rows</span><span class="p">),</span> <span class="n">piv_cols</span>


<span class="k">def</span><span class="w"> </span><span class="nf">det_and_adj</span><span class="p">(</span><span class="n">B</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]]]:</span>
    <span class="c1"># Compute determinant and adjugate using exact fractions</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">inv</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="n">inv</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">inv</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">inv</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="n">sign</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="n">det</span> <span class="o">*=</span> <span class="n">pv</span>
        <span class="n">inv_pv</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">pv</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv_pv</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">inv</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv_pv</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">inv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">inv</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">det</span> <span class="o">*</span> <span class="n">sign</span>
    <span class="c1"># adjugate = det * inverse</span>
    <span class="n">adj</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">((</span><span class="n">det</span> <span class="o">*</span> <span class="n">inv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">numerator</span> <span class="o">//</span> <span class="p">(</span><span class="n">det</span> <span class="o">*</span> <span class="n">inv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">dnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">det</span><span class="o">.</span><span class="n">numerator</span> <span class="o">//</span> <span class="n">det</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dnum</span><span class="p">,</span> <span class="n">adj</span>


<span class="k">def</span><span class="w"> </span><span class="nf">egcd</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">g</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">egcd</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">%</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">x1</span> <span class="o">-</span> <span class="p">(</span><span class="n">a</span> <span class="o">//</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">y1</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_linear_congruence</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
    <span class="c1"># Solve a x  b (mod m). Returns (x0, mod&#39;) meaning x  x0 (mod mod&#39;), where mod&#39; = m/g</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">%</span> <span class="n">m</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">%</span> <span class="n">m</span>
    <span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">egcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">b</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="n">a</span> <span class="o">//</span> <span class="n">g</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="n">b</span> <span class="o">//</span> <span class="n">g</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="n">m</span> <span class="o">//</span> <span class="n">g</span>
    <span class="c1"># inverse of a1 modulo m1</span>
    <span class="n">inv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">a1</span> <span class="o">%</span> <span class="n">m1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">b1</span> <span class="o">*</span> <span class="n">inv</span><span class="p">)</span> <span class="o">%</span> <span class="n">m1</span>
    <span class="k">return</span> <span class="n">x0</span><span class="p">,</span> <span class="n">m1</span>


<span class="k">def</span><span class="w"> </span><span class="nf">crt_merge</span><span class="p">(</span><span class="n">x1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">m1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">x2</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">m2</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
    <span class="c1"># Merge x  x1 mod m1 and x  x2 mod m2</span>
    <span class="k">if</span> <span class="n">m1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">m2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">g</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">egcd</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">lcm</span> <span class="o">=</span> <span class="n">m1</span> <span class="o">//</span> <span class="n">g</span> <span class="o">*</span> <span class="n">m2</span>
    <span class="n">k</span> <span class="o">=</span> <span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">//</span> <span class="n">g</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m2</span> <span class="o">//</span> <span class="n">g</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">m1</span> <span class="o">*</span> <span class="p">((</span><span class="n">s</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m2</span> <span class="o">//</span> <span class="n">g</span><span class="p">)))</span> <span class="o">%</span> <span class="n">lcm</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">lcm</span>


<span class="k">def</span><span class="w"> </span><span class="nf">ceil_div</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="p">((</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">//</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="p">((</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">//</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">floor_div</span><span class="p">(</span><span class="n">a</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">assert</span> <span class="n">b</span> <span class="o">!=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">//</span> <span class="n">b</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">targets</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Build A</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">build_matrix</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible: no usable buttons for positive targets&#39;</span><span class="p">)</span>
    <span class="c1"># Quick infeasibility: any row with no 1s</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible row&#39;</span><span class="p">)</span>
    <span class="c1"># Rank and pivot rows/cols</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">piv_rows_sorted</span><span class="p">,</span> <span class="n">piv_cols_any</span> <span class="o">=</span> <span class="n">rank_and_pivots</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="c1"># Select r independent rows R (we have pivot rows sorted) and search for best column subset C (size r) minimizing |det|</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">piv_rows_sorted</span>
    <span class="c1"># Enumerate combinations of columns of size r to find invertible B with minimal |det|</span>
    <span class="n">best_det</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_C</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_adj</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">r</span><span class="p">):</span>
        <span class="c1"># build B = A[R, C]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">C</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
        <span class="n">dnum</span><span class="p">,</span> <span class="n">adj</span> <span class="o">=</span> <span class="n">det_and_adj</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ad</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dnum</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">best_det</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ad</span> <span class="o">&lt;</span> <span class="n">best_det</span><span class="p">:</span>
            <span class="n">best_det</span> <span class="o">=</span> <span class="n">ad</span>
            <span class="n">best_C</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
            <span class="c1"># Normalize adj to match Dabs positive</span>
            <span class="n">sgn</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">dnum</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">sgn</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">adj</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">adj</span><span class="p">]</span>
            <span class="n">best_adj</span> <span class="o">=</span> <span class="n">adj</span>
            <span class="k">if</span> <span class="n">ad</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">if</span> <span class="n">best_C</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No invertible basis found&#39;</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">best_det</span>  <span class="c1"># positive</span>
    <span class="n">adj</span> <span class="o">=</span> <span class="n">best_adj</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">best_C</span>
    <span class="c1"># Free columns F</span>
    <span class="n">F</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">C</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="c1"># Build A_F_R and b0</span>
    <span class="n">t_R</span> <span class="o">=</span> <span class="p">[</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="c1"># b0 = adj * t_R</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">adj</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">t_R</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
    <span class="c1"># M = adj * A_F_R</span>
    <span class="n">A_F_R</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">F</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">sum</span><span class="p">(</span><span class="n">adj</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">]</span> <span class="o">*</span> <span class="n">A_F_R</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
    <span class="c1"># Helper to compute objective</span>
    <span class="n">sum_b0</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">b0</span><span class="p">)</span>
    <span class="n">sum_M_col</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
    <span class="c1"># Function to compute total presses given xF tuple</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_presses</span><span class="p">(</span><span class="n">xF</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="c1"># compute numerator for x_B: b0 - M xF</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">b0</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">xF</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">xF</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># check divisibility and nonnegativity</span>
        <span class="n">sumb</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">sumb</span> <span class="o">+=</span> <span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">D</span>
        <span class="k">return</span> <span class="n">sumb</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xF</span><span class="p">)</span>
    <span class="c1"># d cases</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No integer nonnegative solution for unique case&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="c1"># Precompute bounds for each free var individually: upper bound from rows where M_ij &gt; 0</span>
    <span class="n">ub</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span>
    <span class="n">lb</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ub</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">a</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># gives lower bound: a x_j &lt;= b0_i =&gt; x_j &gt;= ceil((b0_i - other terms)/a). Without other terms, we can only say x_j &gt;= ceil(b0_i / a), but since a&lt;0, this may be &lt;=0</span>
                <span class="n">lb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">ceil_div</span><span class="p">(</span><span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">a</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ub</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">:</span>
            <span class="c1"># no positive coefficients -&gt; set some cap from objective? keep large, but we will constrain via other rows and integrality when computing</span>
            <span class="n">ub</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span>
        <span class="k">if</span> <span class="n">lb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># d == 1</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># but M has r rows; use general</span>
        <span class="c1"># Solve congruences M_i0 * s  b0_i (mod D) for all i</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mod0</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">Ai</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">bi</span> <span class="o">=</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">Ai</span> <span class="o">%</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bi</span> <span class="o">%</span> <span class="n">D</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>  <span class="c1"># infeasible; shouldn&#39;t happen</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_linear_congruence</span><span class="p">(</span><span class="n">Ai</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
            <span class="n">xi</span><span class="p">,</span> <span class="n">mi</span> <span class="o">=</span> <span class="n">sol</span>
            <span class="n">merged</span> <span class="o">=</span> <span class="n">crt_merge</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">mod0</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">mi</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">merged</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">mod0</span> <span class="o">=</span> <span class="n">merged</span>
        <span class="c1"># bounds for s</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">hi</span> <span class="o">&lt;</span> <span class="n">lo</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="c1"># find minimal feasible s &gt;= lo congruent to x0 mod mod0</span>
        <span class="k">if</span> <span class="n">mod0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="c1"># adjust to residue class</span>
        <span class="n">rem</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">lo</span><span class="p">)</span> <span class="o">%</span> <span class="n">mod0</span>
        <span class="n">s_min</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">+</span> <span class="n">rem</span>
        <span class="c1"># For objective, slope = 1 - sum_M_col[0] / D</span>
        <span class="c1"># Choose endpoint accordingly</span>
        <span class="c1"># Ensure s within [lo, hi]</span>
        <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">s_min</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">:</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_min</span><span class="p">)</span>
        <span class="c1"># maximal congruent &lt;= hi</span>
        <span class="n">kmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">//</span> <span class="n">mod0</span>
        <span class="n">s_max</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">kmax</span> <span class="o">*</span> <span class="n">mod0</span>
        <span class="k">if</span> <span class="n">s_max</span> <span class="o">&gt;=</span> <span class="n">lo</span> <span class="ow">and</span> <span class="n">s_max</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span> <span class="ow">or</span> <span class="n">s_max</span> <span class="o">!=</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s_max</span><span class="p">)</span>
        <span class="c1"># Also maybe try one more near optimum if slope ~ 0? But endpoints suffice due to linearity and convex feasible set along congruence arithmetic progression.</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">total_presses</span><span class="p">([</span><span class="n">s</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                    <span class="n">best</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="k">return</span> <span class="n">best</span>

    <span class="c1"># d == 2</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># Handle s variable index 0 and t index 1</span>
        <span class="c1"># Compute congruence for s from rows where M_i2 == 0</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mod0</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">lo_s</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">hi_s</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">A10</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">A20</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">bi</span> <span class="o">=</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">A20</span> <span class="o">%</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># constraint A10*s  bi (mod D)</span>
                <span class="k">if</span> <span class="n">A10</span> <span class="o">%</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">bi</span> <span class="o">%</span> <span class="n">D</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_linear_congruence</span><span class="p">(</span><span class="n">A10</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
                <span class="n">xi</span><span class="p">,</span> <span class="n">mi</span> <span class="o">=</span> <span class="n">sol</span>
                <span class="n">merged</span> <span class="o">=</span> <span class="n">crt_merge</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">mod0</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">mi</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">merged</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
                <span class="n">x0</span><span class="p">,</span> <span class="n">mod0</span> <span class="o">=</span> <span class="n">merged</span>
                <span class="c1"># inequality bound for s: A10 * s &lt;= bi if A10&gt;0; for A10&lt;0 -&gt; s &gt;= ceil(bi / A10)</span>
                <span class="k">if</span> <span class="n">A10</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">hi_s</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi_s</span><span class="p">,</span> <span class="n">bi</span> <span class="o">//</span> <span class="n">A10</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">A10</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lo_s</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo_s</span><span class="p">,</span> <span class="n">ceil_div</span><span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="n">A10</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">hi_s</span> <span class="o">&lt;</span> <span class="n">lo_s</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="k">if</span> <span class="n">mod0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="c1"># Iterate s in arithmetic progression within [lo_s, hi_s]</span>
        <span class="n">start_rem</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">lo_s</span><span class="p">)</span> <span class="o">%</span> <span class="n">mod0</span>
        <span class="n">s_start</span> <span class="o">=</span> <span class="n">lo_s</span> <span class="o">+</span> <span class="n">start_rem</span>
        <span class="k">if</span> <span class="n">s_start</span> <span class="o">&gt;</span> <span class="n">hi_s</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Precompute rows classification for t bounds</span>
        <span class="c1"># For each s, build congruence for t across rows with A20 != 0</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s_start</span><span class="p">,</span> <span class="n">hi_s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mod0</span><span class="p">):</span>
            <span class="c1"># Compute t congruence</span>
            <span class="n">t_x</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">t_mod</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">lo_t</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">hi_t</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">feasible</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">A10</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">A20</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">bi</span> <span class="o">=</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">A20</span> <span class="o">%</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># already enforced</span>
                    <span class="c1"># check inequality A10*s &lt;= bi if A10&gt;0 else lower bound</span>
                    <span class="k">if</span> <span class="n">A10</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">A10</span> <span class="o">*</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="n">bi</span><span class="p">:</span>
                        <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">A10</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">lo_t</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># nothing more here; s was bounded earlier</span>
                    <span class="k">continue</span>
                <span class="c1"># Solve A20 * t  bi - A10*s (mod D)</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="p">(</span><span class="n">bi</span> <span class="o">-</span> <span class="n">A10</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="o">%</span> <span class="n">D</span>
                <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_linear_congruence</span><span class="p">(</span><span class="n">A20</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="n">xi</span><span class="p">,</span> <span class="n">mi</span> <span class="o">=</span> <span class="n">sol</span>
                <span class="n">merged</span> <span class="o">=</span> <span class="n">crt_merge</span><span class="p">(</span><span class="n">t_x</span><span class="p">,</span> <span class="n">t_mod</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">mi</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">merged</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="n">t_x</span><span class="p">,</span> <span class="n">t_mod</span> <span class="o">=</span> <span class="n">merged</span>
                <span class="c1"># inequality for t: if A20&gt;0 -&gt; t &lt;= floor((bi - A10*s)/A20); if A20&lt;0 -&gt; t &gt;= ceil((bi - A10*s)/A20)</span>
                <span class="k">if</span> <span class="n">A20</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">hi_t</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi_t</span><span class="p">,</span> <span class="p">(</span><span class="n">bi</span> <span class="o">-</span> <span class="n">A10</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="o">//</span> <span class="n">A20</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">A20</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lo_t</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo_t</span><span class="p">,</span> <span class="n">ceil_div</span><span class="p">(</span><span class="n">bi</span> <span class="o">-</span> <span class="n">A10</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">A20</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">feasible</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">hi_t</span> <span class="o">&lt;</span> <span class="n">lo_t</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">t_mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># choose t to minimize total presses; Since objective linear in t, endpoints suffice</span>
            <span class="c1"># Find minimal &gt;= lo_t congruent</span>
            <span class="n">rem</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_x</span> <span class="o">-</span> <span class="n">lo_t</span><span class="p">)</span> <span class="o">%</span> <span class="n">t_mod</span>
            <span class="n">t_min</span> <span class="o">=</span> <span class="n">lo_t</span> <span class="o">+</span> <span class="n">rem</span>
            <span class="n">cand</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">t_min</span> <span class="o">&lt;=</span> <span class="n">hi_t</span><span class="p">:</span>
                <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_min</span><span class="p">)</span>
            <span class="c1"># maximal &lt;= hi_t congruent</span>
            <span class="n">kmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi_t</span> <span class="o">-</span> <span class="n">t_x</span><span class="p">)</span> <span class="o">//</span> <span class="n">t_mod</span>
            <span class="n">t_max</span> <span class="o">=</span> <span class="n">t_x</span> <span class="o">+</span> <span class="n">kmax</span> <span class="o">*</span> <span class="n">t_mod</span>
            <span class="k">if</span> <span class="n">t_max</span> <span class="o">&gt;=</span> <span class="n">lo_t</span> <span class="ow">and</span> <span class="n">t_max</span> <span class="o">&lt;=</span> <span class="n">hi_t</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cand</span> <span class="ow">or</span> <span class="n">t_max</span> <span class="o">!=</span> <span class="n">cand</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_max</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cand</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">total_presses</span><span class="p">([</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                        <span class="n">best</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="k">return</span> <span class="n">best</span>

    <span class="c1"># d &gt;= 3 (rare per stats: &lt;= 8 cases). We&#39;ll do nested loops on first d-2 vars within bounds and congruences for rows where last two vars coefficients share structured constraints, then reduce to d=2 per iteration.</span>
    <span class="c1"># To keep runtime safe, cap search ranges using bounds.</span>
    <span class="c1"># Choose order by increasing ub to minimize loops</span>
    <span class="n">order</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">ub</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="c1"># We&#39;ll loop for first d-2 variables small range; For each assignment, reduce to d=2 on the last two variables using the above logic.</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reduce_to_two</span><span class="p">(</span><span class="n">assign</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="c1"># assign list contains (var_index, value) for some vars</span>
        <span class="c1"># Build reduced b0&#39; and M&#39; by subtracting contributions of assigned vars</span>
        <span class="n">used</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span><span class="o">*</span><span class="n">d</span>
        <span class="n">x_vals</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">d</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">assign</span><span class="p">:</span>
            <span class="n">used</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">x_vals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">b0</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">used</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">x_vals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                    <span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_vals</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># Check early if any num[i] &lt; 0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># Collect remaining two variables indices</span>
        <span class="n">rem_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">used</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rem_vars</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># should not happen</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">j1</span><span class="p">,</span> <span class="n">j2</span> <span class="o">=</span> <span class="n">rem_vars</span>
        <span class="c1"># Build new M2: r x 2</span>
        <span class="n">M2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j1</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j2</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
        <span class="c1"># Solve d=2 subproblem with b0&#39; = num and objective includes current assigned sum</span>
        <span class="c1"># We&#39;ll reuse logic of d==2 using local variables</span>
        <span class="c1"># Compute bounds for s (var j1)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mod0</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">lo_s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hi_s</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="c1"># incorporate individual bounds from previous ub/lb for j1</span>
        <span class="n">lo_s</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo_s</span><span class="p">,</span> <span class="n">lb</span><span class="p">[</span><span class="n">j1</span><span class="p">])</span>
        <span class="n">hi_s</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi_s</span><span class="p">,</span> <span class="n">ub</span><span class="p">[</span><span class="n">j1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">A10</span> <span class="o">=</span> <span class="n">M2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">A20</span> <span class="o">=</span> <span class="n">M2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">bi</span> <span class="o">=</span> <span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">A20</span> <span class="o">%</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">A10</span> <span class="o">%</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">bi</span> <span class="o">%</span> <span class="n">D</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_linear_congruence</span><span class="p">(</span><span class="n">A10</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="n">xi</span><span class="p">,</span> <span class="n">mi</span> <span class="o">=</span> <span class="n">sol</span>
                    <span class="n">merged</span> <span class="o">=</span> <span class="n">crt_merge</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">mod0</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">mi</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">merged</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="n">x0</span><span class="p">,</span> <span class="n">mod0</span> <span class="o">=</span> <span class="n">merged</span>
                <span class="k">if</span> <span class="n">A10</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">hi_s</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi_s</span><span class="p">,</span> <span class="n">bi</span> <span class="o">//</span> <span class="n">A10</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">A10</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lo_s</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo_s</span><span class="p">,</span> <span class="n">ceil_div</span><span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="n">A10</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">hi_s</span> <span class="o">&lt;</span> <span class="n">lo_s</span> <span class="ow">or</span> <span class="n">mod0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">start_rem</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">lo_s</span><span class="p">)</span> <span class="o">%</span> <span class="n">mod0</span>
        <span class="n">s_start</span> <span class="o">=</span> <span class="n">lo_s</span> <span class="o">+</span> <span class="n">start_rem</span>
        <span class="k">if</span> <span class="n">s_start</span> <span class="o">&gt;</span> <span class="n">hi_s</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">best_local</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s_start</span><span class="p">,</span> <span class="n">hi_s</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">mod0</span><span class="p">):</span>
            <span class="n">t_x</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">t_mod</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">lo_t</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lb</span><span class="p">[</span><span class="n">j2</span><span class="p">])</span>
            <span class="n">hi_t</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">j2</span><span class="p">],</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">feas</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">A10</span> <span class="o">=</span> <span class="n">M2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">A20</span> <span class="o">=</span> <span class="n">M2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">bi</span> <span class="o">=</span> <span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">A20</span> <span class="o">%</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">A10</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">A10</span> <span class="o">*</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="n">bi</span><span class="p">:</span>
                        <span class="n">feas</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">A10</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">lo_t</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="p">(</span><span class="n">bi</span> <span class="o">-</span> <span class="n">A10</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="o">%</span> <span class="n">D</span>
                <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_linear_congruence</span><span class="p">(</span><span class="n">A20</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">feas</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="n">xi</span><span class="p">,</span> <span class="n">mi</span> <span class="o">=</span> <span class="n">sol</span>
                <span class="n">merged</span> <span class="o">=</span> <span class="n">crt_merge</span><span class="p">(</span><span class="n">t_x</span><span class="p">,</span> <span class="n">t_mod</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">mi</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">merged</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">feas</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="n">t_x</span><span class="p">,</span> <span class="n">t_mod</span> <span class="o">=</span> <span class="n">merged</span>
                <span class="k">if</span> <span class="n">A20</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">hi_t</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi_t</span><span class="p">,</span> <span class="p">(</span><span class="n">bi</span> <span class="o">-</span> <span class="n">A10</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span> <span class="o">//</span> <span class="n">A20</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">A20</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lo_t</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo_t</span><span class="p">,</span> <span class="n">ceil_div</span><span class="p">(</span><span class="n">bi</span> <span class="o">-</span> <span class="n">A10</span> <span class="o">*</span> <span class="n">s</span><span class="p">,</span> <span class="n">A20</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">feas</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">hi_t</span> <span class="o">&lt;</span> <span class="n">lo_t</span> <span class="ow">or</span> <span class="n">t_mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># choose t endpoints</span>
            <span class="n">remv</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_x</span> <span class="o">-</span> <span class="n">lo_t</span><span class="p">)</span> <span class="o">%</span> <span class="n">t_mod</span>
            <span class="n">t_min</span> <span class="o">=</span> <span class="n">lo_t</span> <span class="o">+</span> <span class="n">remv</span>
            <span class="n">cand</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">t_min</span> <span class="o">&lt;=</span> <span class="n">hi_t</span><span class="p">:</span>
                <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_min</span><span class="p">)</span>
            <span class="n">kmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi_t</span> <span class="o">-</span> <span class="n">t_x</span><span class="p">)</span> <span class="o">//</span> <span class="n">t_mod</span>
            <span class="n">t_max</span> <span class="o">=</span> <span class="n">t_x</span> <span class="o">+</span> <span class="n">kmax</span> <span class="o">*</span> <span class="n">t_mod</span>
            <span class="k">if</span> <span class="n">t_max</span> <span class="o">&gt;=</span> <span class="n">lo_t</span> <span class="ow">and</span> <span class="n">t_max</span> <span class="o">&lt;=</span> <span class="n">hi_t</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cand</span> <span class="ow">or</span> <span class="n">t_max</span> <span class="o">!=</span> <span class="n">cand</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_max</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">cand</span><span class="p">:</span>
                <span class="n">xF</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">d</span>
                <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">assign</span><span class="p">:</span>
                    <span class="n">xF</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">xF</span><span class="p">[</span><span class="n">j1</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                <span class="n">xF</span><span class="p">[</span><span class="n">j2</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">total_presses</span><span class="p">(</span><span class="n">xF</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">best_local</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">best_local</span><span class="p">:</span>
                        <span class="n">best_local</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">best_local</span>

    <span class="c1"># Enumerate first d-2 variables in small ranges guided by ub and congruences similar to d==1 for variables with many constraints</span>
    <span class="c1"># We&#39;ll pick first variables in &#39;order&#39; except the last two in that order.</span>
    <span class="n">fix_vars</span> <span class="o">=</span> <span class="n">order</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">rem_vars</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span>
    <span class="c1"># Build congruence for each fixed var j independently from rows where other M entries are 0 modulo D  conservative approach: we can ignore and rely on reduce_to_two to handle congruences</span>

    <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Simple bounded loops lazily: for each fixed var j, iterate 0..min(ub[j], 50) plus some residues up to ub: However ub might be large; but d&gt;=3 rare; We&#39;ll cap iterations by heuristic: For each j, we iterate s in arithmetic progression determined by any direct congruences (rows where all other free coefficients are 0 mod D). If none, step 1.</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of (j, start, step, lo, hi)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">fix_vars</span><span class="p">:</span>
        <span class="c1"># derive congruence a_j * x_j  b (mod D) from rows where all other free columns have 0 coef mod D</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">xres</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="c1"># if all other free vars (excluding j and rem_vars) have coefficient % D == 0 and also rem_vars coefficients == 0 -&gt; constraint on x_j alone</span>
            <span class="n">other_ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">jj</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">other_ok</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">other_ok</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">aij</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
            <span class="n">bi</span> <span class="o">=</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">aij</span> <span class="o">%</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bi</span> <span class="o">%</span> <span class="n">D</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># unsatisfiable</span>
                    <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">sol</span> <span class="o">=</span> <span class="n">solve_linear_congruence</span><span class="p">(</span><span class="n">aij</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
            <span class="n">xi</span><span class="p">,</span> <span class="n">mi</span> <span class="o">=</span> <span class="n">sol</span>
            <span class="n">merged</span> <span class="o">=</span> <span class="n">crt_merge</span><span class="p">(</span><span class="n">xres</span><span class="p">,</span> <span class="n">mod</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">mi</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">merged</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
            <span class="n">xres</span><span class="p">,</span> <span class="n">mod</span> <span class="o">=</span> <span class="n">merged</span>
            <span class="c1"># inequality bound: aij x_j &lt;= bi if aij&gt;0 else lower bound</span>
            <span class="k">if</span> <span class="n">aij</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">bi</span> <span class="o">//</span> <span class="n">aij</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">aij</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">ceil_div</span><span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="n">aij</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">hi</span> <span class="o">&lt;</span> <span class="n">lo</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">d</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="c1"># compute start as smallest &gt;= lo congruent to xres mod mod</span>
        <span class="k">if</span> <span class="n">mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">lo</span>
            <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remv</span> <span class="o">=</span> <span class="p">(</span><span class="n">xres</span> <span class="o">-</span> <span class="n">lo</span><span class="p">)</span> <span class="o">%</span> <span class="n">mod</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">+</span> <span class="n">remv</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">mod</span>
        <span class="n">prog</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">))</span>
    <span class="c1"># Now nested loops for fixed vars</span>
    <span class="c1"># We&#39;ll implement recursive function</span>
    <span class="n">fixed_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">rec</span><span class="p">(</span><span class="n">idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">best</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">fix_vars</span><span class="p">):</span>
            <span class="c1"># reduce to two vars</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">reduce_to_two</span><span class="p">(</span><span class="n">fixed_list</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                    <span class="n">best</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">return</span>
        <span class="n">j</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="n">prog</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="c1"># limit number of iterations to avoid explosion: at most 400 steps per var</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">hi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">lo</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">fixed_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
            <span class="n">rec</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">fixed_list</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="n">rec</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># fallback: try zero for fixed vars</span>
        <span class="n">base</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">d</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">total_presses</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="k">return</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_enumpy"> solve_day10_part2_enum.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T10:05:45.214033</li>
<li><strong>Duration</strong>: 0.98s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout_9">Stdout</h3>
<div class="highlight"><pre><span></span><code>24000012143
</code></pre></div>
<h3 id="code_24">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># remove columns touching zero-target counters</span>
    <span class="n">zero_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">zero_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">zero_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="c1"># keep only active rows</span>
    <span class="n">active</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">active</span><span class="p">]</span>
    <span class="n">remapped</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">new_i</span><span class="p">,</span> <span class="n">old_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">active</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">old_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nm</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">new_i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nm</span><span class="p">:</span>
            <span class="n">remapped</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
    <span class="c1"># dedup</span>
    <span class="n">remapped</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">remapped</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">t2</span><span class="p">,</span> <span class="n">remapped</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_A</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">m</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span>


<span class="k">def</span><span class="w"> </span><span class="nf">det_and_adj</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">inv</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="n">inv</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">inv</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">inv</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="n">sign</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="n">det</span> <span class="o">*=</span> <span class="n">pv</span>
        <span class="n">inv_pv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">pv</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv_pv</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">inv</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv_pv</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">inv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span><span class="o">*</span><span class="n">inv</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="n">det</span> <span class="o">*=</span> <span class="n">sign</span>
    <span class="c1"># adj = det * inv</span>
    <span class="n">adj</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">((</span><span class="n">det</span><span class="o">*</span><span class="n">inv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">numerator</span> <span class="o">//</span> <span class="p">(</span><span class="n">det</span><span class="o">*</span><span class="n">inv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">dnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">det</span><span class="o">.</span><span class="n">numerator</span> <span class="o">//</span> <span class="n">det</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dnum</span><span class="p">,</span> <span class="n">adj</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rank_rows</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="n">row_perm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">piv_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">row_perm</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">row_perm</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_perm</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">row_perm</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="c1"># eliminate</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">pv</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">r</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">piv_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_perm</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">piv_rows</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">piv_rows</span>


<span class="k">def</span><span class="w"> </span><span class="nf">sdiv_floor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="c1"># floor(a/b) for integers with b possibly negative</span>
    <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">//</span> <span class="n">b</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sdiv_ceil</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="c1"># ceil(a/b)</span>
    <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">((</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">//</span> <span class="n">b</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">build_A</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">k</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c1"># infeasible if any row zeros</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;infeasible row&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">rank_rows</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="c1"># choose basis columns C (size r) minimizing |det|</span>
    <span class="n">best_det</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_C</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_adj</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">r</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">C</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
        <span class="n">dnum</span><span class="p">,</span> <span class="n">adj</span> <span class="o">=</span> <span class="n">det_and_adj</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ad</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dnum</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">best_det</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ad</span> <span class="o">&lt;</span> <span class="n">best_det</span><span class="p">):</span>
            <span class="n">best_det</span> <span class="o">=</span> <span class="n">ad</span>
            <span class="n">best_C</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dnum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">adj</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">adj</span><span class="p">]</span>
            <span class="n">best_adj</span> <span class="o">=</span> <span class="n">adj</span>
            <span class="k">if</span> <span class="n">ad</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">if</span> <span class="n">best_C</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no invertible basis&#39;</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">best_det</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">best_C</span>
    <span class="n">adj</span> <span class="o">=</span> <span class="n">best_adj</span>
    <span class="n">F</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">C</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="c1"># Build b0 and M</span>
    <span class="n">tR</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">adj</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">*</span><span class="n">tR</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
    <span class="n">A_F_R</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">F</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">sum</span><span class="p">(</span><span class="n">adj</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">*</span><span class="n">A_F_R</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
    <span class="c1"># Objective: total presses = sum(xF) + sum((b0 - M xF)/D)</span>
    <span class="n">sumMcol</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">total_presses</span><span class="p">(</span><span class="n">xF</span><span class="p">):</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">b0</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">xF</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                    <span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">v</span>
        <span class="n">sB</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">sB</span> <span class="o">+=</span> <span class="n">num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">D</span>
        <span class="k">return</span> <span class="n">sB</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">xF</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">total_presses</span><span class="p">([])</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no solution unique&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="c1"># bounds for each free var</span>
    <span class="n">lb</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">d</span>
    <span class="n">ub</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">d</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">sdiv_floor</span><span class="p">(</span><span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">a</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">sdiv_ceil</span><span class="p">(</span><span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">a</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">lo</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">hi</span> <span class="o">==</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">:</span>
            <span class="n">hi</span> <span class="o">=</span> <span class="mi">1000000</span>
        <span class="n">lb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">lo</span>
        <span class="n">ub</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">hi</span>
    <span class="c1"># d==1</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># solve congruence for x with coeffs M[:,0]</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="n">lb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">aa</span> <span class="o">=</span> <span class="n">a</span> <span class="o">%</span> <span class="n">D</span>
            <span class="n">bb</span> <span class="o">=</span> <span class="n">b</span> <span class="o">%</span> <span class="n">D</span>
            <span class="k">if</span> <span class="n">aa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bb</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
                <span class="k">continue</span>
            <span class="c1"># solve aa x  bb mod D</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">gcd</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bb</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
            <span class="n">m1</span> <span class="o">=</span> <span class="n">D</span> <span class="o">//</span> <span class="n">g</span>
            <span class="c1"># inverse of aa/g mod m1</span>
            <span class="n">inv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">((</span><span class="n">aa</span><span class="o">//</span><span class="n">g</span><span class="p">)</span> <span class="o">%</span> <span class="n">m1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">bb</span><span class="o">//</span><span class="n">g</span><span class="p">)</span> <span class="o">*</span> <span class="n">inv</span> <span class="o">%</span> <span class="n">m1</span>
            <span class="c1"># merge with current x  x0 mod mod</span>
            <span class="c1"># compute combined</span>
            <span class="c1"># Find k such that x0 + mod * k  xi mod m1</span>
            <span class="c1"># i.e., mod*k  xi - x0 mod m1 -&gt; k  (xi - x0) * inv_mod mod m1/gcd</span>
            <span class="n">g2</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">%</span> <span class="n">g2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
            <span class="n">lcm</span> <span class="o">=</span> <span class="n">mod</span><span class="o">//</span><span class="n">g2</span> <span class="o">*</span> <span class="n">m1</span>
            <span class="c1"># solve for x</span>
            <span class="n">k</span> <span class="o">=</span> <span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">((</span><span class="n">mod</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span> <span class="o">+</span> <span class="n">mod</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">%</span> <span class="n">lcm</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">lcm</span>
        <span class="k">if</span> <span class="n">lo</span> <span class="o">&gt;</span> <span class="n">hi</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="c1"># iterate x in progression in [lo,hi]; objective linear so endpoints suffice</span>
        <span class="c1"># minimal &gt;= lo congruent to x0 mod mod</span>
        <span class="k">if</span> <span class="n">mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="n">rem</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0</span> <span class="o">-</span> <span class="n">lo</span><span class="p">)</span> <span class="o">%</span> <span class="n">mod</span>
        <span class="n">x_min</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">+</span> <span class="n">rem</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">x_min</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">:</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_min</span><span class="p">)</span>
        <span class="c1"># maximal &lt;= hi</span>
        <span class="n">kmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">//</span> <span class="n">mod</span>
        <span class="n">x_max</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">kmax</span> <span class="o">*</span> <span class="n">mod</span>
        <span class="k">if</span> <span class="n">x_max</span> <span class="o">&gt;=</span> <span class="n">lo</span> <span class="ow">and</span> <span class="n">x_max</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span> <span class="ow">or</span> <span class="n">x_max</span> <span class="o">!=</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_max</span><span class="p">)</span>
        <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">total_presses</span><span class="p">([</span><span class="n">x</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                    <span class="n">best</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="k">return</span> <span class="n">best</span>
    <span class="c1"># d==2</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># iterate x0 in its progression as per rows where M[:,1] % D == 0</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">gcd</span>
        <span class="n">x0_res</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x0_mod</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">lo0</span> <span class="o">=</span> <span class="n">lb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hi0</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">a0</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span>
            <span class="n">bi</span> <span class="o">=</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span>
            <span class="k">if</span> <span class="n">a1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">bi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bi</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
                <span class="n">m1</span> <span class="o">=</span> <span class="n">D</span><span class="o">//</span><span class="n">g</span>
                <span class="n">inv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">((</span><span class="n">a0</span><span class="o">//</span><span class="n">g</span><span class="p">)</span><span class="o">%</span><span class="n">m1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">bi</span><span class="o">//</span><span class="n">g</span><span class="p">)</span><span class="o">*</span><span class="n">inv</span> <span class="o">%</span> <span class="n">m1</span>
                <span class="c1"># merge</span>
                <span class="n">g2</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">x0_mod</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x0_res</span><span class="p">)</span> <span class="o">%</span> <span class="n">g2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
                <span class="n">lcm</span> <span class="o">=</span> <span class="n">x0_mod</span><span class="o">//</span><span class="n">g2</span> <span class="o">*</span> <span class="n">m1</span>
                <span class="n">k</span> <span class="o">=</span> <span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x0_res</span><span class="p">)</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">((</span><span class="n">x0_mod</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span>
                <span class="n">x0_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0_res</span> <span class="o">+</span> <span class="n">x0_mod</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">%</span> <span class="n">lcm</span>
                <span class="n">x0_mod</span> <span class="o">=</span> <span class="n">lcm</span>
                <span class="c1"># inequalities</span>
                <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">hi0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi0</span><span class="p">,</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lo0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo0</span><span class="p">,</span> <span class="n">sdiv_ceil</span><span class="p">(</span><span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">lo0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">lo0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">hi0</span> <span class="o">&lt;</span> <span class="n">lo0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="k">if</span> <span class="n">x0_mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">lo0</span> <span class="o">+</span> <span class="p">(</span><span class="n">x0_res</span> <span class="o">-</span> <span class="n">lo0</span><span class="p">)</span> <span class="o">%</span> <span class="n">x0_mod</span>
        <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">x0v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">hi0</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">x0_mod</span><span class="p">):</span>
            <span class="c1"># compute x1 congruence</span>
            <span class="n">x1_res</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">x1_mod</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">lo1</span> <span class="o">=</span> <span class="n">lb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">hi1</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">feasible</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">a0</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">a1</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">bi_all</span> <span class="o">=</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">a1m</span> <span class="o">=</span> <span class="n">a1</span> <span class="o">%</span> <span class="n">D</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="p">(</span><span class="n">bi_all</span> <span class="o">-</span> <span class="n">a0</span> <span class="o">*</span> <span class="n">x0v</span><span class="p">)</span> <span class="o">%</span> <span class="n">D</span>
                <span class="k">if</span> <span class="n">a1m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">rhs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">a0</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">a0</span> <span class="o">*</span> <span class="n">x0v</span> <span class="o">&gt;</span> <span class="n">bi_all</span><span class="p">:</span>
                        <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">a0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">lo1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">a1m</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rhs</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="n">m1</span> <span class="o">=</span> <span class="n">D</span><span class="o">//</span><span class="n">g</span>
                <span class="n">inv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">((</span><span class="n">a1m</span><span class="o">//</span><span class="n">g</span><span class="p">)</span><span class="o">%</span><span class="n">m1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">rhs</span><span class="o">//</span><span class="n">g</span><span class="p">)</span><span class="o">*</span><span class="n">inv</span> <span class="o">%</span> <span class="n">m1</span>
                <span class="n">g2</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">x1_mod</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x1_res</span><span class="p">)</span> <span class="o">%</span> <span class="n">g2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="n">lcm</span> <span class="o">=</span> <span class="n">x1_mod</span><span class="o">//</span><span class="n">g2</span> <span class="o">*</span> <span class="n">m1</span>
                <span class="n">k</span> <span class="o">=</span> <span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x1_res</span><span class="p">)</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">((</span><span class="n">x1_mod</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span>
                <span class="n">x1_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1_res</span> <span class="o">+</span> <span class="n">x1_mod</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">%</span> <span class="n">lcm</span>
                <span class="n">x1_mod</span> <span class="o">=</span> <span class="n">lcm</span>
                <span class="c1"># inequalities for x1</span>
                <span class="k">if</span> <span class="n">a1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">hi1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi1</span><span class="p">,</span> <span class="p">(</span><span class="n">bi_all</span> <span class="o">-</span> <span class="n">a0</span> <span class="o">*</span> <span class="n">x0v</span><span class="p">)</span> <span class="o">//</span> <span class="n">a1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">a1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lo1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo1</span><span class="p">,</span> <span class="n">sdiv_ceil</span><span class="p">(</span><span class="n">bi_all</span> <span class="o">-</span> <span class="n">a0</span> <span class="o">*</span> <span class="n">x0v</span><span class="p">,</span> <span class="n">a1</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">feasible</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">hi1</span> <span class="o">&lt;</span> <span class="n">lo1</span> <span class="ow">or</span> <span class="n">x1_mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># candidate endpoints</span>
            <span class="n">x1_min</span> <span class="o">=</span> <span class="n">lo1</span> <span class="o">+</span> <span class="p">(</span><span class="n">x1_res</span> <span class="o">-</span> <span class="n">lo1</span><span class="p">)</span> <span class="o">%</span> <span class="n">x1_mod</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">x1_min</span> <span class="o">&lt;=</span> <span class="n">hi1</span><span class="p">:</span>
                <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1_min</span><span class="p">)</span>
            <span class="n">kmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi1</span> <span class="o">-</span> <span class="n">x1_res</span><span class="p">)</span> <span class="o">//</span> <span class="n">x1_mod</span>
            <span class="n">x1_max</span> <span class="o">=</span> <span class="n">x1_res</span> <span class="o">+</span> <span class="n">kmax</span> <span class="o">*</span> <span class="n">x1_mod</span>
            <span class="k">if</span> <span class="n">x1_max</span> <span class="o">&gt;=</span> <span class="n">lo1</span> <span class="ow">and</span> <span class="n">x1_max</span> <span class="o">&lt;=</span> <span class="n">hi1</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">candidates</span> <span class="ow">or</span> <span class="n">x1_max</span> <span class="o">!=</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1_max</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">x1v</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">total_presses</span><span class="p">([</span><span class="n">x0v</span><span class="p">,</span> <span class="n">x1v</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                        <span class="n">best</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="k">return</span> <span class="n">best</span>
    <span class="c1"># d==3</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">gcd</span>
        <span class="c1"># iterate x0 in progression from rows where other coeffs 0 mod D</span>
        <span class="n">x0_res</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x0_mod</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">lo0</span> <span class="o">=</span> <span class="n">lb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hi0</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">a0</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span>
            <span class="n">a2</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span>
            <span class="n">bi</span> <span class="o">=</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span>
            <span class="k">if</span> <span class="n">a1</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">a2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">bi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bi</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
                <span class="n">m1</span> <span class="o">=</span> <span class="n">D</span><span class="o">//</span><span class="n">g</span>
                <span class="n">inv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">((</span><span class="n">a0</span><span class="o">//</span><span class="n">g</span><span class="p">)</span><span class="o">%</span><span class="n">m1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">bi</span><span class="o">//</span><span class="n">g</span><span class="p">)</span><span class="o">*</span><span class="n">inv</span> <span class="o">%</span> <span class="n">m1</span>
                <span class="n">g2</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">x0_mod</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x0_res</span><span class="p">)</span> <span class="o">%</span> <span class="n">g2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
                <span class="n">lcm</span> <span class="o">=</span> <span class="n">x0_mod</span><span class="o">//</span><span class="n">g2</span> <span class="o">*</span> <span class="n">m1</span>
                <span class="n">k</span> <span class="o">=</span> <span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x0_res</span><span class="p">)</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">((</span><span class="n">x0_mod</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span>
                <span class="n">x0_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0_res</span> <span class="o">+</span> <span class="n">x0_mod</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">%</span> <span class="n">lcm</span>
                <span class="n">x0_mod</span> <span class="o">=</span> <span class="n">lcm</span>
                <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">hi0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi0</span><span class="p">,</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lo0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo0</span><span class="p">,</span> <span class="n">sdiv_ceil</span><span class="p">(</span><span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">lo0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">lo0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">hi0</span> <span class="o">&lt;</span> <span class="n">lo0</span> <span class="ow">or</span> <span class="n">x0_mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">start0</span> <span class="o">=</span> <span class="n">lo0</span> <span class="o">+</span> <span class="p">(</span><span class="n">x0_res</span> <span class="o">-</span> <span class="n">lo0</span><span class="p">)</span> <span class="o">%</span> <span class="n">x0_mod</span>
        <span class="k">for</span> <span class="n">x0v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start0</span><span class="p">,</span> <span class="n">hi0</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">x0_mod</span><span class="p">):</span>
            <span class="c1"># reduce to 2 vars similar to d==2 with adjusted b0&#39; = b0 - M[:,0]*x0</span>
            <span class="n">b0p</span> <span class="o">=</span> <span class="p">[</span><span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x0v</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
            <span class="c1"># d==2 on variables 1 and 2</span>
            <span class="n">x1_res</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">x1_mod</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">lo1</span> <span class="o">=</span> <span class="n">lb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">hi1</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">feasible</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">a1</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span>
                <span class="n">a2</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span>
                <span class="n">bi</span> <span class="o">=</span> <span class="n">b0p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span>
                <span class="k">if</span> <span class="n">a2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">a1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">bi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">bi</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="n">m1</span> <span class="o">=</span> <span class="n">D</span><span class="o">//</span><span class="n">g</span>
                    <span class="n">inv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">((</span><span class="n">a1</span><span class="o">//</span><span class="n">g</span><span class="p">)</span><span class="o">%</span><span class="n">m1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
                    <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">bi</span><span class="o">//</span><span class="n">g</span><span class="p">)</span><span class="o">*</span><span class="n">inv</span> <span class="o">%</span> <span class="n">m1</span>
                    <span class="n">g2</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">x1_mod</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x1_res</span><span class="p">)</span> <span class="o">%</span> <span class="n">g2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="n">lcm</span> <span class="o">=</span> <span class="n">x1_mod</span><span class="o">//</span><span class="n">g2</span> <span class="o">*</span> <span class="n">m1</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x1_res</span><span class="p">)</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">((</span><span class="n">x1_mod</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span>
                    <span class="n">x1_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1_res</span> <span class="o">+</span> <span class="n">x1_mod</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">%</span> <span class="n">lcm</span>
                    <span class="n">x1_mod</span> <span class="o">=</span> <span class="n">lcm</span>
                    <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">hi1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi1</span><span class="p">,</span> <span class="n">b0p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">lo1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo1</span><span class="p">,</span> <span class="n">sdiv_ceil</span><span class="p">(</span><span class="n">b0p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">feasible</span> <span class="ow">or</span> <span class="n">hi1</span> <span class="o">&lt;</span> <span class="n">lo1</span> <span class="ow">or</span> <span class="n">x1_mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">start1</span> <span class="o">=</span> <span class="n">lo1</span> <span class="o">+</span> <span class="p">(</span><span class="n">x1_res</span> <span class="o">-</span> <span class="n">lo1</span><span class="p">)</span> <span class="o">%</span> <span class="n">x1_mod</span>
            <span class="k">for</span> <span class="n">x1v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start1</span><span class="p">,</span> <span class="n">hi1</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">x1_mod</span><span class="p">):</span>
                <span class="c1"># compute x2 congruence</span>
                <span class="n">x2_res</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">x2_mod</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">lo2</span> <span class="o">=</span> <span class="n">lb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">hi2</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">feas2</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                    <span class="n">a1</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">a2</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">bi_all</span> <span class="o">=</span> <span class="n">b0p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">rhs</span> <span class="o">=</span> <span class="p">(</span><span class="n">bi_all</span> <span class="o">-</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">x1v</span><span class="p">)</span> <span class="o">%</span> <span class="n">D</span>
                    <span class="n">a2m</span> <span class="o">=</span> <span class="n">a2</span> <span class="o">%</span> <span class="n">D</span>
                    <span class="k">if</span> <span class="n">a2m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">rhs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">feas2</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="n">a1</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">x1v</span> <span class="o">&gt;</span> <span class="n">bi_all</span><span class="p">:</span>
                            <span class="n">feas2</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="n">a1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">lo2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">a2m</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rhs</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">feas2</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="n">m1</span> <span class="o">=</span> <span class="n">D</span><span class="o">//</span><span class="n">g</span>
                    <span class="n">inv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">((</span><span class="n">a2m</span><span class="o">//</span><span class="n">g</span><span class="p">)</span><span class="o">%</span><span class="n">m1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
                    <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">rhs</span><span class="o">//</span><span class="n">g</span><span class="p">)</span><span class="o">*</span><span class="n">inv</span> <span class="o">%</span> <span class="n">m1</span>
                    <span class="n">g2</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">x2_mod</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x2_res</span><span class="p">)</span> <span class="o">%</span> <span class="n">g2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">feas2</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="n">lcm</span> <span class="o">=</span> <span class="n">x2_mod</span><span class="o">//</span><span class="n">g2</span> <span class="o">*</span> <span class="n">m1</span>
                    <span class="n">k</span> <span class="o">=</span> <span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x2_res</span><span class="p">)</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">((</span><span class="n">x2_mod</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span>
                    <span class="n">x2_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2_res</span> <span class="o">+</span> <span class="n">x2_mod</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">%</span> <span class="n">lcm</span>
                    <span class="n">x2_mod</span> <span class="o">=</span> <span class="n">lcm</span>
                    <span class="k">if</span> <span class="n">a2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">hi2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi2</span><span class="p">,</span> <span class="p">(</span><span class="n">bi_all</span> <span class="o">-</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">x1v</span><span class="p">)</span> <span class="o">//</span> <span class="n">a2</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">a2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">lo2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo2</span><span class="p">,</span> <span class="n">sdiv_ceil</span><span class="p">(</span><span class="n">bi_all</span> <span class="o">-</span> <span class="n">a1</span> <span class="o">*</span> <span class="n">x1v</span><span class="p">,</span> <span class="n">a2</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">feas2</span> <span class="ow">or</span> <span class="n">hi2</span> <span class="o">&lt;</span> <span class="n">lo2</span> <span class="ow">or</span> <span class="n">x2_mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># endpoints for x2</span>
                <span class="n">x2_min</span> <span class="o">=</span> <span class="n">lo2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x2_res</span> <span class="o">-</span> <span class="n">lo2</span><span class="p">)</span> <span class="o">%</span> <span class="n">x2_mod</span>
                <span class="n">cand</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">x2_min</span> <span class="o">&lt;=</span> <span class="n">hi2</span><span class="p">:</span>
                    <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x2_min</span><span class="p">)</span>
                <span class="n">kmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi2</span> <span class="o">-</span> <span class="n">x2_res</span><span class="p">)</span> <span class="o">//</span> <span class="n">x2_mod</span>
                <span class="n">x2_max</span> <span class="o">=</span> <span class="n">x2_res</span> <span class="o">+</span> <span class="n">kmax</span> <span class="o">*</span> <span class="n">x2_mod</span>
                <span class="k">if</span> <span class="n">x2_max</span> <span class="o">&gt;=</span> <span class="n">lo2</span> <span class="ow">and</span> <span class="n">x2_max</span> <span class="o">&lt;=</span> <span class="n">hi2</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cand</span> <span class="ow">or</span> <span class="n">x2_max</span> <span class="o">!=</span> <span class="n">cand</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x2_max</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">x2v</span> <span class="ow">in</span> <span class="n">cand</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">total_presses</span><span class="p">([</span><span class="n">x0v</span><span class="p">,</span> <span class="n">x1v</span><span class="p">,</span> <span class="n">x2v</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                            <span class="n">best</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">total_presses</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="k">return</span> <span class="n">best</span>
    <span class="c1"># d&gt;3 shouldn&#39;t happen per stats; fallback brute force small bounds</span>
    <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">xF</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">best</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">total_presses</span><span class="p">(</span><span class="n">xF</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                    <span class="n">best</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lb</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="nb">min</span><span class="p">(</span><span class="n">ub</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">lb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="mi">50</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">xF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">dfs</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">xF</span><span class="p">)</span>
            <span class="n">xF</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="n">dfs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">return</span> <span class="n">best</span> <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_snfpy"> solve_day10_part2_snf.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T10:07:20.306497</li>
<li><strong>Duration</strong>: 0.20s</li>
<li><strong>Exit Code</strong>: 1</li>
<li><strong>Error</strong>: Non-zero exit code</li>
</ul>
<h3 id="stderr_2">Stderr</h3>
<div class="highlight"><pre><span></span><code>Traceback (most recent call last):
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_09-09-09_2025_10_python_gpt-5_949554a9\solve_day10_part2_snf.py&quot;, line 521, in &lt;module&gt;
    main()
    ~~~~^^
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_09-09-09_2025_10_python_gpt-5_949554a9\solve_day10_part2_snf.py&quot;, line 517, in main
    total += ans
TypeError: unsupported operand type(s) for +=: &#39;int&#39; and &#39;NoneType&#39;
</code></pre></div>
<h3 id="code_25">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">gcd</span>

<span class="c1"># Solve Ax = t, minimize sum(x), x &gt;= 0 integers.</span>
<span class="c1"># k &lt;= 10, m &lt;= 13. We&#39;ll reduce to active rows (t_i&gt;0) and drop columns touching zero rows.</span>
<span class="c1"># Then choose r columns forming invertible r x r matrix B over Z with minimal |det|, compute adj(B) and D=|det|.</span>
<span class="c1"># Let F be remaining columns. Let M = adj(B)*A[R,F], b0 = adj(B)*t_R. Then x_C = (b0 - M x_F)/D must be integer &gt;= 0, and x_F &gt;= 0.</span>
<span class="c1"># We enumerate x_F for d = |F| &lt;= 3 using modular congruences and inequality bounds.</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># drop columns touching zero targets</span>
    <span class="n">zero_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">zero_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">zero_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Active rows</span>
    <span class="n">active</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">active</span><span class="p">]</span>
    <span class="n">cols2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">new_i</span><span class="p">,</span> <span class="n">old_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">active</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&gt;&gt;</span> <span class="n">old_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">nm</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">new_i</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nm</span><span class="p">:</span>
            <span class="n">cols2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>
    <span class="n">cols2</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">t2</span><span class="p">,</span> <span class="n">cols2</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_A</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">m</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>

<span class="k">def</span><span class="w"> </span><span class="nf">det_and_adj</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">inv</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">det</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="n">inv</span><span class="p">[</span><span class="n">c</span><span class="p">],</span> <span class="n">inv</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">inv</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="n">sign</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="n">det</span> <span class="o">*=</span> <span class="n">pv</span>
        <span class="n">inv_pv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">pv</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv_pv</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">inv</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv_pv</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">inv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span><span class="o">*</span><span class="n">inv</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="n">det</span> <span class="o">*=</span> <span class="n">sign</span>
    <span class="n">adj</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">int</span><span class="p">((</span><span class="n">det</span><span class="o">*</span><span class="n">inv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">numerator</span> <span class="o">//</span> <span class="p">(</span><span class="n">det</span><span class="o">*</span><span class="n">inv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">dnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">det</span><span class="o">.</span><span class="n">numerator</span> <span class="o">//</span> <span class="n">det</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dnum</span><span class="p">,</span> <span class="n">adj</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rank_rows</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="n">row_perm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">piv_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">row_perm</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">row_perm</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">row_perm</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">row_perm</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">pv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">pv</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*=</span> <span class="n">inv</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">r</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span><span class="o">*</span><span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">piv_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_perm</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">==</span><span class="n">k</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="n">piv_rows</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">piv_rows</span>


<span class="k">def</span><span class="w"> </span><span class="nf">sdiv_floor</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">//</span> <span class="n">b</span>

<span class="k">def</span><span class="w"> </span><span class="nf">sdiv_ceil</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">((</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">//</span><span class="n">b</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_d0</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
    <span class="c1"># require each b0_i divisible by D and &gt;=0, return sum(b0)/D</span>
    <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">bi</span> <span class="ow">in</span> <span class="n">b0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">bi</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">bi</span> <span class="o">%</span> <span class="n">D</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">bi</span> <span class="o">//</span> <span class="n">D</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_d1</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">Mcol</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
    <span class="c1"># Find x &gt;=0 s.t. for all i: Mcol_i * x  b0_i (mod D) and Mcol_i * x &lt;= b0_i if Mcol_i&gt;0; if negative, inequality becomes x &gt;= ceil(b0_i / Mcol_i)</span>
    <span class="n">x_res</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">x_mod</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Mcol</span><span class="p">,</span> <span class="n">b0</span><span class="p">):</span>
        <span class="n">aa</span> <span class="o">=</span> <span class="n">a</span> <span class="o">%</span> <span class="n">D</span>
        <span class="n">bb</span> <span class="o">=</span> <span class="n">b</span> <span class="o">%</span> <span class="n">D</span>
        <span class="k">if</span> <span class="n">aa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bb</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="c1"># only inequality</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">sdiv_floor</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">sdiv_ceil</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
            <span class="k">continue</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bb</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="n">D</span> <span class="o">//</span> <span class="n">g</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">((</span><span class="n">aa</span><span class="o">//</span><span class="n">g</span><span class="p">)</span> <span class="o">%</span> <span class="n">m1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
        <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">bb</span><span class="o">//</span><span class="n">g</span><span class="p">)</span> <span class="o">*</span> <span class="n">inv</span> <span class="o">%</span> <span class="n">m1</span>
        <span class="c1"># merge x  x_res (mod x_mod) with x  xi (mod m1)</span>
        <span class="n">g2</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">x_mod</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x_res</span><span class="p">)</span> <span class="o">%</span> <span class="n">g2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">lcm</span> <span class="o">=</span> <span class="n">x_mod</span> <span class="o">//</span> <span class="n">g2</span> <span class="o">*</span> <span class="n">m1</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x_res</span><span class="p">)</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">((</span><span class="n">x_mod</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span>
        <span class="n">x_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_res</span> <span class="o">+</span> <span class="n">x_mod</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">%</span> <span class="n">lcm</span>
        <span class="n">x_mod</span> <span class="o">=</span> <span class="n">lcm</span>
        <span class="c1"># inequality</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">sdiv_floor</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">sdiv_ceil</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">lo</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">hi</span> <span class="o">&lt;</span> <span class="n">lo</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">x_mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="c1"># candidates endpoints of progression within [lo,hi]</span>
    <span class="n">x_min</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">+</span> <span class="p">(</span><span class="n">x_res</span> <span class="o">-</span> <span class="n">lo</span><span class="p">)</span> <span class="o">%</span> <span class="n">x_mod</span>
    <span class="n">cand</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">x_min</span> <span class="o">&lt;=</span> <span class="n">hi</span><span class="p">:</span>
        <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_min</span><span class="p">)</span>
    <span class="n">kmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">x_res</span><span class="p">)</span> <span class="o">//</span> <span class="n">x_mod</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="n">x_res</span> <span class="o">+</span> <span class="n">kmax</span> <span class="o">*</span> <span class="n">x_mod</span>
    <span class="k">if</span> <span class="n">x_max</span> <span class="o">&gt;=</span> <span class="n">lo</span> <span class="ow">and</span> <span class="n">x_max</span> <span class="o">&lt;=</span> <span class="n">hi</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">cand</span> <span class="ow">or</span> <span class="n">x_max</span> <span class="o">!=</span> <span class="n">cand</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">cand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_max</span><span class="p">)</span>
    <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cand</span><span class="p">:</span>
        <span class="c1"># compute sum = sum(b0 - a*x)/D + x; check divisibility and nonnegativity</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Mcol</span><span class="p">,</span> <span class="n">b0</span><span class="p">):</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">num</span> <span class="o">%</span> <span class="n">D</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">num</span> <span class="o">//</span> <span class="n">D</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="n">x</span>
        <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_d2</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
    <span class="c1"># enumerate x0 in progression from rows where M[:,1] % D == 0, then solve x1 by congruence and bounds</span>
    <span class="n">a0</span> <span class="o">=</span> <span class="p">[</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b0</span><span class="p">))]</span>
    <span class="n">a1</span> <span class="o">=</span> <span class="p">[</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b0</span><span class="p">))]</span>
    <span class="n">x0_res</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">x0_mod</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">lo0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">hi0</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
    <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">a1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">%</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">aa</span> <span class="o">=</span> <span class="n">a</span> <span class="o">%</span> <span class="n">D</span>
            <span class="n">bb</span> <span class="o">=</span> <span class="n">b</span> <span class="o">%</span> <span class="n">D</span>
            <span class="k">if</span> <span class="n">aa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bb</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">bb</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="n">m1</span> <span class="o">=</span> <span class="n">D</span> <span class="o">//</span> <span class="n">g</span>
                <span class="n">inv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">((</span><span class="n">aa</span><span class="o">//</span><span class="n">g</span><span class="p">)</span> <span class="o">%</span> <span class="n">m1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">bb</span><span class="o">//</span><span class="n">g</span><span class="p">)</span> <span class="o">*</span> <span class="n">inv</span> <span class="o">%</span> <span class="n">m1</span>
                <span class="n">g2</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">x0_mod</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x0_res</span><span class="p">)</span> <span class="o">%</span> <span class="n">g2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="n">lcm</span> <span class="o">=</span> <span class="n">x0_mod</span> <span class="o">//</span> <span class="n">g2</span> <span class="o">*</span> <span class="n">m1</span>
                <span class="n">k</span> <span class="o">=</span> <span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x0_res</span><span class="p">)</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">((</span><span class="n">x0_mod</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span>
                <span class="n">x0_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">x0_res</span> <span class="o">+</span> <span class="n">x0_mod</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">%</span> <span class="n">lcm</span>
                <span class="n">x0_mod</span> <span class="o">=</span> <span class="n">lcm</span>
            <span class="c1"># inequalities for x0</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hi0</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi0</span><span class="p">,</span> <span class="n">sdiv_floor</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lo0</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo0</span><span class="p">,</span> <span class="n">sdiv_ceil</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">lo0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">lo0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">hi0</span> <span class="o">&lt;</span> <span class="n">lo0</span> <span class="ow">or</span> <span class="n">x0_mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">start0</span> <span class="o">=</span> <span class="n">lo0</span> <span class="o">+</span> <span class="p">(</span><span class="n">x0_res</span> <span class="o">-</span> <span class="n">lo0</span><span class="p">)</span> <span class="o">%</span> <span class="n">x0_mod</span>
    <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">x0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start0</span><span class="p">,</span> <span class="n">hi0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">x0_mod</span><span class="p">):</span>
        <span class="c1"># Now solve x1 congruence and bounds given x0</span>
        <span class="n">x1_res</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">x1_mod</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">lo1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hi1</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="n">feasible</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">a1</span><span class="p">):</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x0</span><span class="p">)</span>
            <span class="n">cm</span> <span class="o">=</span> <span class="n">c</span> <span class="o">%</span> <span class="n">D</span>
            <span class="n">rm</span> <span class="o">=</span> <span class="n">rhs</span> <span class="o">%</span> <span class="n">D</span>
            <span class="k">if</span> <span class="n">cm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rm</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">*</span> <span class="n">x0</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">:</span>
                    <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">lo1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">cm</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rm</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="n">m1</span> <span class="o">=</span> <span class="n">D</span> <span class="o">//</span> <span class="n">g</span>
            <span class="n">inv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">((</span><span class="n">cm</span><span class="o">//</span><span class="n">g</span><span class="p">)</span> <span class="o">%</span> <span class="n">m1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">rm</span><span class="o">//</span><span class="n">g</span><span class="p">)</span> <span class="o">*</span> <span class="n">inv</span> <span class="o">%</span> <span class="n">m1</span>
            <span class="n">g2</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">x1_mod</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x1_res</span><span class="p">)</span> <span class="o">%</span> <span class="n">g2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="n">lcm</span> <span class="o">=</span> <span class="n">x1_mod</span> <span class="o">//</span> <span class="n">g2</span> <span class="o">*</span> <span class="n">m1</span>
            <span class="n">k</span> <span class="o">=</span> <span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x1_res</span><span class="p">)</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">((</span><span class="n">x1_mod</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span>
            <span class="n">x1_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1_res</span> <span class="o">+</span> <span class="n">x1_mod</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">%</span> <span class="n">lcm</span>
            <span class="n">x1_mod</span> <span class="o">=</span> <span class="n">lcm</span>
            <span class="c1"># inequalities</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hi1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi1</span><span class="p">,</span> <span class="n">sdiv_floor</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lo1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo1</span><span class="p">,</span> <span class="n">sdiv_ceil</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">feasible</span> <span class="ow">or</span> <span class="n">hi1</span> <span class="o">&lt;</span> <span class="n">lo1</span> <span class="ow">or</span> <span class="n">x1_mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># endpoints</span>
        <span class="n">x1_min</span> <span class="o">=</span> <span class="n">lo1</span> <span class="o">+</span> <span class="p">(</span><span class="n">x1_res</span> <span class="o">-</span> <span class="n">lo1</span><span class="p">)</span> <span class="o">%</span> <span class="n">x1_mod</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">x1_min</span> <span class="o">&lt;=</span> <span class="n">hi1</span><span class="p">:</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1_min</span><span class="p">)</span>
        <span class="n">kmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi1</span> <span class="o">-</span> <span class="n">x1_res</span><span class="p">)</span> <span class="o">//</span> <span class="n">x1_mod</span>
        <span class="n">x1_max</span> <span class="o">=</span> <span class="n">x1_res</span> <span class="o">+</span> <span class="n">kmax</span> <span class="o">*</span> <span class="n">x1_mod</span>
        <span class="k">if</span> <span class="n">x1_max</span> <span class="o">&gt;=</span> <span class="n">lo1</span> <span class="ow">and</span> <span class="n">x1_max</span> <span class="o">&lt;=</span> <span class="n">hi1</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">candidates</span> <span class="ow">or</span> <span class="n">x1_max</span> <span class="o">!=</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x1_max</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x1</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b0</span><span class="p">)):</span>
                <span class="n">num</span> <span class="o">=</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">a0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">x0</span> <span class="o">-</span> <span class="n">a1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">x1</span>
                <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">num</span> <span class="o">%</span> <span class="n">D</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">num</span> <span class="o">//</span> <span class="n">D</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">x1</span>
            <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">s</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">build_A</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">k</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c1"># infeasible if any row zero</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;infeasible row&#39;</span><span class="p">)</span>
    <span class="c1"># rank and choose basis columns of size r minimizing |det|</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="n">rank_rows</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">best_det</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_C</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_adj</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">r</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">C</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
        <span class="n">dnum</span><span class="p">,</span> <span class="n">adj</span> <span class="o">=</span> <span class="n">det_and_adj</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ad</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dnum</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">best_det</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ad</span> <span class="o">&lt;</span> <span class="n">best_det</span><span class="p">:</span>
            <span class="n">best_det</span> <span class="o">=</span> <span class="n">ad</span>
            <span class="n">best_C</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dnum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">adj</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">adj</span><span class="p">]</span>
            <span class="n">best_adj</span> <span class="o">=</span> <span class="n">adj</span>
            <span class="k">if</span> <span class="n">ad</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">if</span> <span class="n">best_C</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no invertible basis&#39;</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">best_det</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">best_C</span>
    <span class="n">adj</span> <span class="o">=</span> <span class="n">best_adj</span>
    <span class="n">F</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">C</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="n">tR</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="c1"># b0 = adj * tR</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">adj</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">*</span><span class="n">tR</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">solve_d0</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no solution unique&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="c1"># M = adj * A[R,F]</span>
    <span class="n">ARF</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">F</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">sum</span><span class="p">(</span><span class="n">adj</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">*</span><span class="n">ARF</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">solve_d1</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># fallback try different basis columns? Unlucky choice of C can fail bounds enumerations? Try another C</span>
            <span class="n">alt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">C2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">r</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">C2</span><span class="p">)</span> <span class="o">==</span> <span class="n">C</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">B</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">C2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
                <span class="n">dnum</span><span class="p">,</span> <span class="n">adj2</span> <span class="o">=</span> <span class="n">det_and_adj</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">D2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dnum</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dnum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">adj2</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">adj2</span><span class="p">]</span>
                <span class="n">F2</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">C2</span><span class="p">]</span>
                <span class="n">ARF2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">F2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
                <span class="n">M2</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">sum</span><span class="p">(</span><span class="n">adj2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">*</span><span class="n">ARF2</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
                <span class="n">b02</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">adj2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">*</span><span class="n">tR</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
                <span class="n">res2</span> <span class="o">=</span> <span class="n">solve_d1</span><span class="p">(</span><span class="n">b02</span><span class="p">,</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">M2</span><span class="p">],</span> <span class="n">D2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">alt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">res2</span> <span class="o">&lt;</span> <span class="n">alt</span><span class="p">:</span>
                        <span class="n">alt</span> <span class="o">=</span> <span class="n">res2</span>
            <span class="k">if</span> <span class="n">alt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no solution d1&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">alt</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">solve_d2</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># try alternate bases</span>
            <span class="n">alt</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">C2</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">r</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">C2</span><span class="p">)</span> <span class="o">==</span> <span class="n">C</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">B</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">C2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
                <span class="n">dnum</span><span class="p">,</span> <span class="n">adj2</span> <span class="o">=</span> <span class="n">det_and_adj</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dnum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">D2</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dnum</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dnum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">adj2</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">adj2</span><span class="p">]</span>
                <span class="n">F2</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">C2</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">F2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">ARF2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">F2</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
                <span class="n">M2</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">sum</span><span class="p">(</span><span class="n">adj2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">*</span><span class="n">ARF2</span><span class="p">[</span><span class="n">s</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
                <span class="n">b02</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">adj2</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">s</span><span class="p">]</span><span class="o">*</span><span class="n">tR</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
                <span class="n">res2</span> <span class="o">=</span> <span class="n">solve_d2</span><span class="p">(</span><span class="n">b02</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">D2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">res2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">alt</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">res2</span> <span class="o">&lt;</span> <span class="n">alt</span><span class="p">:</span>
                        <span class="n">alt</span> <span class="o">=</span> <span class="n">res2</span>
            <span class="k">if</span> <span class="n">alt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no solution d2&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">alt</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="c1"># d == 3: coarse enumeration on x0 within bounds, then reduce to d==2 on remaining</span>
    <span class="c1"># bounds per var from rows ignoring other vars</span>
    <span class="n">lb</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">d</span>
    <span class="n">ub</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">]</span><span class="o">*</span><span class="n">d</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">hi</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">hi</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">sdiv_floor</span><span class="p">(</span><span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">a</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lo</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="n">sdiv_ceil</span><span class="p">(</span><span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">a</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">lo</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">lo</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">hi</span> <span class="o">==</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span><span class="p">:</span> <span class="n">hi</span> <span class="o">=</span> <span class="mi">1000000</span>
        <span class="n">lb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">lo</span>
        <span class="n">ub</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">hi</span>
    <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># pick var 0 for outer loop with smallest ub</span>
    <span class="n">order</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">ub</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">lb</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="n">main</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rest</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">order</span> <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">main</span><span class="p">]</span>
    <span class="c1"># derive progression for main from rows where other coefs 0 mod D</span>
    <span class="n">x_res</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">x_mod</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">lo</span> <span class="o">=</span> <span class="n">lb</span><span class="p">[</span><span class="n">main</span><span class="p">]</span>
    <span class="n">hi</span> <span class="o">=</span> <span class="n">ub</span><span class="p">[</span><span class="n">main</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">main</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">main</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span>
            <span class="n">bb</span> <span class="o">=</span> <span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="n">D</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bb</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bb</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">m1</span> <span class="o">=</span> <span class="n">D</span> <span class="o">//</span> <span class="n">g</span>
            <span class="n">inv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">((</span><span class="n">a</span><span class="o">//</span><span class="n">g</span><span class="p">)</span><span class="o">%</span><span class="n">m1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">bb</span><span class="o">//</span><span class="n">g</span><span class="p">)</span><span class="o">*</span><span class="n">inv</span> <span class="o">%</span> <span class="n">m1</span>
            <span class="n">g2</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">x_mod</span><span class="p">,</span> <span class="n">m1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x_res</span><span class="p">)</span> <span class="o">%</span> <span class="n">g2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">lcm</span> <span class="o">=</span> <span class="n">x_mod</span><span class="o">//</span><span class="n">g2</span> <span class="o">*</span> <span class="n">m1</span>
            <span class="n">k</span> <span class="o">=</span> <span class="p">((</span><span class="n">xi</span> <span class="o">-</span> <span class="n">x_res</span><span class="p">)</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">pow</span><span class="p">((</span><span class="n">x_mod</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">m1</span><span class="o">//</span><span class="n">g2</span><span class="p">)</span>
            <span class="n">x_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_res</span> <span class="o">+</span> <span class="n">x_mod</span> <span class="o">*</span> <span class="n">k</span><span class="p">)</span> <span class="o">%</span> <span class="n">lcm</span>
            <span class="n">x_mod</span> <span class="o">=</span> <span class="n">lcm</span>
    <span class="k">if</span> <span class="n">hi</span> <span class="o">&lt;</span> <span class="n">lo</span> <span class="ow">or</span> <span class="n">x_mod</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">lo</span> <span class="o">+</span> <span class="p">(</span><span class="n">x_res</span> <span class="o">-</span> <span class="n">lo</span><span class="p">)</span> <span class="o">%</span> <span class="n">x_mod</span>
    <span class="k">for</span> <span class="n">x0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">hi</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">x_mod</span><span class="p">):</span>
        <span class="c1"># reduce to d==2 with adjusted b0&#39; = b0 - M[:,main]*x0 and remaining two variables indices rest[0], rest[1]</span>
        <span class="n">b0p</span> <span class="o">=</span> <span class="p">[</span><span class="n">b0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">main</span><span class="p">]</span><span class="o">*</span><span class="n">x0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
        <span class="n">M2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">rest</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">rest</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">solve_d2</span><span class="p">(</span><span class="n">b0p</span><span class="p">,</span> <span class="n">M2</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val_total</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">x0</span>
            <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val_total</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">val_total</span>
    <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">ans</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solve_day10_part2_astar_strongpy"> solve_day10_part2_astar_strong.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T10:10:15.352914</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_26">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">heapq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">btn</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">btn</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
    <span class="c1"># Remove columns that touch zero-target counters</span>
    <span class="n">zero_mask</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">zero_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">zero_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Deduplicate</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span>


<span class="k">def</span><span class="w"> </span><span class="nf">precompute_caps</span><span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
    <span class="n">full</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span>
    <span class="n">cap</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
    <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">full</span><span class="p">):</span>
        <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">if</span> <span class="n">best</span> <span class="o">==</span> <span class="n">mask</span><span class="o">.</span><span class="n">bit_count</span><span class="p">():</span>
                    <span class="k">break</span>
        <span class="n">cap</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">best</span>
    <span class="n">max_cov</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="n">max_cov</span><span class="p">:</span>
            <span class="n">max_cov</span> <span class="o">=</span> <span class="n">w</span>
    <span class="k">return</span> <span class="n">cap</span><span class="p">,</span> <span class="n">max_cov</span>


<span class="k">def</span><span class="w"> </span><span class="nf">heuristic</span><span class="p">(</span><span class="n">rem</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">cap</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">max_cov</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span>
    <span class="n">pm</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maxr</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rem</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pm</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">v</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">maxr</span><span class="p">:</span>
                <span class="n">maxr</span> <span class="o">=</span> <span class="n">v</span>
    <span class="k">if</span> <span class="n">pm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># subset sums F[mask]</span>
    <span class="n">full</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">k</span>
    <span class="n">F</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">full</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rem</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span>
        <span class="c1"># add v to all masks containing bit</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">bit</span>
        <span class="k">while</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">full</span><span class="p">:</span>
            <span class="n">F</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">+=</span> <span class="n">v</span>
            <span class="c1"># iterate to next mask that includes bit, by adding bit to other combinations</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">bit</span><span class="p">)</span> <span class="o">|</span> <span class="n">bit</span>
            <span class="k">if</span> <span class="n">m</span> <span class="o">&gt;=</span> <span class="n">full</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="c1"># bound over masks subset of pm</span>
    <span class="n">hb</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">sub</span> <span class="o">=</span> <span class="n">pm</span>
    <span class="k">while</span> <span class="n">sub</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">F</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">cap</span><span class="p">[</span><span class="n">sub</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">10</span><span class="o">**</span><span class="mi">9</span>
            <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="n">c</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">c</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">hb</span><span class="p">:</span>
                <span class="n">hb</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pm</span>
    <span class="c1"># also sum bound by max_cov</span>
    <span class="k">if</span> <span class="n">total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">max_cov</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">max_cov</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">max_cov</span>
        <span class="k">if</span> <span class="n">b2</span> <span class="o">&gt;</span> <span class="n">hb</span><span class="p">:</span>
            <span class="n">hb</span> <span class="o">=</span> <span class="n">b2</span>
    <span class="k">if</span> <span class="n">maxr</span> <span class="o">&gt;</span> <span class="n">hb</span><span class="p">:</span>
        <span class="n">hb</span> <span class="o">=</span> <span class="n">maxr</span>
    <span class="k">return</span> <span class="n">hb</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="c1"># Filter trivial</span>
    <span class="n">active</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">active</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Remove rows with zero target implicitly by requiring allowed moves subset of positive indices</span>
    <span class="c1"># Quick infeasibility: any active i not covered by any column</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">active</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(((</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Infeasible: uncovered counter&#39;</span><span class="p">)</span>
    <span class="n">cap</span><span class="p">,</span> <span class="n">max_cov</span> <span class="o">=</span> <span class="n">precompute_caps</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="n">goal</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span><span class="p">)</span>
    <span class="c1"># A* search</span>
    <span class="n">pq</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">g0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">h0</span> <span class="o">=</span> <span class="n">heuristic</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">max_cov</span><span class="p">)</span>
    <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">pq</span><span class="p">,</span> <span class="p">(</span><span class="n">g0</span> <span class="o">+</span> <span class="n">h0</span><span class="p">,</span> <span class="n">g0</span><span class="p">,</span> <span class="n">start</span><span class="p">))</span>
    <span class="n">best_g</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">pq</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">rem</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">pq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">best_g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="mi">18</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">g</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">rem</span> <span class="o">==</span> <span class="n">goal</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span>
        <span class="c1"># positive mask</span>
        <span class="n">pm</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rem</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pm</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
        <span class="c1"># generate allowed moves: columns subset of pm</span>
        <span class="c1"># choose pivot i with largest rem to reduce branching</span>
        <span class="n">best_i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">best_v</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rem</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">best_v</span><span class="p">:</span>
                <span class="n">best_v</span> <span class="o">=</span> <span class="n">v</span>
                <span class="n">best_i</span> <span class="o">=</span> <span class="n">i</span>
        <span class="c1"># We&#39;ll try only columns that cover best_i and subset of pm</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="n">best_i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="n">pm</span><span class="p">)</span> <span class="o">!=</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">child</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rem</span><span class="p">)</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">child</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">child</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">child_t</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
            <span class="n">ng</span> <span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">best_g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">child_t</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">old</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ng</span> <span class="o">&gt;=</span> <span class="n">old</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">best_g</span><span class="p">[</span><span class="n">child_t</span><span class="p">]</span> <span class="o">=</span> <span class="n">ng</span>
            <span class="n">hh</span> <span class="o">=</span> <span class="n">heuristic</span><span class="p">(</span><span class="n">child_t</span><span class="p">,</span> <span class="n">cap</span><span class="p">,</span> <span class="n">max_cov</span><span class="p">)</span>
            <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">pq</span><span class="p">,</span> <span class="p">(</span><span class="n">ng</span> <span class="o">+</span> <span class="n">hh</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">child_t</span><span class="p">))</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Search failed&#39;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">targets</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">val</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="vizpy"> viz.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T10:11:38.300891</li>
<li><strong>Duration</strong>: 0.45s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="code_27">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">PIL</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_first_line</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="s1">&#39;input.txt&#39;</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[([.#]+)\]&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">lights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="p">[]</span>
                <span class="n">btns</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
                <span class="n">masks</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lights</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">btns</span><span class="p">:</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                            <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                                <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span>
                    <span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">lights</span><span class="p">,</span> <span class="n">masks</span>
    <span class="k">return</span> <span class="p">[],</span> <span class="p">[]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="n">lights</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="s1">&#39;visualization.png&#39;</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lights</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">masks</span><span class="p">)</span>
    <span class="n">W</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">40</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
    <span class="n">H</span> <span class="o">=</span> <span class="mi">220</span> <span class="o">+</span> <span class="mi">18</span> <span class="o">*</span> <span class="n">m</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">H</span><span class="p">),</span> <span class="s1">&#39;white&#39;</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">margin</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="n">spacing</span> <span class="o">=</span> <span class="p">(</span><span class="n">W</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">margin</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lights</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">spacing</span> <span class="o">+</span> <span class="n">spacing</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">r</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;gold&#39;</span> <span class="k">if</span> <span class="n">ch</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span> <span class="k">else</span> <span class="s1">&#39;lightgray&#39;</span>
        <span class="n">d</span><span class="o">.</span><span class="n">ellipse</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="n">r</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="n">r</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">r</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">14</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y0</span> <span class="o">+</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">16</span>
        <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">6</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;B</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">margin</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">spacing</span> <span class="o">+</span> <span class="n">spacing</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">d</span><span class="o">.</span><span class="n">rectangle</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="mi">6</span><span class="p">,</span> <span class="n">y</span> <span class="o">-</span> <span class="mi">6</span><span class="p">,</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">,</span> <span class="n">outline</span><span class="o">=</span><span class="s1">&#39;navy&#39;</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="n">H</span> <span class="o">-</span> <span class="mi">30</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;  : =</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">, =</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">lights</span><span class="p">,</span> <span class="n">masks</span> <span class="o">=</span> <span class="n">parse_first_line</span><span class="p">()</span>
    <span class="n">draw</span><span class="p">(</span><span class="n">lights</span><span class="p">,</span> <span class="n">masks</span><span class="p">)</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.indexes", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>