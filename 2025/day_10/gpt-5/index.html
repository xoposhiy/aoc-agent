
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../gemini-3-pro-preview/">
      
      
        <link rel="next" href="../gpt-5_1/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>2025 Day 10 - gpt-5 - AoC Agent Reports</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="cyan">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#2025-day-10-gpt-5" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="AoC Agent Reports" class="md-header__button md-logo" aria-label="AoC Agent Reports" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            AoC Agent Reports
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              2025 Day 10 - gpt-5
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="AoC Agent Reports" class="md-nav__button md-logo" aria-label="AoC Agent Reports" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    AoC Agent Reports
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mission Control Center
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    2025
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    2025
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 01
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 01
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_01/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_01/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_01/gemini-3-pro-preview_1/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview 1
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview 1
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_01/gemini-3-pro-preview_2/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview 2
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview 2
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_01/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_01/gpt-5-mini/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 mini
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 mini
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_01/gpt-5_1/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 1
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 1
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 02
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 02
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_02/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_02/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_02/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 03
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 03
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_03/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_03/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_03/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 04
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 04
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_04/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_04/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_04/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 05
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 05
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_05/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_05/gemini-2.5-flash/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 2.5 flash
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 2.5 flash
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_05/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_05/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_05/gpt-5-mini/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 mini
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 mini
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_05/gpt-5_1/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 1
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 1
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 06
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 06
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_06/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_06/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_06/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_06/gpt-5-mini/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 mini
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 mini
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 07
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 07
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_07/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_7_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_07/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_07/gemini-3-pro-preview_1/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview 1
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview 1
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_07/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_07/gpt-5_1/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 1
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 1
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
        
          
          <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 08
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 08
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_08/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_08/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_08/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_08/gpt-5-mini/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 mini
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_8_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 mini
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
        
          
          <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 09
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 09
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_09/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_9_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_09/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_9_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_09/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_9_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10" checked>
        
          
          <label class="md-nav__link" for="__nav_2_10" id="__nav_2_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 10
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 10
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_10_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_10_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10_2" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="./" class="md-nav__link md-nav__link--active">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_10_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_10_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../gpt-5_1/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 1
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_10_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_10_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 1
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_10_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../gpt-5_2/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5 2
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_10_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_10_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5 2
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11" >
        
          
          <label class="md-nav__link" for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 11
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 11
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_11/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_11_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_11/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_11_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_12" >
        
          
          <label class="md-nav__link" for="__nav_2_12" id="__nav_2_12_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Day 12
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_12">
            <span class="md-nav__icon md-icon"></span>
            
  
    Day 12
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_12_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_12/claude-opus-4-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Claude opus 4 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_12_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_12_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Claude opus 4 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_12_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_12/gemini-3-pro-preview/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gemini 3 pro preview
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_12_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_12_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gemini 3 pro preview
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_12_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../day_12/gpt-5/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Gpt 5
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_12_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_12_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Gpt 5
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="2025-day-10-gpt-5">2025 Day 10 - gpt-5</h1>
<ul>
<li><img alt="" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f916.svg" title=":robot:" /> <strong>Agent</strong>: MiniAgent (gpt-5)</li>
<li><img alt="" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/1f1f7-1f1fa.svg" title=":flag_ru:" /> <strong>Language</strong>: python</li>
<li><img alt="" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/23f1.svg" title=":stopwatch:" /> <strong>Duration</strong>: 2715.86s</li>
<li><img alt="" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/2b50.svg" title=":star:" /> <strong>Stars</strong>: P1:  | P2: </li>
</ul>
<h1 id="advent-of-code-2025-10">Advent of Code 2025   10: </h1>
<p>, -    !       .    ,     . ,        .</p>
<p>      ,    ,            .</p>
<hr />
<h2 id="_1">  </h2>
<ul>
<li> 1: 399</li>
<li> 2: 15631</li>
</ul>
<hr />
<h2 id="1-gf2"> 1:   GF(2)</h2>
<p>:     (#  , .  )   ,      .    ,     .</p>
<p>      GF(2):
A x  b (mod 2),  A       , x        2, b   .</p>
<ul>
<li>  (     ):    x0   . </li>
<li>       x.          (Gray code),  x XOR     , . </li>
<li>       BFS    (n  10  ).</li>
</ul>
<p>- (  ):
1) : <code>[.##.] (3) (1,3) (2) (0,2)</code>. 
2)  A:   (3)   4- ,  (1,3)  2-  4-,  
3)  A x = b,   x0    (    ). 
4)  4  : 00, 01, 10, 11   ;   . 
(   :  ?  .)</p>
<p>  :    = 399.</p>
<hr />
<h2 id="2-ilp"> 2:   -ILP</h2>
<p>   :      ,      .      1.     .</p>
<p>:   x_j  A x = t, x  0, x  Z^k.   ILP ( )   (m  10, k  13). , NP- ,   ,      (    ).</p>
<p>   :</p>
<p>1)   -.      B   A  det(B)=1,  B^{-1}  ,   x_P = B^{-1} t ( x_F=0)  .     .      .</p>
<p>2)  det(B)=D&gt;1,  : x_P = (adj(B)(tC x_F))/D.  u = adj(B)t  P = adj(B)C ( ).  :</p>
<ul>
<li>u  P x_F  0,</li>
<li>(u  P x_F)  0 (mod D),</li>
<li> = |x_F| + |x_P|,  x_P = (u  P x_F)/D.</li>
</ul>
<p>  DFS/--  x_F (  ):</p>
<ul>
<li>   u  P x_F  0,</li>
<li> : ceil(sum(u  P x_F)/D) +    x_F,</li>
<li>     ;</li>
<li>      D.</li>
</ul>
<p>3)   B ,  :       .      (   k  13, r  10).    det=1,    .</p>
<p>   ( ):  det(B)=2, adj(B) t = (6, 4, 8)^T,   P      (2, 0, 4)^T. </p>
<ul>
<li>u = (6,4,8),</li>
<li>u  P z = (62z, 40z, 84z),</li>
<li>  2   (62z), 4, (84z)  (  ),</li>
<li>  z  3  z  2,  z  {0,1,2}.
  ,     z + sum((uPz)/2).</li>
</ul>
<p>  :    = 15631.</p>
<p>  det=1   ?     B  : B^{-1} ,     LP  .      .</p>
<hr />
<h2 id="_2"></h2>
<p>  ,        :    ()   (),     .  ,   :     ,      .</p>
<p><img alt="   " src="viz_buttons.png" /></p>
<p>(      :        ?  .     ,    .)</p>
<hr />
<h2 id="_3">  </h2>
<ul>
<li> 1   GF(2).            .</li>
<li>  2    .   , +  :     .</li>
<li> A*    ,       .</li>
<li>Bareiss-          .</li>
</ul>
<hr />
<h2 id="_4"></h2>
<ul>
<li>ideas_part1.md      1.</li>
<li>ideas_part2.md      2.</li>
<li>solver2_final.py     (   ).</li>
<li>viz_generate.py    viz_buttons.png.</li>
<li>final_report.md   .</li>
</ul>
<p>     ( 1),  GCD   ,   .        ,  ,   .  ,      42,     .</p>
<h1 id="code-executions">Code Executions</h1>
<h2 id="peek_statspy"> peek_stats.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T15:43:07.109707</li>
<li><strong>Duration</strong>: 0.11s</li>
<li><strong>Exit Code</strong>: 2</li>
<li><strong>Error</strong>: Non-zero exit code</li>
</ul>
<h3 id="stderr">Stderr</h3>
<div class="highlight"><pre><span></span><code>C:\work\aoc\aoc-agent\.venv\Scripts\python.exe: can&#39;t open file &#39;C:\\work\\aoc\\aoc-agent\\data\\run\\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\\peek_stats.py&#39;: [Errno 2] No such file or directory
</code></pre></div>
<h3 id="code">Code</h3>
<div class="highlight"><pre><span></span><code><span class="n">Code</span> <span class="n">file</span> <span class="ow">not</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">run</span> <span class="n">directory</span><span class="o">.</span>
</code></pre></div>
<h2 id="solverpy"> solver.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T15:45:22.126968</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_1">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>

<span class="c1"># Parse input</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="c1"># Extract pattern inside []</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[(.*?)\]&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">]</span>
    <span class="c1"># Extract all parentheses groups</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
    <span class="c1"># Ignore curly braces</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_matrix</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="c1"># A: n x k boolean matrix</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>  <span class="c1"># each row is k-bit integer</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Out-of-range toggle indices? ignore or raise</span>
                <span class="k">pass</span>
    <span class="k">return</span> <span class="n">rows</span><span class="p">,</span> <span class="n">k</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rref</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="c1"># rows: list of int masks length k</span>
    <span class="c1"># b: list of 0/1 length n</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[:]</span>  <span class="c1"># copy</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">[:]</span>  <span class="c1"># copy</span>
    <span class="n">pivot_row_of_col</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k</span>
    <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="c1"># find pivot: row with bit col set starting from row</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">col</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">r</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">sel</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># swap row and sel</span>
        <span class="k">if</span> <span class="n">sel</span> <span class="o">!=</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">rows</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">sel</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
            <span class="n">b</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">sel</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="c1"># eliminate all other rows</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">row</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">):</span>
                <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">^=</span> <span class="n">rows</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
                <span class="n">b</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">^=</span> <span class="n">b</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="n">pivot_row_of_col</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="c1"># Check consistency: any zero row with b==1</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>  <span class="c1"># no solution</span>
    <span class="k">return</span> <span class="n">rows</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">pivot_row_of_col</span>


<span class="k">def</span><span class="w"> </span><span class="nf">particular_and_nullspace</span><span class="p">(</span><span class="n">rows_rref</span><span class="p">,</span> <span class="n">b_rref</span><span class="p">,</span> <span class="n">pivot_row_of_col</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="c1"># Build x0 and nullspace basis as list of ints (k-bit)</span>
    <span class="n">kbits</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pivot_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pivot_row_of_col</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pivot_row_by_col</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">pivot_row_of_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pivot_cols</span><span class="p">}</span>
    <span class="n">free_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="n">pivot_row_of_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Particular solution: set free vars to 0, pivot var equals RHS</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pivot_cols</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pivot_row_by_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">b_rref</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">)</span>
    <span class="c1"># Nullspace basis: for each free column f, vector with bit f=1, and pivot bits rows[pivot][f]</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">free_cols</span><span class="p">:</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">vec</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">mask_f</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">f</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pivot_cols</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">pivot_row_by_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">rows_rref</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask_f</span><span class="p">:</span>
                <span class="n">vec</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x0</span><span class="p">,</span> <span class="n">basis</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_min_presses</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">rows</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">build_matrix</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
    <span class="c1"># Inconsistent if target lights include positions that no button can toggle odd number of times</span>
    <span class="n">rows_rref</span><span class="p">,</span> <span class="n">b_rref</span><span class="p">,</span> <span class="n">piv</span> <span class="o">=</span> <span class="n">rref</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rows_rref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># As a fallback, BFS over states to verify impossible; but assume solvable per problem</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">basis</span> <span class="o">=</span> <span class="n">particular_and_nullspace</span><span class="p">(</span><span class="n">rows_rref</span><span class="p">,</span> <span class="n">b_rref</span><span class="p">,</span> <span class="n">piv</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
    <span class="c1"># If d is small, enumerate all combinations via Gray code to avoid recomputing from scratch</span>
    <span class="c1"># Otherwise, try BFS over states if n &lt;= 22; else split enumeration with pruning using heuristic</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">best</span>
    <span class="c1"># Decide strategy</span>
    <span class="n">max_enum</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">d</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="mi">24</span><span class="p">:</span>
        <span class="c1"># Gray code enumeration</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="n">best</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
        <span class="c1"># Gray code over d bits</span>
        <span class="n">prev_gray</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_enum</span><span class="p">):</span>
            <span class="n">gray</span> <span class="o">=</span> <span class="n">g</span> <span class="o">^</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">prev_gray</span> <span class="o">^</span> <span class="n">gray</span>
            <span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">diff</span><span class="p">)</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># index of changed bit</span>
            <span class="n">vec</span> <span class="o">^=</span> <span class="n">basis</span><span class="p">[</span><span class="n">bit</span><span class="p">]</span>
            <span class="n">bc</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bc</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">bc</span>
            <span class="n">prev_gray</span> <span class="o">=</span> <span class="n">gray</span>
        <span class="k">return</span> <span class="n">best</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Try BFS over states if lights small</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">22</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bfs_min_presses</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="c1"># Meet-in-the-middle heuristic: sample random subset? Instead we can do greedy local search from x0 flipping basis vectors if it decreases weight until no improvement; repeat random restarts.</span>
        <span class="c1"># As AoC puzzles are designed to be solvable, assume this path won&#39;t trigger often. We&#39;ll implement a simple hill-climbing with limited iterations.</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="n">improved</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">improved</span> <span class="ow">and</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">improved</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># Try flipping any basis vector that reduces weight</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">new_vec</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">^</span> <span class="n">basis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">new_vec</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">vec</span><span class="o">.</span><span class="n">bit_count</span><span class="p">():</span>
                    <span class="n">vec</span> <span class="o">=</span> <span class="n">new_vec</span>
                    <span class="n">improved</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">attempts</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">vec</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bfs_min_presses</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="c1"># BFS over state space of lights (n bits), moves toggle specified indices</span>
    <span class="n">tgt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">tgt</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">moves</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">moves</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">tgt</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">dq</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="n">start</span><span class="p">])</span>
    <span class="k">while</span> <span class="n">dq</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">dq</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">seen</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">moves</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">s</span> <span class="o">^</span> <span class="n">mv</span>
            <span class="k">if</span> <span class="n">ns</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ns</span> <span class="o">==</span> <span class="n">tgt</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">nd</span>
                <span class="n">seen</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd</span>
                <span class="n">dq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">machines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">machines</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">))</span>
    <span class="n">totals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span> <span class="ow">in</span> <span class="n">machines</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">solve_min_presses</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># fallback BFS always</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">bfs_min_presses</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="s2">&quot;No solution found for a machine&quot;</span><span class="p">)</span>
        <span class="n">totals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">res</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solverpy_1"> solver.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T15:45:49.622994</li>
<li><strong>Duration</strong>: 0.12s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout">Stdout</h3>
<div class="highlight"><pre><span></span><code>399
</code></pre></div>
<h3 id="code_2">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>

<span class="c1"># Parse input from file input.txt</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[(.*?)\]&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">]</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_matrix</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="n">maskj</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">maskj</span>
    <span class="k">return</span> <span class="n">rows</span><span class="p">,</span> <span class="n">k</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rref</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[:]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">[:]</span>
    <span class="n">pivot_row_of_col</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k</span>
    <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">col</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">r</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">sel</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">sel</span> <span class="o">!=</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">rows</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">sel</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
            <span class="n">b</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">sel</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="c1"># eliminate other rows</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">row</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">):</span>
                <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">^=</span> <span class="n">rows</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
                <span class="n">b</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">^=</span> <span class="n">b</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="n">pivot_row_of_col</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">rows</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">pivot_row_of_col</span>


<span class="k">def</span><span class="w"> </span><span class="nf">particular_and_nullspace</span><span class="p">(</span><span class="n">rows_rref</span><span class="p">,</span> <span class="n">b_rref</span><span class="p">,</span> <span class="n">pivot_row_of_col</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">pivot_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pivot_row_of_col</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pivot_row_by_col</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">pivot_row_of_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pivot_cols</span><span class="p">}</span>
    <span class="n">free_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="n">pivot_row_of_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pivot_cols</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pivot_row_by_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">b_rref</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">free_cols</span><span class="p">:</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">f</span>
        <span class="n">mask_f</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">f</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pivot_cols</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">pivot_row_by_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">rows_rref</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask_f</span><span class="p">:</span>
                <span class="n">vec</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x0</span><span class="p">,</span> <span class="n">basis</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bfs_min_presses</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">tgt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">tgt</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">moves</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">moves</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">tgt</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">dq</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="n">start</span><span class="p">])</span>
    <span class="k">while</span> <span class="n">dq</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">dq</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">seen</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">moves</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">s</span> <span class="o">^</span> <span class="n">mv</span>
            <span class="k">if</span> <span class="n">ns</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ns</span> <span class="o">==</span> <span class="n">tgt</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">nd</span>
                <span class="n">seen</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd</span>
                <span class="n">dq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_min_presses</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">rows</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">build_matrix</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
    <span class="n">rows_rref</span><span class="p">,</span> <span class="n">b_rref</span><span class="p">,</span> <span class="n">piv</span> <span class="o">=</span> <span class="n">rref</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rows_rref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">bfs_min_presses</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">basis</span> <span class="o">=</span> <span class="n">particular_and_nullspace</span><span class="p">(</span><span class="n">rows_rref</span><span class="p">,</span> <span class="n">b_rref</span><span class="p">,</span> <span class="n">piv</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">best</span>
    <span class="c1"># Enumerate nullspace if small</span>
    <span class="k">if</span> <span class="n">d</span> <span class="o">&lt;=</span> <span class="mi">24</span><span class="p">:</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">x0</span>
        <span class="n">best</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
        <span class="n">prev_gray</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">d</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">total</span><span class="p">):</span>
            <span class="n">gray</span> <span class="o">=</span> <span class="n">g</span> <span class="o">^</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">prev_gray</span> <span class="o">^</span> <span class="n">gray</span>
            <span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">diff</span><span class="p">)</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">vec</span> <span class="o">^=</span> <span class="n">basis</span><span class="p">[</span><span class="n">bit</span><span class="p">]</span>
            <span class="n">bc</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">bc</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">bc</span>
            <span class="n">prev_gray</span> <span class="o">=</span> <span class="n">gray</span>
        <span class="k">return</span> <span class="n">best</span>
    <span class="c1"># Try greedy improvement from x0</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="n">improved</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">loops</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">improved</span> <span class="ow">and</span> <span class="n">loops</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">improved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">nv</span> <span class="o">=</span> <span class="n">vec</span> <span class="o">^</span> <span class="n">basis</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">nv</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">vec</span><span class="o">.</span><span class="n">bit_count</span><span class="p">():</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="n">nv</span>
                <span class="n">improved</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">loops</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">vec</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">machines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parsed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">machines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parsed</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span> <span class="ow">in</span> <span class="n">machines</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">solve_min_presses</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="s1">&#39;No solution for a machine&#39;</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">res</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="-c"> -c</h2>
<p>import re,sys
s=open('input.txt','r',encoding='utf-8').read().strip().splitlines()
stats=[]
for line in s:
    m=re.search(r"[(.<em>?)]",line)
    lights=len(m.group(1)) if m else None
    buttons=[grp.group(1) for grp in re.finditer(r"<span class="arithmatex">\(([^)]*)\)</span>", line)]
    k=len(buttons)
    nums=re.search(r"{([^}]</em>)}",line)
    arr=[int(x) for x in nums.group(1).split(',')] if nums else []
    stats.append((lights,k,len(arr),max(arr) if arr else 0,sum(arr)))
print('lines',len(stats))
print('max lights',max(t[0] for t in stats))
print('max buttons',max(t[1] for t in stats))
print('max counters',max(t[2] for t in stats))
print('max t_i',max(t[3] for t in stats))
print('max sum_t',max(t[4] for t in stats))
print('avg counters',sum(t[2] for t in stats)/len(stats))
print('avg buttons',sum(t[1] for t in stats)/len(stats))
print('avg sum_t',sum(t[4] for t in stats)/len(stats))
print('hist counters:')
from collections import Counter
c=Counter(t[2] for t in stats)
print(sorted(c.items()))
print('hist max t_i:')
c2=Counter(t[3] for t in stats)
print(sorted(list(c2.items()))[:10],'...')
print('top max t_i',sorted(c2.items(), key=lambda x:-x[0])[:10])</p>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T15:47:13.593101</li>
<li><strong>Duration</strong>: 0.09s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout_1">Stdout</h3>
<div class="highlight"><pre><span></span><code>lines 157
max lights 10
max buttons 13
max counters 10
max t_i 254
max sum_t 1604
avg counters 7.127388535031847
avg buttons 7.222929936305732
avg sum_t 388.5222929936306
hist counters:
[(4, 20), (5, 24), (6, 21), (7, 21), (8, 22), (9, 20), (10, 29)]
hist max t_i:
[(15, 1), (21, 1), (23, 3), (25, 3), (26, 2), (27, 1), (28, 1), (29, 1), (30, 5), (31, 1)] ...
top max t_i [(254, 1), (246, 1), (244, 1), (240, 2), (236, 1), (227, 2), (226, 1), (220, 1), (213, 2), (212, 2)]
</code></pre></div>
<h3 id="code_3">Code</h3>
<div class="highlight"><pre><span></span><code>Code file not found in run directory.
</code></pre></div>
<h2 id="-c_1"> -c</h2>
<p>from fractions import Fraction
import re
s=open('input.txt','r').read().splitlines()</p>
<p>def parse(line):
    m=re.search(r"{([^}]*)}",line)
    t=[int(x) for x in m.group(1).split(',')]
    m2=[grp.group(1) for grp in re.finditer(r"<span class="arithmatex">\(([^)]*)\)</span>",line)]
    buttons=[[int(x) for x in g.split(',')] if g.strip() else [] for g in m2]
    return t, buttons</p>
<p>def build_A(t, buttons):
    m=len(t); k=len(buttons)
    A=[[0]*k for _ in range(m)]
    for j,idxs in enumerate(buttons):
        for i in idxs:
            if 0&lt;=i&lt;m:
                A[i][j]=1
    return A</p>
<p>def rank_rational(A):
    m=len(A); n=len(A[0]) if m else 0
    M=[[Fraction(A[i][j]) for j in range(n)] for i in range(m)]
    r=0; c=0
    rows=list(range(m))
    while r&lt;m and c&lt;n:
        piv=None
        for i in range(r,m):
            if M[i][c]!=0:
                piv=i; break
        if piv is None:
            c+=1; continue
        if piv!=r:
            M[r],M[piv]=M[piv],M[r]
        pivv=M[r][c]
        for i in range(m):
            if i!=r and M[i][c]!=0:
                f=M[i][c]/pivv
                for j in range(c,n):
                    M[i][j]-=f*M[r][j]
        r+=1; c+=1
    return r</p>
<p>from itertools import combinations</p>
<p>def det_int(M):
    # Bareiss
    import copy
    n=len(M)
    if n==0: return 1
    A=[row[:] for row in M]
    det=1
    prev=1
    for k in range(n-1):
        # find pivot
        piv=k
        while piv&lt;n and A[piv][k]==0:
            piv+=1
        if piv==n:
            return 0
        if piv!=k:
            A[k],A[piv]=A[piv],A[k]
            det=-det
        pivv=A[k][k]
        for i in range(k+1,n):
            for j in range(k+1,n):
                A[i][j]=(A[i][j]<em>pivv - A[i][k]</em>A[k][j])//prev
            A[i][k]=0
        prev=pivv
    det*=A[n-1][n-1]
    return det</p>
<p>stats=[]
nullities=[]
unimod_ok=0
machines=[]
for line in s:
    if not line.strip():
        continue
    t,buttons=parse(line)
    A=build_A(t,buttons)
    m=len(t); k=len(buttons)
    r=rank_rational(A)
    d=k-r
    nullities.append(d)
    # choose r independent rows: assume first r via elimination? For check det unimod, we use all rows if r==m, else drop dependent rows greedily.
    # We'll just brute force choose r rows set with rank r minimal index
    import itertools
    row_idxs=list(range(m))
    found_rows=None
    for rows_sel in itertools.combinations(row_idxs, r):
        Ar=[A[i] for i in rows_sel]
        if rank_rational(Ar)==r:
            found_rows=rows_sel; break
    if found_rows is None:
        found_rows=tuple(range(r))
    Ar=[A[i] for i in found_rows]
    if r==0:
        unimod_ok+=1
        continue
    # Scan combos of r columns
    ok=False
    for cols in combinations(range(k), r):
        M=[[Ar[i][j] for j in cols] for i in range(r)]
        ddet=det_int(M)
        if abs(ddet)==1:
            ok=True; break
    if ok:
        unimod_ok+=1
machines=len(nullities)
print('machines',machines)
print('nullity distribution', {i:nullities.count(i) for i in sorted(set(nullities))})
print('unimodular basis possible count', unimod_ok)</p>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T15:49:41.194071</li>
<li><strong>Duration</strong>: 0.30s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout_2">Stdout</h3>
<div class="highlight"><pre><span></span><code>machines 157
nullity distribution {0: 81, 1: 36, 2: 32, 3: 8}
unimodular basis possible count 115
</code></pre></div>
<h3 id="code_4">Code</h3>
<div class="highlight"><pre><span></span><code>Code file not found in run directory.
</code></pre></div>
<h2 id="solver2py"> solver2.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T15:55:02.416432</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_5">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>

<span class="c1"># Part 1 solver from earlier</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[(.*?)\]&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">]</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
    <span class="c1"># Extract joltage</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">jolts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">m2</span><span class="p">:</span>
        <span class="n">jtxt</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jtxt</span><span class="p">:</span>
            <span class="n">jolts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jtxt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">,</span> <span class="n">jolts</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_matrix_bool</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="n">maskj</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">maskj</span>
    <span class="k">return</span> <span class="n">rows</span><span class="p">,</span> <span class="n">k</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rref</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[:]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">[:]</span>
    <span class="n">pivot_row_of_col</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k</span>
    <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">col</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">r</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">sel</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">sel</span> <span class="o">!=</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">rows</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">sel</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
            <span class="n">b</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">sel</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="c1"># eliminate other rows</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">row</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">):</span>
                <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">^=</span> <span class="n">rows</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
                <span class="n">b</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">^=</span> <span class="n">b</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="n">pivot_row_of_col</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">rows</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">pivot_row_of_col</span>


<span class="k">def</span><span class="w"> </span><span class="nf">particular_and_nullspace</span><span class="p">(</span><span class="n">rows_rref</span><span class="p">,</span> <span class="n">b_rref</span><span class="p">,</span> <span class="n">pivot_row_of_col</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">pivot_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pivot_row_of_col</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pivot_row_by_col</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">pivot_row_of_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pivot_cols</span><span class="p">}</span>
    <span class="n">free_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="n">pivot_row_of_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pivot_cols</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pivot_row_by_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">b_rref</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">free_cols</span><span class="p">:</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">f</span>
        <span class="n">mask_f</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">f</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pivot_cols</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">pivot_row_by_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">rows_rref</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask_f</span><span class="p">:</span>
                <span class="n">vec</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x0</span><span class="p">,</span> <span class="n">basis</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bfs_min_presses</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">tgt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
            <span class="n">tgt</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">moves</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">moves</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">tgt</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">dq</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="n">start</span><span class="p">])</span>
    <span class="k">while</span> <span class="n">dq</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">dq</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">seen</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
        <span class="n">nd</span> <span class="o">=</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">moves</span><span class="p">:</span>
            <span class="n">ns</span> <span class="o">=</span> <span class="n">s</span> <span class="o">^</span> <span class="n">mv</span>
            <span class="k">if</span> <span class="n">ns</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ns</span> <span class="o">==</span> <span class="n">tgt</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">nd</span>
                <span class="n">seen</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd</span>
                <span class="n">dq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_part1</span><span class="p">(</span><span class="n">machines</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">machines</span><span class="p">:</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">build_matrix_bool</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="n">rows_rref</span><span class="p">,</span> <span class="n">b_rref</span><span class="p">,</span> <span class="n">piv</span> <span class="o">=</span> <span class="n">rref</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rows_rref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">bfs_min_presses</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="s1">&#39;No solution for part1 machine&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">basis</span> <span class="o">=</span> <span class="n">particular_and_nullspace</span><span class="p">(</span><span class="n">rows_rref</span><span class="p">,</span> <span class="n">b_rref</span><span class="p">,</span> <span class="n">piv</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">vec</span> <span class="o">=</span> <span class="n">x0</span>
                <span class="n">prev_gray</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">total_comb</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">d</span>
                <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">total_comb</span><span class="p">):</span>
                    <span class="n">gray</span> <span class="o">=</span> <span class="n">g</span> <span class="o">^</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="n">prev_gray</span> <span class="o">^</span> <span class="n">gray</span>
                    <span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">diff</span><span class="p">)</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">vec</span> <span class="o">^=</span> <span class="n">basis</span><span class="p">[</span><span class="n">bit</span><span class="p">]</span>
                    <span class="n">bc</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">bc</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                        <span class="n">best</span> <span class="o">=</span> <span class="n">bc</span>
                    <span class="n">prev_gray</span> <span class="o">=</span> <span class="n">gray</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">best</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">res</span>
    <span class="k">return</span> <span class="n">total</span>

<span class="c1"># Part 2 ILP solver via DFS with pruning</span>

<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine_part2</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">jolts</span><span class="p">[:]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="c1"># Drop buttons with empty effect or indices out of range</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="c1"># Build bitmasks and bounds</span>
    <span class="n">row_masks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># per column j, bitmask of rows affected</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">U</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">min_t</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">min_t</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_t</span><span class="p">:</span>
                <span class="n">min_t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">row_masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="n">U</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">min_t</span> <span class="k">if</span> <span class="n">min_t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1"># Greedy upper bound</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">greedy_upper</span><span class="p">():</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">t</span><span class="p">[:]</span>
        <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cost</span>
            <span class="c1"># choose j that covers most positive residuals</span>
            <span class="n">bestj</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">bestcov</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row_masks</span><span class="p">):</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># Also compute min residual among covered &gt;0</span>
                <span class="n">mm</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">cov</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">mm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mm</span><span class="p">:</span>
                            <span class="n">mm</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">cov</span><span class="o">&gt;</span><span class="n">bestcov</span> <span class="ow">and</span> <span class="n">mm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mm</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">bestcov</span> <span class="o">=</span> <span class="n">cov</span>
                    <span class="n">bestj</span> <span class="o">=</span> <span class="n">j</span>
                    <span class="n">bestmm</span> <span class="o">=</span> <span class="n">mm</span>
            <span class="k">if</span> <span class="n">bestj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># no button can reduce remaining positive residuals -&gt; impossible</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="n">use</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bestmm</span><span class="p">,</span> <span class="n">U</span><span class="p">[</span><span class="n">bestj</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">use</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># shouldn&#39;t happen</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="n">cost</span> <span class="o">+=</span> <span class="n">use</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">row_masks</span><span class="p">[</span><span class="n">bestj</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">use</span>
                    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">best_global</span> <span class="o">=</span> <span class="n">greedy_upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">best_global</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
        <span class="c1"># fallback minimal is sum t (press singletons)</span>
        <span class="n">best_global</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="c1"># Prepare recursion</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>

    <span class="c1"># Order buttons by weight descending, then by U</span>
    <span class="n">order</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">weights</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="o">-</span><span class="n">U</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>

    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">rem_mask</span><span class="p">,</span> <span class="n">r_tuple</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">best_global</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">r_tuple</span><span class="p">)</span>
        <span class="c1"># Fast exit</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">==</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># Build list of remaining columns</span>
        <span class="n">rem_js</span> <span class="o">=</span> <span class="p">[</span><span class="n">order</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">rem_mask</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rem_js</span><span class="p">:</span>
            <span class="c1"># no buttons left</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="c1"># Forced assignments loop</span>
        <span class="n">assigned</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">changed</span><span class="p">:</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># coverage count per row</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="n">cover</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rem_mask</span><span class="o">&gt;&gt;</span><span class="n">oi</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">row_masks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">cover</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">oi</span><span class="p">)</span>
            <span class="c1"># Check zero-cover infeasibility and single-cover forcing</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cover</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cover</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">oi</span> <span class="o">=</span> <span class="n">cover</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">U</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                    <span class="n">prev</span> <span class="o">=</span> <span class="n">assigned</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">oi</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">prev</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">assigned</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                        <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">prev</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
                            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="c1"># Apply assignments if any</span>
            <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                <span class="c1"># apply all currently assigned changes to r and rem_mask, but avoid double-applying</span>
                <span class="k">for</span> <span class="n">oi</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">assigned</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># remove j</span>
                        <span class="n">rem_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">oi</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">row_masks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="c1"># Reduce r</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">val</span>
                    <span class="c1"># Remove button from remaining</span>
                    <span class="n">rem_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">oi</span><span class="p">)</span>
                <span class="n">assigned</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="c1"># Now compute bounds</span>
        <span class="c1"># Capacity check</span>
        <span class="n">cap</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">m</span>
        <span class="n">wmax</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rem_mask</span><span class="o">&gt;&gt;</span><span class="n">oi</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span>
                <span class="n">wmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">wmax</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">row_masks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">cap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">U</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">cap</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">wmax</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># no effect remaining</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># Lower bounds</span>
        <span class="n">S</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">lb1</span> <span class="o">=</span> <span class="p">(</span><span class="n">S</span> <span class="o">+</span> <span class="n">wmax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">wmax</span>
        <span class="n">lb2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="c1"># pairwise bound</span>
        <span class="n">lb_pair</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Precompute per remaining button coverage vector for quick pair cmax</span>
        <span class="n">pair_cmax</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">for</span> <span class="n">k2</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">k2</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">cm</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">rem_mask</span><span class="o">&gt;&gt;</span><span class="n">oi</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="p">((</span><span class="n">row_masks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">row_masks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="n">k2</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">cm</span><span class="p">:</span>
                            <span class="n">cm</span> <span class="o">=</span> <span class="n">a</span>
                            <span class="k">if</span> <span class="n">cm</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="k">break</span>
                <span class="k">if</span> <span class="n">cm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">r</span><span class="p">[</span><span class="n">k2</span><span class="p">]</span> <span class="o">+</span> <span class="n">cm</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">cm</span>
                <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="n">lb_pair</span><span class="p">:</span>
                    <span class="n">lb_pair</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lb1</span><span class="p">,</span> <span class="n">lb2</span><span class="p">,</span> <span class="n">lb_pair</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lb</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="c1"># Best-first prune using global best</span>
        <span class="c1"># We don&#39;t know current cost at this node; caller adds returned value</span>
        <span class="c1"># So just return lb if lb &gt;= best_global? No; we need to check when called with current g.</span>

        <span class="c1"># Choose next variable to branch: pick one that intersects positive r most, with small local max value</span>
        <span class="n">next_oi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">max_xj</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">oi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rem_mask</span><span class="o">&gt;&gt;</span><span class="n">oi</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">oi</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">row_masks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">local_max</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># compute max assign allowed by residual</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">cov</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">v</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">local_max</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="n">local_max</span><span class="p">:</span>
                            <span class="n">local_max</span> <span class="o">=</span> <span class="n">v</span>
            <span class="k">if</span> <span class="n">cov</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">local_max</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">local_max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># This button cannot help; skip by setting its value to 0</span>
                <span class="n">rem_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">oi</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">local_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">local_max</span><span class="p">,</span> <span class="n">U</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">local_max</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rem_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">oi</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">cov</span><span class="o">*</span><span class="mi">10</span> <span class="o">+</span> <span class="n">weights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">:</span>
                <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span>
                <span class="n">next_oi</span> <span class="o">=</span> <span class="n">oi</span>
                <span class="n">max_xj</span> <span class="o">=</span> <span class="n">local_max</span>
        <span class="k">if</span> <span class="n">next_oi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># no helpful button left</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># Recurse by trying values for this button from 0..max_xj, but try a heuristic: try value = max_xj first maybe to reduce depth? But we want minimal cost, so try 0..max</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">next_oi</span><span class="p">]</span>
        <span class="n">maskj</span> <span class="o">=</span> <span class="n">row_masks</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">best_here</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="c1"># Precompute candidate values: we can try values that match one of r[i] for i covered, because any value larger than smallest r[i] will zero one row; But combinations of sum of distinct may be beneficial; However we will iterate 0..max_xj.</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_xj</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Partial lower bound prune on value progression</span>
            <span class="c1"># Compute quick lower bound after choosing val: new residual sum S&#39; = S - val*weights[j]</span>
            <span class="n">S2</span> <span class="o">=</span> <span class="n">S</span> <span class="o">-</span> <span class="n">val</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">S2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Quick LB with wmax2 same as wmax but if this button was wmax and val &lt; something doesn&#39;t change bound; safe to use lb1&#39; = ceil(S2 / wmax)</span>
            <span class="n">lb_after</span> <span class="o">=</span> <span class="p">(</span><span class="n">S2</span> <span class="o">+</span> <span class="n">wmax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">wmax</span>
            <span class="c1"># Also single max bound adjust</span>
            <span class="c1"># compute new max r_i quickly</span>
            <span class="n">max_after</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># We&#39;ll compute updated r inline; but for bound we can upper bound by r_max if val&gt;0 maybe reduces though</span>
            <span class="c1"># Combine bound</span>
            <span class="k">if</span> <span class="n">lb_after</span> <span class="o">&gt;=</span> <span class="n">best_here</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Apply val</span>
            <span class="n">r_new</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:]</span>
            <span class="k">if</span> <span class="n">val</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">maskj</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">r_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">val</span>
                        <span class="k">if</span> <span class="n">r_new</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Recurse</span>
                    <span class="n">rem2</span> <span class="o">=</span> <span class="n">rem_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">next_oi</span><span class="p">)</span>
                    <span class="n">sub</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="n">rem2</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">r_new</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">sub</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
                        <span class="n">cand</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="n">sub</span>
                        <span class="k">if</span> <span class="n">cand</span> <span class="o">&lt;</span> <span class="n">best_here</span><span class="p">:</span>
                            <span class="n">best_here</span> <span class="o">=</span> <span class="n">cand</span>
                    <span class="k">continue</span>
                <span class="c1"># had negative residual, skip</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># val = 0</span>
                <span class="n">rem2</span> <span class="o">=</span> <span class="n">rem_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">next_oi</span><span class="p">)</span>
                <span class="n">sub</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="n">rem2</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">r_new</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">sub</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
                    <span class="n">cand</span> <span class="o">=</span> <span class="n">sub</span>
                    <span class="k">if</span> <span class="n">cand</span> <span class="o">&lt;</span> <span class="n">best_here</span><span class="p">:</span>
                        <span class="n">best_here</span> <span class="o">=</span> <span class="n">cand</span>
        <span class="k">return</span> <span class="n">best_here</span>

    <span class="c1"># initial mask: all buttons on according to order index</span>
    <span class="n">init_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">ans</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="n">init_mask</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ans</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_part2</span><span class="p">(</span><span class="n">machines</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">,</span> <span class="n">jolts</span> <span class="ow">in</span> <span class="n">machines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">jolts</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">solve_machine_part2</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
            <span class="c1"># fallback naive upper bound sum jolts</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">res</span>
    <span class="k">return</span> <span class="n">total</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">machines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">machines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
    <span class="n">part1</span> <span class="o">=</span> <span class="n">solve_part1</span><span class="p">(</span><span class="n">machines</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">part1</span><span class="p">)</span>
    <span class="n">part2</span> <span class="o">=</span> <span class="n">solve_part2</span><span class="p">(</span><span class="n">machines</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">part2</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solver_part2py"> solver_part2.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T15:59:38.749647</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_6">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">jolts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">m2</span><span class="p">:</span>
        <span class="n">jtxt</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jtxt</span><span class="p">:</span>
            <span class="n">jolts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jtxt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">jolts</span>


<span class="k">def</span><span class="w"> </span><span class="nf">row_basis_indices</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="c1"># Return indices of linearly independent rows (over rationals)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Fraction</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
        <span class="c1"># eliminate other rows</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">det_int</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">M</span><span class="p">]</span>
    <span class="n">det</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">det</span> <span class="o">=</span> <span class="o">-</span><span class="n">det</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">pivv</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">//</span> <span class="n">prev</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">pivv</span>
    <span class="n">det</span> <span class="o">*=</span> <span class="n">A</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">det</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_dual_vertices</span><span class="p">(</span><span class="n">Ar</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">r</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="c1"># Compute w_max</span>
    <span class="n">w_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Enumerate subsets of columns of size r with det != 0</span>
    <span class="c1"># Build square matrix as transpose of selected columns: (r x r)</span>
    <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">r</span><span class="p">):</span>
        <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">comb</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>  <span class="c1"># r x r</span>
        <span class="k">if</span> <span class="n">det_int</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Solve (M^T) y = 1</span>
        <span class="c1"># We&#39;ll do Gaussian elimination with Fractions</span>
        <span class="n">MT</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
        <span class="c1"># Solve linear system</span>
        <span class="c1"># Convert to augmented matrix</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="c1"># Partial pivot</span>
            <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">MT</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">MT</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">MT</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">MT</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">pivv</span> <span class="o">=</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># Normalize row i to make pivot 1 for numerical stability (not required)</span>
            <span class="c1"># Eliminate other rows</span>
            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">u</span> <span class="o">!=</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">MT</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">MT</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
                        <span class="n">MT</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">b</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">MT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Back substitution to get y: since reduced to diagonal but not necessarily 1 on diag</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">-=</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># Check feasibility: for all j, dot(y, col_j) &lt;= 1</span>
        <span class="n">feas</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">feas</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">feas</span><span class="p">:</span>
            <span class="n">Y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="c1"># Add uniform feasible y = (1/w_max) * 1</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">w_max</span><span class="p">)</span>
    <span class="n">y_unif</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">alpha</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
    <span class="n">Y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_unif</span><span class="p">)</span>
    <span class="c1"># Deduplicate</span>
    <span class="n">Yuniq</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">Y</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">num</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">num</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">Yuniq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Yuniq</span>


<span class="k">def</span><span class="w"> </span><span class="nf">dual_lower_bound</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">rvec</span><span class="p">):</span>
    <span class="c1"># rvec: list of ints</span>
    <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">Y</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rvec</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">yi</span> <span class="o">*</span> <span class="n">rvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># ceil</span>
        <span class="c1"># Compute ceil of fraction</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">numerator</span>
        <span class="n">den</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">denominator</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">num</span> <span class="o">+</span> <span class="n">den</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">den</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">greedy_upper</span><span class="p">(</span><span class="n">Ar</span><span class="p">,</span> <span class="n">rvec</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">rvec</span><span class="p">[:]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cost</span>
        <span class="c1"># choose column maximizing coverage dot with r</span>
        <span class="n">bestj</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">bestdot</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">bestw</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">dot</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">w</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">w</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">dot</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">dot</span> <span class="o">&gt;</span> <span class="n">bestdot</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dot</span> <span class="o">==</span> <span class="n">bestdot</span> <span class="ow">and</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="n">bestw</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">dot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">bestdot</span> <span class="o">=</span> <span class="n">dot</span>
                    <span class="n">bestw</span> <span class="o">=</span> <span class="n">w</span>
                    <span class="n">bestj</span> <span class="o">=</span> <span class="n">j</span>
        <span class="k">if</span> <span class="n">bestj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># cannot reduce further</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="c1"># v is limited by min r[i] over covered rows</span>
        <span class="n">v</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bestj</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># shouldn&#39;t happen due to bestdot&gt;0</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">cost</span> <span class="o">+=</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bestj</span><span class="p">]:</span>
                <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">v</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine_part2</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Remove columns with no coverage</span>
    <span class="n">Acols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">A</span><span class="p">))</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">keep_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Acols</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">col</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keep_cols</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">Acols</span><span class="p">):</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">keep_cols</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c1"># Quick infeasibility check: any row with zero coverage but t_i &gt; 0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="c1"># Row basis reduction</span>
    <span class="n">basis_idxs</span> <span class="o">=</span> <span class="n">row_basis_indices</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">Ar</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">basis_idxs</span><span class="p">]</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">basis_idxs</span><span class="p">]</span>
    <span class="n">rdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rdim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Dual vertices for lower bound</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">solve_dual_vertices</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="n">w_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="c1"># A* like Branch and Bound over variables</span>
    <span class="c1"># Precompute order of columns initial: by weight descending</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="n">order</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">weights</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="o">-</span><span class="n">j</span><span class="p">))</span>

    <span class="c1"># Map from remaining mask and residual to best known cost to finish (memo)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>

    <span class="c1"># The recursion will branch on columns in &#39;order&#39; sequence</span>

    <span class="c1"># Greedy initial upper bound</span>
    <span class="n">UB</span> <span class="o">=</span> <span class="n">greedy_upper</span><span class="p">(</span><span class="n">Ar</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">UB</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
        <span class="c1"># Fallback trivial UB sum(t)</span>
        <span class="n">UB</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>

    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rtuple</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">UB</span>
        <span class="n">rvec</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rtuple</span><span class="p">)</span>
        <span class="c1"># If all zeros, done</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rvec</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># Lower bound</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">dual_lower_bound</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">rvec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lb</span> <span class="o">&gt;=</span> <span class="n">UB</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="c1"># Occasionally update UB using greedy</span>
        <span class="n">gu</span> <span class="o">=</span> <span class="n">greedy_upper</span><span class="p">(</span><span class="n">Ar</span><span class="p">,</span> <span class="n">rvec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">gu</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">gu</span> <span class="o">&lt;</span> <span class="n">UB</span><span class="p">:</span>
            <span class="n">UB</span> <span class="o">=</span> <span class="n">gu</span>
        <span class="k">if</span> <span class="n">pos</span> <span class="o">==</span> <span class="n">k</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span> <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">rvec</span><span class="p">)</span> <span class="k">else</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="c1"># If column doesn&#39;t touch any positive residual rows, skip</span>
        <span class="n">touch</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">minv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">rvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">touch</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">minv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">rvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minv</span><span class="p">:</span>
                    <span class="n">minv</span> <span class="o">=</span> <span class="n">rvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">touch</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dfs</span><span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">rtuple</span><span class="p">)</span>
        <span class="n">best_here</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="c1"># Try values. Iterate from high to low for weight&gt;=2, else exact value equals residual for that single row</span>
        <span class="n">max_v</span> <span class="o">=</span> <span class="n">minv</span> <span class="k">if</span> <span class="n">minv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="c1"># Candidate values: 0..max_v; We&#39;ll try descending to find good UB fast</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_v</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sub</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">rtuple</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sub</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">cand</span> <span class="o">=</span> <span class="n">sub</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Apply v</span>
                <span class="n">rnew</span> <span class="o">=</span> <span class="n">rvec</span><span class="p">[:]</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]:</span>
                        <span class="n">rnew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">v</span>
                        <span class="k">if</span> <span class="n">rnew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">sub</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="n">pos</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rnew</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">sub</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">cand</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">sub</span>
            <span class="k">if</span> <span class="n">cand</span> <span class="o">&lt;</span> <span class="n">best_here</span><span class="p">:</span>
                <span class="n">best_here</span> <span class="o">=</span> <span class="n">cand</span>
                <span class="k">if</span> <span class="n">cand</span> <span class="o">&lt;</span> <span class="n">UB</span><span class="p">:</span>
                    <span class="n">UB</span> <span class="o">=</span> <span class="n">cand</span>
            <span class="c1"># Bound: if v*1 (each press cost 1) already exceeds current best, break; but since descending v, smaller v could be better</span>
        <span class="k">return</span> <span class="n">best_here</span>

    <span class="n">ans</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tr</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ans</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_all_part2</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">jolts</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">solve_machine_part2</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">total</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">solve_all_part2</span><span class="p">(</span><span class="n">lines</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solver_p2_idapy"> solver_p2_ida.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T16:02:04.363035</li>
<li><strong>Duration</strong>: 1.31s</li>
<li><strong>Exit Code</strong>: 1</li>
<li><strong>Error</strong>: Non-zero exit code</li>
</ul>
<h3 id="stderr_1">Stderr</h3>
<div class="highlight"><pre><span></span><code>Traceback (most recent call last):
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_ida.py&quot;, line 441, in &lt;module&gt;
    solve_all(lines)
    ~~~~~~~~~^^^^^^^
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_ida.py&quot;, line 433, in solve_all
    ans = solve_machine_ida(jolts, buttons)
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_ida.py&quot;, line 413, in solve_machine_ida
    res = dfs(target[:], 0, bound)
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_ida.py&quot;, line 403, in dfs
    res = dfs(r, g+v, bound)
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_ida.py&quot;, line 403, in dfs
    res = dfs(r, g+v, bound)
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_ida.py&quot;, line 391, in dfs
    res = dfs(r, g, bound)
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_ida.py&quot;, line 391, in dfs
    res = dfs(r, g, bound)
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_ida.py&quot;, line 391, in dfs
    res = dfs(r, g, bound)
  [Previous line repeated 9989 more times]
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_ida.py&quot;, line 341, in dfs
    f = g + h(r)
            ~^^^
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_ida.py&quot;, line 281, in h
    lb3 = dual_lower_bound(Y, r)
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_ida.py&quot;, line 185, in dual_lower_bound
    num = yi.numerator * ri
          ^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
</code></pre></div>
<h3 id="code_7">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>
<span class="n">sys</span><span class="o">.</span><span class="n">setrecursionlimit</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">jolts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">m2</span><span class="p">:</span>
        <span class="n">jtxt</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jtxt</span><span class="p">:</span>
            <span class="n">jolts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jtxt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">jolts</span>


<span class="k">def</span><span class="w"> </span><span class="nf">row_basis_indices</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Gaussian elimination over rationals, track original row indices</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Fraction</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
    <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">order</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">order</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">order</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="c1"># eliminate other rows</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">idxs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_dual_vertices</span><span class="p">(</span><span class="n">Ar</span><span class="p">):</span>
    <span class="c1"># Enumerate a subset of extreme points of dual polytope: y&gt;=0, A^T y &lt;= 1</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">r</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[()]</span>
    <span class="c1"># Compute max column weight</span>
    <span class="n">w_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">if</span> <span class="n">k</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Enumerate combinations of r linearly independent columns</span>
    <span class="c1"># Precompute columns as rows for use in forming M</span>
    <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">r</span><span class="p">):</span>
        <span class="c1"># Build square matrix of size r: rows are r rows, cols are r selected columns</span>
        <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">comb</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
        <span class="c1"># Compute determinant using Bareiss to check invertibility</span>
        <span class="n">det</span> <span class="o">=</span> <span class="n">bareiss_det</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">det</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Solve (M^T) y = 1 using exact fractions</span>
        <span class="c1"># Build MT and RHS</span>
        <span class="n">MT</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
        <span class="c1"># Gaussian elimination to solve MT y = b</span>
        <span class="c1"># Forward elimination</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">MT</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">MT</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">MT</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">MT</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">pivv</span> <span class="o">=</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">u</span> <span class="o">!=</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">MT</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">MT</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
                        <span class="n">MT</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">b</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">MT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="n">r</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">-=</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># y must satisfy A^T y &lt;= 1 and y&gt;=0</span>
        <span class="n">feas</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">feas</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">feas</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">feas</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">feas</span><span class="p">:</span>
            <span class="n">Y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="c1"># Always include uniform y = 1/w_max</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">w_max</span><span class="p">)</span>
    <span class="n">y_unif</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">alpha</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
    <span class="n">Y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_unif</span><span class="p">)</span>
    <span class="c1"># Deduplicate</span>
    <span class="n">uniq</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">Y</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">uniq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">uniq</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bareiss_det</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">M</span><span class="p">]</span>
    <span class="n">det_sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">det_sign</span> <span class="o">=</span> <span class="o">-</span><span class="n">det_sign</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">pivv</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">//</span> <span class="n">prev</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">pivv</span>
    <span class="k">return</span> <span class="n">det_sign</span> <span class="o">*</span> <span class="n">A</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">dual_lower_bound</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">rvec</span><span class="p">):</span>
    <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">Y</span><span class="p">:</span>
        <span class="n">s_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s_den</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">rvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ri</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># add yi * ri to s</span>
            <span class="c1"># yi is Fraction</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">yi</span><span class="o">.</span><span class="n">numerator</span> <span class="o">*</span> <span class="n">ri</span>
            <span class="n">den</span> <span class="o">=</span> <span class="n">yi</span><span class="o">.</span><span class="n">denominator</span>
            <span class="c1"># s = s_num/s_den + num/den</span>
            <span class="n">s_num</span> <span class="o">=</span> <span class="n">s_num</span><span class="o">*</span><span class="n">den</span> <span class="o">+</span> <span class="n">num</span><span class="o">*</span><span class="n">s_den</span>
            <span class="n">s_den</span> <span class="o">=</span> <span class="n">s_den</span> <span class="o">*</span> <span class="n">den</span>
            <span class="c1"># reduce? not necessary</span>
        <span class="c1"># ceil(s_num / s_den)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_num</span> <span class="o">+</span> <span class="n">s_den</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">s_den</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">greedy_upper</span><span class="p">(</span><span class="n">Ar</span><span class="p">,</span> <span class="n">rvec</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">rvec</span><span class="p">[:]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cost</span>
        <span class="n">bestj</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">bestcov</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">bestmin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">minv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cov</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">minv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minv</span><span class="p">:</span>
                        <span class="n">minv</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cov</span> <span class="o">&gt;</span> <span class="n">bestcov</span> <span class="ow">and</span> <span class="n">minv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">minv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bestcov</span> <span class="o">=</span> <span class="n">cov</span>
                <span class="n">bestj</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">bestmin</span> <span class="o">=</span> <span class="n">minv</span>
        <span class="k">if</span> <span class="n">bestj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">bestmin</span>
        <span class="n">cost</span> <span class="o">+=</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bestj</span><span class="p">]:</span>
                <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">v</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine_ida</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Remove useless columns (zero coverage)</span>
    <span class="n">k0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">keep_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keep_cols</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">k0</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">keep_cols</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c1"># Quick infeasibility</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="c1"># Row basis reduction</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">row_basis_indices</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">Ar</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">basis</span><span class="p">]</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">basis</span><span class="p">]</span>
    <span class="n">rdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rdim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Precompute per column lists and weights</span>
    <span class="n">col_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span> <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span>
        <span class="n">col_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">))</span>
    <span class="n">w_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="k">if</span> <span class="n">weights</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="c1"># Precompute rows_covered_by</span>
    <span class="n">rows_covered_by</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">col_rows</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
            <span class="n">rows_covered_by</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="c1"># Dual Ys</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">solve_dual_vertices</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="c1"># Heuristic initial UB</span>
    <span class="n">UB</span> <span class="o">=</span> <span class="n">greedy_upper</span><span class="p">(</span><span class="n">Ar</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">UB</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
        <span class="n">UB</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="c1"># Heuristic lower bound function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">h</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="c1"># r is list of len rdim</span>
        <span class="n">ssum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ssum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="n">lb1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ssum</span> <span class="o">+</span> <span class="n">w_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">w_max</span>
        <span class="n">lb2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">lb3</span> <span class="o">=</span> <span class="n">dual_lower_bound</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">lb1</span><span class="p">,</span> <span class="n">lb2</span><span class="p">,</span> <span class="n">lb3</span><span class="p">)</span>
    <span class="c1"># Forced assignments</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_forced</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">remaining</span><span class="p">):</span>
        <span class="c1"># remaining is ignored since we use all columns</span>
        <span class="c1"># Returns (r, added_cost) or (None, None) if infeasible</span>
        <span class="n">added</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="n">changed</span><span class="p">:</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># For any row with r[i]&gt;0:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                <span class="n">ri</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ri</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># columns that touch i</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">rows_covered_by</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="kc">True</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                <span class="c1"># Filter cols that touch at least one positive row</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cols</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">col_rows</span><span class="p">[</span><span class="n">j</span><span class="p">])]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># assign v = r[i] limited by min residual on all rows covered by j</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">ri</span>
                    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">col_rows</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">:</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># column cannot help now; but since it was unique, infeasible</span>
                        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                    <span class="c1"># apply</span>
                    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">col_rows</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                        <span class="n">r</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-=</span> <span class="n">v</span>
                        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
                    <span class="n">added</span> <span class="o">+=</span> <span class="n">v</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># restart scanning rows since r changed</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="n">added</span>

    <span class="c1"># IDA*</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[:]</span>
    <span class="n">start_h</span> <span class="o">=</span> <span class="n">h</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="n">bound</span> <span class="o">=</span> <span class="n">start_h</span>
    <span class="n">best_answer</span> <span class="o">=</span> <span class="n">UB</span>
    <span class="c1"># If h already equals UB, we can return UB</span>
    <span class="k">if</span> <span class="n">start_h</span> <span class="o">&gt;=</span> <span class="n">UB</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">UB</span>

    <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">bound</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">best_answer</span>
        <span class="c1"># r is list</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="n">h</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">bound</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
            <span class="n">best_answer</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">best_answer</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;FOUND&#39;</span>
        <span class="c1"># forced</span>
        <span class="n">r_copy</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:]</span>
        <span class="n">forced_res</span> <span class="o">=</span> <span class="n">apply_forced</span><span class="p">(</span><span class="n">r_copy</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">forced_res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">r_forced</span><span class="p">,</span> <span class="n">add_cost</span> <span class="o">=</span> <span class="n">forced_res</span>
        <span class="k">if</span> <span class="n">add_cost</span><span class="p">:</span>
            <span class="n">g2</span> <span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="n">add_cost</span>
            <span class="n">f2</span> <span class="o">=</span> <span class="n">g2</span> <span class="o">+</span> <span class="n">h</span><span class="p">(</span><span class="n">r_forced</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f2</span> <span class="o">&gt;</span> <span class="n">bound</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f2</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r_forced</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">g2</span>
        <span class="c1"># Choose column to branch</span>
        <span class="c1"># pick column with max coverage among positive rows, tie-break by weight</span>
        <span class="n">bestj</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">bestscore</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">max_v</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># compute positive rows set</span>
        <span class="n">pos_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pos_rows</span><span class="p">:</span>
            <span class="n">best_answer</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">best_answer</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;FOUND&#39;</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">minv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pos_rows</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">cov</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">minv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minv</span><span class="p">:</span>
                        <span class="n">minv</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cov</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">cov</span> <span class="o">&gt;</span> <span class="n">bestscore</span><span class="p">:</span>
                <span class="n">bestscore</span> <span class="o">=</span> <span class="n">cov</span>
                <span class="n">bestj</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">max_v</span> <span class="o">=</span> <span class="n">minv</span> <span class="k">if</span> <span class="n">minv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">bestj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="c1"># Try values from max_v down to 0</span>
        <span class="n">next_bound</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">rowsj</span> <span class="o">=</span> <span class="n">col_rows</span><span class="p">[</span><span class="n">bestj</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_v</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">bound</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># apply v</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">rowsj</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">rowsj</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-=</span> <span class="n">v</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="o">+</span><span class="n">v</span><span class="p">,</span> <span class="n">bound</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">rowsj</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">+=</span> <span class="n">v</span>
            <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="s1">&#39;FOUND&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;FOUND&#39;</span>
            <span class="k">if</span> <span class="n">res</span> <span class="o">&lt;</span> <span class="n">next_bound</span><span class="p">:</span>
                <span class="n">next_bound</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="n">next_bound</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="n">target</span><span class="p">[:],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bound</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="s1">&#39;FOUND&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">best_answer</span>
        <span class="k">if</span> <span class="n">res</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
            <span class="c1"># increase by 1</span>
            <span class="n">bound</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bound</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">if</span> <span class="n">bound</span> <span class="o">&gt;</span> <span class="n">UB</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">UB</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_all</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">jolts</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">solve_machine_ida</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ans</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">ans</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">solve_all</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div>
<h2 id="solver_p2_dfspy"> solver_p2_dfs.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T16:03:48.306859</li>
<li><strong>Duration</strong>: 0.70s</li>
<li><strong>Exit Code</strong>: 1</li>
<li><strong>Error</strong>: Non-zero exit code</li>
</ul>
<h3 id="stderr_2">Stderr</h3>
<div class="highlight"><pre><span></span><code>Traceback (most recent call last):
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_dfs.py&quot;, line 390, in &lt;module&gt;
    solve_all(lines)
    ~~~~~~~~~^^^^^^^
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_dfs.py&quot;, line 382, in solve_all
    v = solve_machine(jolts, buttons)
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_dfs.py&quot;, line 370, in solve_machine
    ans = solve_state(tuple(tr))
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_dfs.py&quot;, line 355, in solve_state
    sub = solve_state(tuple(r2))
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_dfs.py&quot;, line 355, in solve_state
    sub = solve_state(tuple(r2))
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_dfs.py&quot;, line 355, in solve_state
    sub = solve_state(tuple(r2))
  [Previous line repeated 992 more times]
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_dfs.py&quot;, line 318, in solve_state
    lb = dual_lb(Y, r)
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_dfs.py&quot;, line 189, in dual_lb
    num = yi.numerator * ri
          ^^^^^^^^^^^^
RecursionError: maximum recursion depth exceeded
</code></pre></div>
<h3 id="code_8">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">jolts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">m2</span><span class="p">:</span>
        <span class="n">jtxt</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jtxt</span><span class="p">:</span>
            <span class="n">jolts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jtxt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">jolts</span>


<span class="k">def</span><span class="w"> </span><span class="nf">row_basis_indices</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Fraction</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
    <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">order</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">order</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">order</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bareiss_det</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">M</span><span class="p">]</span>
    <span class="n">det_sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">det_sign</span> <span class="o">=</span> <span class="o">-</span><span class="n">det_sign</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">pivv</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">//</span> <span class="n">prev</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">pivv</span>
    <span class="k">return</span> <span class="n">det_sign</span> <span class="o">*</span> <span class="n">A</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">enumerate_dual_vertices</span><span class="p">(</span><span class="n">Ar</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">r</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[()]</span>
    <span class="c1"># Precompute for speed</span>
    <span class="n">Ar_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">Ar</span><span class="p">))</span>  <span class="c1"># k x r</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">rows_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">zmask</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">r</span><span class="p">):</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rows_idx</span> <span class="k">if</span> <span class="p">(</span><span class="n">zmask</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rows_idx</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">zmask</span><span class="o">&gt;&gt;</span><span class="n">i</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">rz</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># y all zeros is a vertex; check feasibility trivial</span>
            <span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span>
            <span class="k">continue</span>
        <span class="c1"># Build Ar_R (rz x k)</span>
        <span class="c1"># We&#39;ll pick comb of columns of size rz</span>
        <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">rz</span><span class="p">):</span>
            <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">comb</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bareiss_det</span><span class="p">(</span><span class="n">M</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># Solve (M^T) y_R = 1</span>
            <span class="c1"># MT is rz x rz</span>
            <span class="n">MT</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rz</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rz</span><span class="p">)]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rz</span><span class="p">)]</span>
            <span class="c1"># Gauss</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rz</span><span class="p">):</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">rz</span> <span class="ow">and</span> <span class="n">MT</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">rz</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                    <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">MT</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">MT</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pivv</span> <span class="o">=</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rz</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">u</span> <span class="o">!=</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">MT</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">f</span> <span class="o">=</span> <span class="n">MT</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rz</span><span class="p">):</span>
                            <span class="n">MT</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">b</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">yR</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="n">rz</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">rz</span><span class="p">)):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">rz</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">-=</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">yR</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">yR</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># Build full y</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="n">r</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">irow</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">R</span><span class="p">):</span>
                <span class="n">y</span><span class="p">[</span><span class="n">irow</span><span class="p">]</span> <span class="o">=</span> <span class="n">yR</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="c1"># Check y&gt;=0 and A^T y &lt;= 1</span>
            <span class="n">feasible</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">yi</span> <span class="ow">in</span> <span class="n">y</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">yi</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">feasible</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">Ar_cols</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">s</span> <span class="o">+=</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">feasible</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">feasible</span><span class="p">:</span>
                <span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="c1"># Deduplicate</span>
    <span class="n">uniq</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">vertices</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">a</span><span class="o">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">y</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">uniq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">uniq</span>


<span class="k">def</span><span class="w"> </span><span class="nf">dual_lb</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">rvec</span><span class="p">):</span>
    <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">Y</span><span class="p">:</span>
        <span class="c1"># y dot rvec</span>
        <span class="n">s_num</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">s_den</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">yi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
            <span class="n">ri</span> <span class="o">=</span> <span class="n">rvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ri</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">yi</span><span class="o">.</span><span class="n">numerator</span> <span class="o">*</span> <span class="n">ri</span>
            <span class="n">den</span> <span class="o">=</span> <span class="n">yi</span><span class="o">.</span><span class="n">denominator</span>
            <span class="n">s_num</span> <span class="o">=</span> <span class="n">s_num</span><span class="o">*</span><span class="n">den</span> <span class="o">+</span> <span class="n">num</span><span class="o">*</span><span class="n">s_den</span>
            <span class="n">s_den</span> <span class="o">*=</span> <span class="n">den</span>
        <span class="c1"># ceil</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">s_num</span> <span class="o">+</span> <span class="n">s_den</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">s_den</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">greedy_upper</span><span class="p">(</span><span class="n">Ar</span><span class="p">,</span> <span class="n">rvec</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">rvec</span><span class="p">[:]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cost</span>
        <span class="n">bestj</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">bestcov</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">bestmin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">minv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cov</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">minv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minv</span><span class="p">:</span>
                        <span class="n">minv</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cov</span> <span class="o">&gt;</span> <span class="n">bestcov</span> <span class="ow">and</span> <span class="n">minv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">minv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bestcov</span> <span class="o">=</span> <span class="n">cov</span>
                <span class="n">bestj</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">bestmin</span> <span class="o">=</span> <span class="n">minv</span>
        <span class="k">if</span> <span class="n">bestj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">bestmin</span>
        <span class="n">cost</span> <span class="o">+=</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bestj</span><span class="p">]:</span>
                <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">v</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Remove zero columns</span>
    <span class="n">k0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">k0</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c1"># infeasible quick</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="c1"># Row basis</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">row_basis_indices</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">Ar</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">basis</span><span class="p">]</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">basis</span><span class="p">]</span>
    <span class="n">rdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rdim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Precompute columns rows list</span>
    <span class="n">col_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span> <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span>
        <span class="n">col_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="c1"># Precompute rows columns list</span>
    <span class="n">row_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span>
        <span class="n">row_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
    <span class="c1"># Heuristic UB</span>
    <span class="n">UB</span> <span class="o">=</span> <span class="n">greedy_upper</span><span class="p">(</span><span class="n">Ar</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">UB</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
        <span class="n">UB</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="c1"># Dual vertices for LB</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">enumerate_dual_vertices</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="c1"># DFS with memo</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">UB</span>

    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">solve_state</span><span class="p">(</span><span class="n">rtuple</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">best</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rtuple</span><span class="p">)</span>
        <span class="c1"># forced assignments</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">g_forced</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">changed</span><span class="p">:</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># For each row with r&gt;0, collect columns that hit any positive row</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">row_cols</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="c1"># If this column can reduce something (hits any row with r&gt;0)</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">col_rows</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                        <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">cols</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="c1"># must use column j total &gt;= r[i]; we can apply min over rows covered</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="c1"># bounded by min residual among covered rows</span>
                    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">col_rows</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">v</span><span class="p">:</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">u</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                    <span class="c1"># apply v</span>
                    <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">col_rows</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                        <span class="n">r</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-=</span> <span class="n">v</span>
                        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
                    <span class="n">g_forced</span> <span class="o">+=</span> <span class="n">v</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># restart scanning rows since r changed</span>
                    <span class="k">break</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g_forced</span>
        <span class="c1"># Lower bound</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">dual_lb</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g_forced</span> <span class="o">+</span> <span class="n">lb</span> <span class="o">&gt;=</span> <span class="n">best</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="c1"># Choose branching column: max coverage of positive rows</span>
        <span class="n">pos_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">bestj</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">bestcov</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">minv</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mm</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">rowsj</span> <span class="o">=</span> <span class="n">col_rows</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pos_rows</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">cov</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">mm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mm</span><span class="p">:</span>
                        <span class="n">mm</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cov</span> <span class="o">&gt;</span> <span class="n">bestcov</span> <span class="ow">and</span> <span class="n">mm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bestcov</span> <span class="o">=</span> <span class="n">cov</span>
                <span class="n">bestj</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">minv</span> <span class="o">=</span> <span class="n">mm</span>
        <span class="k">if</span> <span class="n">bestj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="c1"># Try values descending to find better UB early</span>
        <span class="n">res_best</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">rowsj</span> <span class="o">=</span> <span class="n">col_rows</span><span class="p">[</span><span class="n">bestj</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">minv</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:]</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">rowsj</span><span class="p">:</span>
                    <span class="n">r2</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-=</span> <span class="n">v</span>
                    <span class="k">if</span> <span class="n">r2</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="n">solve_state</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">r2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">sub</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
                <span class="n">cand</span> <span class="o">=</span> <span class="n">g_forced</span> <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">sub</span>
                <span class="k">if</span> <span class="n">cand</span> <span class="o">&lt;</span> <span class="n">res_best</span><span class="p">:</span>
                    <span class="n">res_best</span> <span class="o">=</span> <span class="n">cand</span>
                    <span class="k">if</span> <span class="n">cand</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                        <span class="n">best</span> <span class="o">=</span> <span class="n">cand</span>
                <span class="c1"># If v is 0 and we found finite, further v smaller not possible; but v is decreasing, next is smaller, so might be worse or better? Unknown. Keep exploring to tighten memo.</span>
            <span class="c1"># Optional prune by current best</span>
            <span class="c1"># Compute quick optimistic bound for this branch: g_forced + v + dual_lb(r2)</span>
            <span class="k">if</span> <span class="n">g_forced</span> <span class="o">+</span> <span class="n">v</span> <span class="o">+</span> <span class="n">dual_lb</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">best</span><span class="p">:</span>
                <span class="c1"># further smaller v may or may not improve; but since we go down v, cannot claim monotonic; keep loop</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">res_best</span>

    <span class="n">ans</span> <span class="o">=</span> <span class="n">solve_state</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">tr</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ans</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_all</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">jolts</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">v</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">solve_all</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div>
<h2 id="solve_p2_lppy"> solve_p2_lp.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T16:05:57.038381</li>
<li><strong>Duration</strong>: 1.29s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout_3">Stdout</h3>
<div class="highlight"><pre><span></span><code>15599
all_int False
</code></pre></div>
<h3 id="code_9">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">jolts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">m2</span><span class="p">:</span>
        <span class="n">jtxt</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jtxt</span><span class="p">:</span>
            <span class="n">jolts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jtxt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">jolts</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rank_frac</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Fraction</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">r</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bareiss_det</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">M</span><span class="p">]</span>
    <span class="n">det_sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">det_sign</span> <span class="o">=</span> <span class="o">-</span><span class="n">det_sign</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">pivv</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">//</span> <span class="n">prev</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">pivv</span>
    <span class="k">return</span> <span class="n">det_sign</span> <span class="o">*</span> <span class="n">A</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_lp</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="c1"># Reduce rows to independent ones</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c1"># Find independent rows indices</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Fraction</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">indep</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">indep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">Ar</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indep</span><span class="p">]</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indep</span><span class="p">]</span>
    <span class="n">rdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rdim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">best_val</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_x</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Enumerate all bases C of size rdim</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>
    <span class="k">for</span> <span class="n">cols</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">rdim</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">bareiss_det</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Solve B x_B = tr</span>
        <span class="c1"># Use fractions gaussian elimination on square</span>
        <span class="n">rdim2</span> <span class="o">=</span> <span class="n">rdim</span>
        <span class="n">MT</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim2</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim2</span><span class="p">)]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">tr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim2</span><span class="p">)]</span>
        <span class="c1"># Solve</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim2</span><span class="p">):</span>
            <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">rdim2</span> <span class="ow">and</span> <span class="n">MT</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">rdim2</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">MT</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">MT</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">pivv</span> <span class="o">=</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim2</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">u</span> <span class="o">!=</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">MT</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">MT</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rdim2</span><span class="p">):</span>
                        <span class="n">MT</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">b</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">xB</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="n">rdim2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">rdim2</span><span class="p">)):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">rdim2</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">-=</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">xB</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">xB</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># If any xB &lt; 0, infeasible</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xB</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="c1"># Build full x with other vars zero</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="n">n</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
            <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">xB</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">best_val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">best_val</span><span class="p">:</span>
            <span class="n">best_val</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">best_x</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">best_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># fallback huge</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">best_val</span><span class="p">,</span> <span class="n">best_x</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">all_int</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">jolts</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">A</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="n">val</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">solve_lp</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;fail&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="c1"># check integrality</span>
        <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">xi</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xi</span><span class="p">):</span>
                <span class="n">all_int</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;all_int&#39;</span><span class="p">,</span> <span class="n">all_int</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solver_p2_bblppy"> solver_p2_bblp.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T16:08:19.490335</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_10">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">jolts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">m2</span><span class="p">:</span>
        <span class="n">jtxt</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jtxt</span><span class="p">:</span>
            <span class="n">jolts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jtxt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">jolts</span>


<span class="k">def</span><span class="w"> </span><span class="nf">independent_rows</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="c1"># Return list of indices of linearly independent rows over rationals</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Fraction</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
    <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">order</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">order</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">order</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">order</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bareiss_det</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">M</span><span class="p">]</span>
    <span class="n">det_sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">det_sign</span> <span class="o">=</span> <span class="o">-</span><span class="n">det_sign</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">pivv</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">//</span> <span class="n">prev</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">pivv</span>
    <span class="k">return</span> <span class="n">det_sign</span> <span class="o">*</span> <span class="n">A</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_lp_relax</span><span class="p">(</span><span class="n">Ar</span><span class="p">,</span> <span class="n">rvec</span><span class="p">):</span>
    <span class="c1"># Min sum x s.t. Ar x &gt;= rvec, x&gt;=0; return (val, x vector Fractions)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="n">n</span>
    <span class="c1"># Enumerate all bases of size m with invertible matrix</span>
    <span class="n">best_val</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_x</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Quick column filter: remove zero columns (but keep alignment by using zeros)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">comb</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">bareiss_det</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Solve B y = rvec</span>
        <span class="n">rdim</span> <span class="o">=</span> <span class="n">m</span>
        <span class="n">MT</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">rvec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">rdim</span> <span class="ow">and</span> <span class="n">MT</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">rdim</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">MT</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">MT</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">pivv</span> <span class="o">=</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">u</span> <span class="o">!=</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">MT</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">MT</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rdim</span><span class="p">):</span>
                        <span class="n">MT</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">b</span><span class="p">[</span><span class="n">u</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="n">rdim</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">rdim</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">-=</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">MT</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># Check y &gt;= 0 and nonbasic feasibility (Ar x &gt;= r means choosing x with these y on comb and 0 elsewhere is feasible)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">y</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="n">n</span>
        <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comb</span><span class="p">):</span>
            <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">best_val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">best_val</span><span class="p">:</span>
            <span class="n">best_val</span> <span class="o">=</span> <span class="n">val</span>
            <span class="n">best_x</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">best_x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># fallback infeasible (shouldn&#39;t happen)</span>
        <span class="k">return</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">18</span><span class="p">),</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="n">n</span>
    <span class="k">return</span> <span class="n">best_val</span><span class="p">,</span> <span class="n">best_x</span>


<span class="k">def</span><span class="w"> </span><span class="nf">greedy_upper</span><span class="p">(</span><span class="n">Ar</span><span class="p">,</span> <span class="n">rvec</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">rvec</span><span class="p">[:]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cost</span>
        <span class="n">bestj</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">bestcov</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">bestmin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">minv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cov</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">minv</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minv</span><span class="p">:</span>
                        <span class="n">minv</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cov</span> <span class="o">&gt;</span> <span class="n">bestcov</span> <span class="ow">and</span> <span class="n">minv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">minv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bestcov</span> <span class="o">=</span> <span class="n">cov</span>
                <span class="n">bestj</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">bestmin</span> <span class="o">=</span> <span class="n">minv</span>
        <span class="k">if</span> <span class="n">bestj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>  <span class="c1"># fallback bound by using singletons if exist</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">bestmin</span>
        <span class="n">cost</span> <span class="o">+=</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bestj</span><span class="p">]:</span>
                <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">v</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Remove zero columns</span>
    <span class="n">n0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n0</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c1"># Quick infeasible: any row with zero coverage and t&gt;0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="c1"># Reduce rows to independent</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="n">independent_rows</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">Ar</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">basis</span><span class="p">]</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">basis</span><span class="p">]</span>
    <span class="n">rdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rdim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Precompute column coverage lists</span>
    <span class="n">col_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span> <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span>
        <span class="n">col_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="c1"># Global UB via greedy</span>
    <span class="n">UB</span> <span class="o">=</span> <span class="n">greedy_upper</span><span class="p">(</span><span class="n">Ar</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">UB</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span>

    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">rtuple</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">best</span>
        <span class="n">r</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rtuple</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="c1"># LP lower bound</span>
        <span class="n">lb_val</span><span class="p">,</span> <span class="n">x_lp</span> <span class="o">=</span> <span class="n">solve_lp_relax</span><span class="p">(</span><span class="n">Ar</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="n">lb_int</span> <span class="o">=</span> <span class="p">(</span><span class="n">lb_val</span><span class="o">.</span><span class="n">numerator</span> <span class="o">+</span> <span class="n">lb_val</span><span class="o">.</span><span class="n">denominator</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">lb_val</span><span class="o">.</span><span class="n">denominator</span>
        <span class="k">if</span> <span class="n">lb_int</span> <span class="o">&gt;=</span> <span class="n">best</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="c1"># If LP solution integral, it&#39;s optimal for this residual</span>
        <span class="n">is_int</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">xi</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x_lp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_int</span><span class="p">:</span>
            <span class="n">cand</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x_lp</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cand</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">cand</span>
            <span class="k">return</span> <span class="n">cand</span>
        <span class="c1"># Choose fractional variable to branch: pick j with largest fractional part and positive</span>
        <span class="n">frac_vars</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">xi</span><span class="p">))),</span> <span class="n">j</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">xi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_lp</span><span class="p">)</span> <span class="k">if</span> <span class="n">xi</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">xi</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xi</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">frac_vars</span><span class="p">:</span>
            <span class="c1"># Degenerate: though not all ints, numerically tiny fractions -&gt; round</span>
            <span class="n">cand</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">xi</span> <span class="o">+</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000000</span><span class="p">))</span> <span class="k">for</span> <span class="n">xi</span> <span class="ow">in</span> <span class="n">x_lp</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cand</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">cand</span>
            <span class="k">return</span> <span class="n">cand</span>
        <span class="n">frac_vars</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">frac_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">xj</span> <span class="o">=</span> <span class="n">x_lp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">v_floor</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xj</span><span class="p">)</span>
        <span class="n">v_ceil</span> <span class="o">=</span> <span class="n">v_floor</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># limit by residual min</span>
        <span class="n">max_v</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">col_rows</span><span class="p">[</span><span class="n">j</span><span class="p">]),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v_ceil</span> <span class="o">&gt;</span> <span class="n">max_v</span><span class="p">:</span>
            <span class="n">v_ceil</span> <span class="o">=</span> <span class="n">max_v</span>
        <span class="k">if</span> <span class="n">v_floor</span> <span class="o">&gt;</span> <span class="n">max_v</span><span class="p">:</span>
            <span class="n">v_floor</span> <span class="o">=</span> <span class="n">max_v</span>
        <span class="c1"># Explore ceil first to reduce residual</span>
        <span class="n">best_here</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="n">v_ceil</span><span class="p">,</span> <span class="n">v_floor</span><span class="p">):</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:]</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">col_rows</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">r2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">v</span>
                    <span class="k">if</span> <span class="n">r2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">r2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">sub</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">r2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">sub</span> <span class="o">!=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
                <span class="n">cand</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">sub</span>
                <span class="k">if</span> <span class="n">cand</span> <span class="o">&lt;</span> <span class="n">best_here</span><span class="p">:</span>
                    <span class="n">best_here</span> <span class="o">=</span> <span class="n">cand</span>
                    <span class="k">if</span> <span class="n">cand</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                        <span class="n">best</span> <span class="o">=</span> <span class="n">cand</span>
        <span class="k">return</span> <span class="n">best_here</span>

    <span class="n">ans</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">tr</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ans</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">jolts</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">v</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="-c_2"> -c</h2>
<p>import re
from fractions import Fraction
from itertools import combinations</p>
<p>lines=open('input.txt','r',encoding='utf-8').read().splitlines()</p>
<p>def parse_line(line):
    m2 = re.search(r"{([^}]*)}", line)
    jolts = [int(x) for x in m2.group(1).split(',')]
    buttons = []
    for grp in re.finditer(r"<span class="arithmatex">\(([^)]*)\)</span>", line):
        content = grp.group(1).strip()
        if content:
            buttons.append([int(x) for x in content.split(',')])
        else:
            buttons.append([])
    return jolts, buttons</p>
<p>def build_A(t, buttons):
    m=len(t); k=len(buttons)
    A=[[0]*k for _ in range(m)]
    for j,idxs in enumerate(buttons):
        for i in idxs:
            if 0&lt;=i&lt;m:
                A[i][j]=1
    return A</p>
<p>def indep_rows(A):
    m=len(A); n=len(A[0]) if m else 0
    from fractions import Fraction
    M=[list(map(Fraction,row)) for row in A]
    rows=list(range(m))
    r=0; c=0; sel=[]
    while r&lt;m and c&lt;n:
        piv=None
        for i in range(r,m):
            if M[i][c]!=0:
                piv=i; break
        if piv is None:
            c+=1; continue
        if piv!=r:
            M[r],M[piv]=M[piv],M[r]
            rows[r],rows[piv]=rows[piv],rows[r]
        pivv=M[r][c]
        for i in range(m):
            if i!=r and M[i][c]!=0:
                f=M[i][c]/pivv
                for j in range(c,n):
                    M[i][j]-=f*M[r][j]
        sel.append(rows[r]); r+=1; c+=1
    sel.sort(); return sel</p>
<p>def det_int(M):
    n=len(M)
    if n==0: return 1
    A=[row[:] for row in M]
    det=1; prev=1
    for k in range(n-1):
        piv=k
        while piv&lt;n and A[piv][k]==0:
            piv+=1
        if piv==n: return 0
        if piv!=k:
            A[k],A[piv]=A[piv],A[k]
            det=-det
        pivv=A[k][k]
        for i in range(k+1,n):
            for j in range(k+1,n):
                A[i][j]=(A[i][j]<em>pivv - A[i][k]</em>A[k][j])//prev
            A[i][k]=0
        prev=pivv
    return det*A[n-1][n-1]</p>
<p>def solve_lp(Ar, tr):
    m=len(Ar); n=len(Ar[0]) if m else 0
    best=None; bestx=None
    for comb in combinations(range(n), m):
        B=[[Ar[i][j] for j in comb] for i in range(m)]
        if det_int(B)==0: continue
        # solve B x = tr
        rdim=m
        MT=[[Fraction(B[i][j]) for j in range(rdim)] for i in range(rdim)]
        b=[Fraction(tr[i]) for i in range(rdim)]
        ok=True
        for i in range(rdim):
            piv=i
            while piv&lt;rdim and MT[piv][i]==0:
                piv+=1
            if piv==rdim: ok=False; break
            if piv!=i:
                MT[i],MT[piv]=MT[piv],MT[i]
                b[i],b[piv]=b[piv],b[i]
            pivv=MT[i][i]
            for u in range(rdim):
                if u!=i and MT[u][i]!=0:
                    f=MT[u][i]/pivv
                    for j in range(i,rdim):
                        MT[u][j]-=f<em>MT[i][j]
                    b[u]-=f</em>b[i]
        if not ok: continue
        xB=[Fraction(0)]<em>rdim
        for i in range(rdim-1,-1,-1):
            s=b[i]
            for j in range(i+1,rdim):
                s-=MT[i][j]</em>xB[j]
            xB[i]=s/MT[i][i]
        if any(xx&lt;0 for xx in xB):
            continue
        x=[Fraction(0)]*n
        for pos,j in enumerate(comb):
            x[j]=xB[pos]
        val=sum(x)
        if best is None or val&lt;best:
            best=val; bestx=x
    return best,bestx</p>
<p>cnt=0; frac=0
for li,line in enumerate(lines,1):
    if not line.strip():
        continue
    t,buttons=parse_line(line)
    A=build_A(t,buttons)
    m=len(A); n=len(A[0]) if m else 0
    # remove zero cols
    keep=[j for j in range(n) if any(A[i][j] for i in range(m))]
    A=[[A[i][j] for j in keep] for i in range(m)]
    n=len(A[0]) if m else 0
    # infeasibility check
    bad=any(t[i]&gt;0 and all(A[i][j]==0 for j in range(n)) for i in range(m))
    if bad:
        print('bad at',li)
        continue
    basis=indep_rows(A)
    Ar=[A[i][:] for i in basis]
    tr=[t[i] for i in basis]
    val,x=solve_lp(Ar,tr)
    cnt+=1
    allint=all(xx==int(xx) for xx in x)
    if not allint:
        frac+=1
print('machines processed',cnt,'fractional',frac)
- <strong>Timestamp</strong>: 2025-12-10T16:09:26.799054
- <strong>Duration</strong>: 2.07s
- <strong>Exit Code</strong>: 0</p>
<h3 id="stdout_4">Stdout</h3>
<div class="highlight"><pre><span></span><code>machines processed 157 fractional 23
</code></pre></div>
<h3 id="code_11">Code</h3>
<div class="highlight"><pre><span></span><code>Code file not found in run directory.
</code></pre></div>
<h2 id="solver_p2_bbpy"> solver_p2_bb.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T16:12:22.388595</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_12">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">jolts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">m2</span><span class="p">:</span>
        <span class="n">jtxt</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jtxt</span><span class="p">:</span>
            <span class="n">jolts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jtxt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span><span class="p">,</span> <span class="n">jolts</span>


<span class="k">def</span><span class="w"> </span><span class="nf">row_basis</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="c1"># Return list of indices of independent rows using Gaussian elimination over Q</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Fraction</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="c1"># eliminate other rows</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">pivot_columns</span><span class="p">(</span><span class="n">Ar</span><span class="p">):</span>
    <span class="c1"># Return list of pivot column indices after RREF over Q</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">r</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Fraction</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">Ar</span><span class="p">]</span>
    <span class="n">pivots</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">sel</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">sel</span> <span class="o">!=</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">sel</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
        <span class="c1"># eliminate</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">row</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">row</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">pivots</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">row</span> <span class="o">==</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="n">pivots</span>


<span class="k">def</span><span class="w"> </span><span class="nf">invert_matrix</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="c1"># Invert square matrix B (list of list of ints 0/1) over rationals</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">I</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="c1"># Gauss-Jordan</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="c1"># find pivot</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="c1"># normalize row i not necessary</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">u</span> <span class="o">!=</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">I</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="c1"># Now diagonal but not necessarily 1, divide rows</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="n">d</span>
    <span class="k">return</span> <span class="n">I</span>


<span class="k">def</span><span class="w"> </span><span class="nf">greedy_upper</span><span class="p">(</span><span class="n">Ar</span><span class="p">,</span> <span class="n">tr</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[:]</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">r</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cost</span>
        <span class="n">bestj</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">bestcov</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">bestmin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">cov</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mm</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cov</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">mm</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">mm</span><span class="p">:</span>
                        <span class="n">mm</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cov</span> <span class="o">&gt;</span> <span class="n">bestcov</span> <span class="ow">and</span> <span class="n">mm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mm</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bestcov</span> <span class="o">=</span> <span class="n">cov</span>
                <span class="n">bestj</span> <span class="o">=</span> <span class="n">j</span>
                <span class="n">bestmin</span> <span class="o">=</span> <span class="n">mm</span>
        <span class="k">if</span> <span class="n">bestj</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># cannot reduce further</span>
            <span class="c1"># fallback to sum(r)</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">bestmin</span>
        <span class="n">cost</span> <span class="o">+=</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">bestj</span><span class="p">]:</span>
                <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">v</span>
                <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">A</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># remove zero columns</span>
    <span class="n">k0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">k0</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c1"># infeasible quick</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="c1"># row basis reduction</span>
    <span class="n">Ridx</span> <span class="o">=</span> <span class="n">row_basis</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">Ar</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Ridx</span><span class="p">]</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Ridx</span><span class="p">]</span>
    <span class="n">rdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rdim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">pivs</span> <span class="o">=</span> <span class="n">pivot_columns</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pivs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rdim</span><span class="p">:</span>
        <span class="c1"># rank deficiency implies no solution unless tr matches; but problem likely solvable</span>
        <span class="c1"># extend pivs by arbitrary columns that increase rank using greedy (shouldn&#39;t happen)</span>
        <span class="n">used</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pivs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used</span><span class="p">:</span>
                <span class="n">pivs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pivs</span><span class="p">)</span> <span class="o">==</span> <span class="n">rdim</span><span class="p">:</span>
                    <span class="k">break</span>
    <span class="n">P</span> <span class="o">=</span> <span class="n">pivs</span><span class="p">[:</span><span class="n">rdim</span><span class="p">]</span>
    <span class="n">F</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">P</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="c1"># Build matrices</span>
    <span class="n">B</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">P</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
    <span class="n">C</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">F</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
    <span class="n">B_inv</span> <span class="o">=</span> <span class="n">invert_matrix</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">B_inv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># fallback greedy only</span>
        <span class="k">return</span> <span class="n">greedy_upper</span><span class="p">(</span><span class="n">Ar</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
    <span class="c1"># weights</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="n">Wmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="k">if</span> <span class="n">weights</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="c1"># Precompute free cols vectors and upper bounds</span>
    <span class="n">free_cols</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">free_ub</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">F</span><span class="p">):</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="n">free_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">tr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span> <span class="k">if</span> <span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">free_ub</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ub</span><span class="p">)</span>
    <span class="c1"># initial UB using greedy</span>
    <span class="n">UB</span> <span class="o">=</span> <span class="n">greedy_upper</span><span class="p">(</span><span class="n">Ar</span><span class="p">,</span> <span class="n">tr</span><span class="p">)</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">UB</span>
    <span class="c1"># recursion state</span>
    <span class="n">t_rem</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[:]</span>
    <span class="n">presses_so_far</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># row-based lower bound function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">lower_bound_rows</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="k">if</span> <span class="n">vec</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sum_bound</span><span class="p">(</span><span class="n">vec</span><span class="p">):</span>
        <span class="n">S</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">S</span> <span class="o">+</span> <span class="n">Wmax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">Wmax</span>
    <span class="c1"># solver for pivot y given t_rem</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">solve_pivots</span><span class="p">(</span><span class="n">tvec</span><span class="p">):</span>
        <span class="c1"># y = B_inv * tvec</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">rdim</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span><span class="o">*</span><span class="n">n</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">B_inv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">tvec</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
        <span class="c1"># check nonneg integer</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">y</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">denominator</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">total</span>

    <span class="c1"># Depth-first with pruning</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">tvec</span><span class="p">,</span> <span class="n">cost</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">best</span>
        <span class="c1"># LB on remaining regardless of future choices</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lower_bound_rows</span><span class="p">(</span><span class="n">tvec</span><span class="p">),</span> <span class="n">sum_bound</span><span class="p">(</span><span class="n">tvec</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">cost</span> <span class="o">+</span> <span class="n">lb</span> <span class="o">&gt;=</span> <span class="n">best</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">d</span><span class="p">:</span>
            <span class="c1"># solve pivots</span>
            <span class="n">total_y</span> <span class="o">=</span> <span class="n">solve_pivots</span><span class="p">(</span><span class="n">tvec</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">total_y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">cand</span> <span class="o">=</span> <span class="n">cost</span> <span class="o">+</span> <span class="n">total_y</span>
            <span class="k">if</span> <span class="n">cand</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">cand</span>
            <span class="k">return</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">free_cols</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="n">free_ub</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="c1"># iterate z from 0..ub</span>
        <span class="c1"># Try larger z first? larger z reduces residual but increases cost; we&#39;ll try to estimate best direction: choose z up to ub but we can compute z*weight vs cost tradeoff. We&#39;ll try range that keeps tvec nonnegative.</span>
        <span class="c1"># Precompute positions where vec[i]==1</span>
        <span class="n">posrows</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span> <span class="k">if</span> <span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
        <span class="c1"># also compute min residual over those rows as dynamic ub</span>
        <span class="n">dyn_ub</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">tvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">posrows</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dyn_ub</span> <span class="o">&lt;</span> <span class="n">ub</span><span class="p">:</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="n">dyn_ub</span>
        <span class="c1"># try values in a heuristic order: choose value that roughly minimizes cost + lb quickly; evaluate a few candidates then full range</span>
        <span class="c1"># We&#39;ll just loop 0..ub</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ub</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cost</span> <span class="o">+</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="n">best</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="c1"># compute new tvec</span>
            <span class="k">if</span> <span class="n">z</span><span class="p">:</span>
                <span class="n">tnew</span> <span class="o">=</span> <span class="n">tvec</span><span class="p">[:]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">posrows</span><span class="p">:</span>
                    <span class="n">tnew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">z</span>
                    <span class="k">if</span> <span class="n">tnew</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">tnew</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">tnew</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tnew</span> <span class="o">=</span> <span class="n">tvec</span>
            <span class="c1"># Quick bound after applying z</span>
            <span class="n">lb2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lower_bound_rows</span><span class="p">(</span><span class="n">tnew</span><span class="p">),</span> <span class="n">sum_bound</span><span class="p">(</span><span class="n">tnew</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cost</span> <span class="o">+</span> <span class="n">z</span> <span class="o">+</span> <span class="n">lb2</span> <span class="o">&gt;=</span> <span class="n">best</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">dfs</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">tnew</span><span class="p">,</span> <span class="n">cost</span><span class="o">+</span><span class="n">z</span><span class="p">)</span>

    <span class="n">dfs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_rem</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">jolts</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">v</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="-c_3"> -c</h2>
<p>import re
from itertools import combinations
from fractions import Fraction</p>
<p>lines=open('input.txt','r',encoding='utf-8').read().splitlines()</p>
<p>def parse_line(line):
    m2 = re.search(r"{([^}]*)}", line)
    jolts = [int(x) for x in m2.group(1).split(',')]
    buttons=[]
    for grp in re.finditer(r"<span class="arithmatex">\(([^)]*)\)</span>", line):
        s=grp.group(1).strip()
        if s:
            buttons.append([int(x) for x in s.split(',')])
        else:
            buttons.append([])
    return jolts, buttons</p>
<p>def build_A(t,buttons):
    m=len(t); k=len(buttons)
    A=[[0]*k for _ in range(m)]
    for j,idxs in enumerate(buttons):
        for i in idxs:
            if 0&lt;=i&lt;m:
                A[i][j]=1
    return A</p>
<p>def rank_frac(A):
    m=len(A); n=len(A[0]) if m else 0
    from fractions import Fraction
    M=[list(map(Fraction,row)) for row in A]
    r=0; c=0
    while r&lt;m and c&lt;n:
        piv=None
        for i in range(r,m):
            if M[i][c]!=0:
                piv=i; break
        if piv is None:
            c+=1; continue
        if piv!=r:
            M[r],M[piv]=M[piv],M[r]
        pivv=M[r][c]
        for i in range(m):
            if i!=r and M[i][c]!=0:
                f=M[i][c]/pivv
                for j in range(c,n):
                    M[i][j]-=f*M[r][j]
        r+=1; c+=1
    return r</p>
<p>def bareiss_det(M):
    n=len(M)
    if n==0: return 1
    A=[row[:] for row in M]
    det_sign=1
    prev=1
    for k in range(n-1):
        piv=k
        while piv&lt;n and A[piv][k]==0:
            piv+=1
        if piv==n: return 0
        if piv!=k:
            A[k],A[piv]=A[piv],A[k]
            det_sign=-det_sign
        pivv=A[k][k]
        for i in range(k+1,n):
            for j in range(k+1,n):
                A[i][j]=(A[i][j]<em>pivv - A[i][k]</em>A[k][j])//prev
            A[i][k]=0
        prev=pivv
    return det_sign*A[n-1][n-1]</p>
<p>from collections import Counter
Ds=Counter()
frac_cnt=0
for line in lines:
    if not line.strip(): continue
    t,buttons=parse_line(line)
    A=build_A(t,buttons)
    m=len(A); n=len(A[0]) if m else 0
    # remove zero cols
    keep=[j for j in range(n) if any(A[i][j] for i in range(m))]
    A=[[A[i][j] for j in keep] for i in range(m)]
    n=len(A[0]) if m else 0
    # independent rows
    # find rank
    r=rank_frac(A)
    # enumerate combos to find minimal nonzero |det|
    best=None
    for cols in combinations(range(n), r):
        B=[[A[i][j] for j in cols] for i in range(m)]
        # need B square r x r; but A is m x n with m possibly &gt; r; we need choose r rows as well to compute det? Wait det defined for square matrix: choose r rows of A? We should reduce to independent rows first.</p>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T16:13:36.497238</li>
<li><strong>Duration</strong>: 0.15s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="code_13">Code</h3>
<div class="highlight"><pre><span></span><code>Code file not found in run directory.
</code></pre></div>
<h2 id="solver2_finalpy"> solver2_final.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T16:16:21.595367</li>
<li><strong>Duration</strong>: 0.39s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout_5">Stdout</h3>
<div class="highlight"><pre><span></span><code>399
36427
</code></pre></div>
<h3 id="code_14">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">gcd</span>

<span class="c1"># Parsing helpers</span>

<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[(.*?)\]&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">pattern</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">]</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">jolts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">m2</span><span class="p">:</span>
        <span class="n">jtxt</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jtxt</span><span class="p">:</span>
            <span class="n">jolts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jtxt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">,</span> <span class="n">jolts</span>

<span class="c1"># Part 1 solver (from earlier, optimized)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_matrix_bool</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">n</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="n">maskj</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">rows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">maskj</span>
    <span class="k">return</span> <span class="n">rows</span><span class="p">,</span> <span class="n">k</span>


<span class="k">def</span><span class="w"> </span><span class="nf">rref</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[:]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">[:]</span>
    <span class="n">pivot_row_of_col</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">k</span>
    <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">row</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">col</span>
        <span class="n">sel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="n">r</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">sel</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">sel</span> <span class="o">!=</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">rows</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">sel</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
            <span class="n">b</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">sel</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">sel</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="c1"># eliminate other rows</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">row</span> <span class="ow">and</span> <span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">):</span>
                <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">^=</span> <span class="n">rows</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
                <span class="n">b</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">^=</span> <span class="n">b</span><span class="p">[</span><span class="n">row</span><span class="p">]</span>
        <span class="n">pivot_row_of_col</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span>
        <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">rows</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">pivot_row_of_col</span>


<span class="k">def</span><span class="w"> </span><span class="nf">particular_and_nullspace</span><span class="p">(</span><span class="n">rows_rref</span><span class="p">,</span> <span class="n">b_rref</span><span class="p">,</span> <span class="n">pivot_row_of_col</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="n">pivot_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pivot_row_of_col</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">pivot_row_by_col</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">pivot_row_of_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pivot_cols</span><span class="p">}</span>
    <span class="n">free_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="n">pivot_row_of_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pivot_cols</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">pivot_row_by_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">b_rref</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x0</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">free_cols</span><span class="p">:</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">f</span>
        <span class="n">mask_f</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">f</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pivot_cols</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">pivot_row_by_col</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">rows_rref</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask_f</span><span class="p">:</span>
                <span class="n">vec</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x0</span><span class="p">,</span> <span class="n">basis</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_part1</span><span class="p">(</span><span class="n">machines</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">machines</span><span class="p">:</span>
        <span class="n">rows</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">build_matrix_bool</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="n">rows_rref</span><span class="p">,</span> <span class="n">b_rref</span><span class="p">,</span> <span class="n">piv</span> <span class="o">=</span> <span class="n">rref</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rows_rref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># fallback BFS (small n here)</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">deque</span>
            <span class="n">tgt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">tgt</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">)</span>
            <span class="n">moves</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">:</span>
                <span class="n">msk</span><span class="o">=</span><span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="mi">0</span><span class="o">&lt;=</span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">:</span>
                        <span class="n">msk</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">)</span>
                <span class="n">moves</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msk</span><span class="p">)</span>
            <span class="n">seen</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
            <span class="n">dq</span><span class="o">=</span><span class="n">deque</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">while</span> <span class="n">dq</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">dq</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">seen</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
                <span class="n">nd</span> <span class="o">=</span> <span class="n">d</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">mv</span> <span class="ow">in</span> <span class="n">moves</span><span class="p">:</span>
                    <span class="n">ns</span> <span class="o">=</span> <span class="n">s</span> <span class="o">^</span> <span class="n">mv</span>
                    <span class="k">if</span> <span class="n">ns</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ns</span><span class="o">==</span><span class="n">tgt</span><span class="p">:</span>
                            <span class="n">total</span> <span class="o">+=</span> <span class="n">nd</span>
                            <span class="k">break</span>
                        <span class="n">seen</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span><span class="o">=</span><span class="n">nd</span>
                        <span class="n">dq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x0</span><span class="p">,</span> <span class="n">basis</span> <span class="o">=</span> <span class="n">particular_and_nullspace</span><span class="p">(</span><span class="n">rows_rref</span><span class="p">,</span> <span class="n">b_rref</span><span class="p">,</span> <span class="n">piv</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basis</span><span class="p">)</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">d</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">vec</span><span class="o">=</span><span class="n">x0</span>
                <span class="n">prev_gray</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">total_comb</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">d</span>
                <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">total_comb</span><span class="p">):</span>
                    <span class="n">gray</span> <span class="o">=</span> <span class="n">g</span><span class="o">^</span><span class="p">(</span><span class="n">g</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="n">prev_gray</span> <span class="o">^</span> <span class="n">gray</span>
                    <span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&amp;</span> <span class="o">-</span><span class="n">diff</span><span class="p">)</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">vec</span> <span class="o">^=</span> <span class="n">basis</span><span class="p">[</span><span class="n">bit</span><span class="p">]</span>
                    <span class="n">bc</span> <span class="o">=</span> <span class="n">vec</span><span class="o">.</span><span class="n">bit_count</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">bc</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                        <span class="n">best</span> <span class="o">=</span> <span class="n">bc</span>
                    <span class="n">prev_gray</span> <span class="o">=</span> <span class="n">gray</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">best</span>
    <span class="k">return</span> <span class="n">total</span>

<span class="c1"># Part 2 solver using unimodular or small-det basis and enumeration over nullspace (d&lt;=3)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">build_A_jolt</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span>


<span class="k">def</span><span class="w"> </span><span class="nf">independent_rows</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Fraction</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">basis</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bareiss_det</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">M</span><span class="p">]</span>
    <span class="n">det_sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">det_sign</span> <span class="o">=</span> <span class="o">-</span><span class="n">det_sign</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">pivv</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">//</span> <span class="n">prev</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">pivv</span>
    <span class="k">return</span> <span class="n">det_sign</span> <span class="o">*</span> <span class="n">A</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">invert_matrix_frac</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">I</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="c1"># Gauss-Jordan</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">u</span> <span class="o">!=</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">I</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="c1"># Normalize rows</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="n">d</span>
    <span class="k">return</span> <span class="n">I</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine_part2</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">build_A_jolt</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c1"># Remove zero-effect columns</span>
    <span class="n">keep_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keep_cols</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">k</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">keep_cols</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">keep_cols</span><span class="p">)</span>
        <span class="c1"># adjust button weights list mapping later; we will compute weights from new A</span>
    <span class="c1"># Quick infeasibility</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">jolts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="c1"># Row reduction</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">independent_rows</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">Ar</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="p">[</span><span class="n">jolts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="n">rdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rdim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Choose best column set P of size rdim with minimal |det|</span>
    <span class="n">best_det</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_P</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Precompute column weights over ORIGINAL rows (after zero-col removal)</span>
    <span class="n">col_weights</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="c1"># Precompute columns as lists for Ar</span>
    <span class="n">cols_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="c1"># iterate combinations, break early if det==1</span>
    <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">cols_idx</span><span class="p">,</span> <span class="n">rdim</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">comb</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">bareiss_det</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ad</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">best_det</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ad</span> <span class="o">&lt;</span> <span class="n">best_det</span> <span class="ow">or</span> <span class="p">(</span><span class="n">ad</span> <span class="o">==</span> <span class="n">best_det</span> <span class="ow">and</span> <span class="nb">max</span><span class="p">(</span><span class="n">col_weights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">comb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">(</span><span class="n">col_weights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">best_P</span><span class="p">)):</span>
            <span class="n">best_det</span> <span class="o">=</span> <span class="n">ad</span>
            <span class="n">best_P</span> <span class="o">=</span> <span class="n">comb</span>
            <span class="k">if</span> <span class="n">ad</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">break</span>
    <span class="k">if</span> <span class="n">best_P</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="n">P</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">best_P</span><span class="p">)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">P</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
    <span class="c1"># Build matrices</span>
    <span class="n">B</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">P</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
    <span class="n">C</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">F</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
    <span class="c1"># invert B over fractions, compute adjB and D</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">bareiss_det</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="n">ad</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="n">Binv</span> <span class="o">=</span> <span class="n">invert_matrix_frac</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Binv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="c1"># adjB = Binv * D</span>
    <span class="n">adjB</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Binv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">ad</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
    <span class="c1"># u = adjB * tr (integers)</span>
    <span class="n">u</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">rdim</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="n">adjB</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">tr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="c1"># convert to int</span>
        <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">numerator</span> <span class="o">//</span> <span class="n">s</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
    <span class="c1"># Pmat = adjB * C (integers)</span>
    <span class="n">Pmat</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">d</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">adjB</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
            <span class="n">Pmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">numerator</span> <span class="o">//</span> <span class="n">s</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
    <span class="c1"># weights</span>
    <span class="n">wp</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_weights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">P</span><span class="p">]</span>
    <span class="n">wf</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_weights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">F</span><span class="p">]</span>
    <span class="n">wp_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">wp</span><span class="p">)</span> <span class="k">if</span> <span class="n">wp</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="n">S_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
    <span class="c1"># Enumeration over z in d dims</span>
    <span class="c1"># Order free vars by initial ub to minimize branching</span>
    <span class="n">init_bounds</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="n">anypos</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">Pmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">anypos</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ub</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ub</span><span class="p">,</span> <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">a</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">anypos</span><span class="p">:</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">init_bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ub</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">init_bounds</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="c1"># rearrange Pmat columns, wf accordingly</span>
    <span class="n">Pmat_ord</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Pmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">order</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
    <span class="n">wf_ord</span> <span class="o">=</span> <span class="p">[</span><span class="n">wf</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">order</span><span class="p">]</span>

    <span class="n">best</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="n">Dmod</span> <span class="o">=</span> <span class="n">ad</span>

    <span class="c1"># Precompute gcds for remaining sets might be expensive; compute on the fly</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">gcd_divides_residual</span><span class="p">(</span><span class="n">uvec</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">):</span>
        <span class="c1"># For each row i, compute g_i = gcd(D, Pmat[i][j] for j in remaining). Check uvec[i] % g_i == 0 is possible condition (necessary for existence of z making divisibility).</span>
        <span class="k">if</span> <span class="n">Dmod</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">rdim</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Dmod</span>
            <span class="k">for</span> <span class="n">jpos</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">Pmat_ord</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jpos</span><span class="p">]</span> <span class="o">%</span> <span class="n">Dmod</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">gcd</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">g</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">uvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="n">g</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">uvec</span><span class="p">,</span> <span class="n">zsum</span><span class="p">,</span> <span class="n">zw_sum</span><span class="p">):</span>
        <span class="k">nonlocal</span> <span class="n">best</span>
        <span class="c1"># Lower bound via weights</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">zsum</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span><span class="n">S_total</span> <span class="o">-</span> <span class="n">zw_sum</span> <span class="o">+</span> <span class="n">wp_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">wp_max</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">lb</span> <span class="o">&gt;=</span> <span class="n">best</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">d</span><span class="p">:</span>
            <span class="c1"># Check integrality: uvec[i] % Dmod == 0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">uvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="n">Dmod</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">uvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">%</span> <span class="n">Dmod</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">return</span>
            <span class="c1"># Compute x_B sum</span>
            <span class="n">sxb</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                <span class="n">sxb</span> <span class="o">+=</span> <span class="n">uvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">Dmod</span>
            <span class="n">total</span> <span class="o">=</span> <span class="n">zsum</span> <span class="o">+</span> <span class="n">sxb</span>
            <span class="k">if</span> <span class="n">total</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
                <span class="n">best</span> <span class="o">=</span> <span class="n">total</span>
            <span class="k">return</span>
        <span class="c1"># Quick necessary modular feasibility check</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gcd_divides_residual</span><span class="p">(</span><span class="n">uvec</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="c1"># Compute ub for this var</span>
        <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pmat_ord</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="c1"># If all coefficients &lt;=0, best is 0</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">col</span><span class="p">):</span>
            <span class="n">dfs</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">uvec</span><span class="p">,</span> <span class="n">zsum</span><span class="p">,</span> <span class="n">zw_sum</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lim</span> <span class="o">=</span> <span class="n">uvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">a</span>
                <span class="k">if</span> <span class="n">lim</span> <span class="o">&lt;</span> <span class="n">ub</span><span class="p">:</span>
                    <span class="n">ub</span> <span class="o">=</span> <span class="n">lim</span>
        <span class="k">if</span> <span class="n">ub</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">wj</span> <span class="o">=</span> <span class="n">wf_ord</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="c1"># Iterate z value</span>
        <span class="c1"># We can try small to large; cost grows with z but pivot cost might drop. The LB accounts partly. We&#39;ll do 0..ub.</span>
        <span class="c1"># Additionally, we can compute a quick bound on uvec sum to possibly compute better LB, but we&#39;ll keep simple.</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ub</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Update uvec</span>
            <span class="k">if</span> <span class="n">z</span><span class="p">:</span>
                <span class="c1"># new u = u - col*z</span>
                <span class="n">newu</span> <span class="o">=</span> <span class="n">uvec</span><span class="p">[:]</span>  <span class="c1"># copy</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">newu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">z</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="n">newu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">dfs</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newu</span><span class="p">,</span> <span class="n">zsum</span><span class="o">+</span><span class="n">z</span><span class="p">,</span> <span class="n">zw_sum</span> <span class="o">+</span> <span class="n">wj</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dfs</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">uvec</span><span class="p">,</span> <span class="n">zsum</span><span class="p">,</span> <span class="n">zw_sum</span><span class="p">)</span>
            <span class="c1"># Optional prune if zsum already exceeds best</span>
            <span class="k">if</span> <span class="n">zsum</span> <span class="o">+</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="n">best</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="c1"># Initial uvec is u (integers)</span>
    <span class="n">dfs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[:],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_part2</span><span class="p">(</span><span class="n">machines</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">buttons</span><span class="p">,</span> <span class="n">jolts</span> <span class="ow">in</span> <span class="n">machines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">jolts</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">solve_machine_part2</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>  <span class="c1"># fallback</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">v</span>
    <span class="k">return</span> <span class="n">total</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">machines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">line</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">machines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
    <span class="n">part1</span> <span class="o">=</span> <span class="n">solve_part1</span><span class="p">(</span><span class="n">machines</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">part1</span><span class="p">)</span>
    <span class="n">part2</span> <span class="o">=</span> <span class="n">solve_part2</span><span class="p">(</span><span class="n">machines</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">part2</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solver_p2_astarpy"> solver_p2_astar.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T16:19:12.106063</li>
<li><strong>Duration</strong>: 60.00s</li>
<li><strong>Exit Code</strong>: timeout</li>
<li><strong>Error</strong>: TimeoutExpired</li>
</ul>
<h3 id="code_15">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">heapq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">jolts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">m2</span><span class="p">:</span>
        <span class="n">jtxt</span> <span class="o">=</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">jtxt</span><span class="p">:</span>
            <span class="n">jolts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">jtxt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
        <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span>


<span class="k">def</span><span class="w"> </span><span class="nf">independent_rows</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="c1"># Gaussian elimination over rationals, tracking row order</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Fraction</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="c1"># eliminate</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">basis</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bareiss_det</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">M</span><span class="p">]</span>
    <span class="n">det_sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">det_sign</span> <span class="o">=</span> <span class="o">-</span><span class="n">det_sign</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">pivv</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">//</span> <span class="n">prev</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">pivv</span>
    <span class="k">return</span> <span class="n">det_sign</span> <span class="o">*</span> <span class="n">A</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">invert_frac</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">I</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">u</span> <span class="o">!=</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">I</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="n">d</span>
    <span class="k">return</span> <span class="n">I</span>


<span class="k">def</span><span class="w"> </span><span class="nf">precompute_bases</span><span class="p">(</span><span class="n">Ar</span><span class="p">):</span>
    <span class="c1"># Returns list of (D, adjB_rows, s_vec) where adjB_rows is list of rows (list of ints), s_vec is sum of rows</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">r</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">bases</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cols_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">cols_idx</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">comb</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">)]</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">bareiss_det</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">D</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
        <span class="n">Binv</span> <span class="o">=</span> <span class="n">invert_frac</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Binv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># adjB = Binv * D (should be integer)</span>
        <span class="n">adjB_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s_vec</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">r</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">Binv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">D</span>
                <span class="c1"># ensure int</span>
                <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">denominator</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="n">ival</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">numerator</span><span class="p">)</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ival</span><span class="p">)</span>
                <span class="n">s_vec</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">ival</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">adjB_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">bases</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">D</span><span class="p">,</span> <span class="n">adjB_rows</span><span class="p">,</span> <span class="n">s_vec</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">bases</span>


<span class="k">def</span><span class="w"> </span><span class="nf">heuristic_lp</span><span class="p">(</span><span class="n">bases</span><span class="p">,</span> <span class="n">rvec</span><span class="p">):</span>
    <span class="c1"># Compute min over bases of ceil( sum_i (adjB_rows[i] dot r) / D ) with feasibility that each numerator &gt;= 0</span>
    <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">D</span><span class="p">,</span> <span class="n">adjB_rows</span><span class="p">,</span> <span class="n">svec</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">ssum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adjB_rows</span><span class="p">):</span>
            <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># dot row with rvec</span>
            <span class="c1"># manual for speed</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">rvec</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                    <span class="n">num</span> <span class="o">+=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">rvec</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="n">ssum</span> <span class="o">+=</span> <span class="n">num</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">ssum</span> <span class="o">+</span> <span class="n">D</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">D</span>
        <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">:</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">val</span>
    <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># fallback lower bound 0</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">best</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine_astar</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># remove zero columns</span>
    <span class="n">k0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">k0</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c1"># quick infeasible</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">jolts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="c1"># Row independence reduction</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">independent_rows</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">Ar</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="p">[</span><span class="n">jolts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="n">rdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rdim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># Precompute columns as lists covering rows</span>
    <span class="n">cols_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span> <span class="k">if</span> <span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]]</span>
        <span class="n">cols_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="n">weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">))</span>
    <span class="n">wmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="k">if</span> <span class="n">weights</span> <span class="k">else</span> <span class="mi">1</span>
    <span class="c1"># Precompute LP bases</span>
    <span class="n">bases</span> <span class="o">=</span> <span class="n">precompute_bases</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="c1"># Heuristic function</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">hfunc</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
        <span class="c1"># sum bound and max bound</span>
        <span class="n">S</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">lb1</span> <span class="o">=</span> <span class="p">(</span><span class="n">S</span> <span class="o">+</span> <span class="n">wmax</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">wmax</span>
        <span class="n">lb2</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">lb_lp</span> <span class="o">=</span> <span class="n">heuristic_lp</span><span class="p">(</span><span class="n">bases</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">lb1</span><span class="p">,</span> <span class="n">lb2</span><span class="p">,</span> <span class="n">lb_lp</span><span class="p">)</span>
    <span class="c1"># A* search</span>
    <span class="n">start</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">start</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
    <span class="n">pq</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">g0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">h0</span> <span class="o">=</span> <span class="n">hfunc</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
    <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">pq</span><span class="p">,</span> <span class="p">(</span><span class="n">g0</span> <span class="o">+</span> <span class="n">h0</span><span class="p">,</span> <span class="n">g0</span><span class="p">,</span> <span class="n">start</span><span class="p">))</span>
    <span class="n">best_g</span> <span class="o">=</span> <span class="p">{</span><span class="n">start</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
    <span class="n">expansions</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">pq</span><span class="p">:</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="n">heapq</span><span class="o">.</span><span class="n">heappop</span><span class="p">(</span><span class="n">pq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span> <span class="o">!=</span> <span class="n">best_g</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">state</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">g</span>
        <span class="c1"># expand</span>
        <span class="n">expansions</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># choose columns that touch at least one positive residual and don&#39;t cause negative residual</span>
        <span class="c1"># prefer columns with higher coverage among positive rows</span>
        <span class="n">pos_rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pos_rows</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">g</span>
        <span class="n">cand_js</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">cols_rows</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">touch</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">touch</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">touch</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
            <span class="c1"># We ensure that subtracting 1 won&#39;t go negative: need all covered rows have state&gt;=1</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">cand_js</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rows</span><span class="p">),</span> <span class="n">j</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cand_js</span><span class="p">:</span>
            <span class="c1"># dead end, shouldn&#39;t happen if feasible</span>
            <span class="k">continue</span>
        <span class="n">cand_js</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cand_js</span><span class="p">[:</span><span class="n">k</span><span class="p">]:</span>
            <span class="c1"># apply one press of j</span>
            <span class="n">newr</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cols_rows</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
                <span class="n">newr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">newt</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">newr</span><span class="p">)</span>
            <span class="n">ng</span> <span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">newt</span> <span class="ow">in</span> <span class="n">best_g</span> <span class="ow">and</span> <span class="n">best_g</span><span class="p">[</span><span class="n">newt</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">ng</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">hfunc</span><span class="p">(</span><span class="n">newr</span><span class="p">)</span>
            <span class="n">nf</span> <span class="o">=</span> <span class="n">ng</span> <span class="o">+</span> <span class="n">h</span>
            <span class="n">best_g</span><span class="p">[</span><span class="n">newt</span><span class="p">]</span> <span class="o">=</span> <span class="n">ng</span>
            <span class="n">heapq</span><span class="o">.</span><span class="n">heappush</span><span class="p">(</span><span class="n">pq</span><span class="p">,</span> <span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="n">ng</span><span class="p">,</span> <span class="n">newt</span><span class="p">))</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_all</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">jolts</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">solve_machine_astar</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">v</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">solve_all</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div>
<h2 id="solver_p2_multi_basispy"> solver_p2_multi_basis.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T16:22:34.933535</li>
<li><strong>Duration</strong>: 0.14s</li>
<li><strong>Exit Code</strong>: 1</li>
<li><strong>Error</strong>: Non-zero exit code</li>
</ul>
<h3 id="stderr_3">Stderr</h3>
<div class="highlight"><pre><span></span><code>Traceback (most recent call last):
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_multi_basis.py&quot;, line 292, in &lt;module&gt;
    main()
    ~~~~^^
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_multi_basis.py&quot;, line 285, in main
    v = machine_cost(t, buttons)
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_multi_basis.py&quot;, line 269, in machine_cost
    dfs(0, u[:], 0, 0)
    ~~~^^^^^^^^^^^^^^^
  File &quot;C:\work\aoc\aoc-agent\data\run\2025-12-10_15-42-03_2025_10_python_gpt-5_8f9fc7fd\solver_p2_multi_basis.py&quot;, line 229, in dfs
    col = [P_ord[i][idx] for i in range(rdim)]
           ~~~~~~~~^^^^^
IndexError: list index out of range
</code></pre></div>
<h3 id="code_16">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">gcd</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">jolts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">m2</span><span class="p">:</span>
        <span class="n">jolts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
    <span class="k">return</span> <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span>


<span class="k">def</span><span class="w"> </span><span class="nf">independent_rows</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Fraction</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">basis</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bareiss_det</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">M</span><span class="p">]</span>
    <span class="n">det_sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">det_sign</span> <span class="o">=</span> <span class="o">-</span><span class="n">det_sign</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">pivv</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">//</span> <span class="n">prev</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">pivv</span>
    <span class="k">return</span> <span class="n">det_sign</span> <span class="o">*</span> <span class="n">A</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">invert_frac</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">I</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">u</span> <span class="o">!=</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">I</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="n">d</span>
    <span class="k">return</span> <span class="n">I</span>


<span class="k">def</span><span class="w"> </span><span class="nf">machine_cost</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># remove zero columns</span>
    <span class="n">k0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">k0</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c1"># infeasible quick</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">jolts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="c1"># row reduction</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">independent_rows</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">Ar</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="p">[</span><span class="n">jolts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="n">rdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rdim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># precompute column weights</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="c1"># Enumerate all bases and take min</span>
    <span class="n">cols_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="n">best_total</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">cols_idx</span><span class="p">,</span> <span class="n">rdim</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">comb</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">bareiss_det</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">Binv</span> <span class="o">=</span> <span class="n">invert_frac</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Binv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Use D with sign handled by making Dpos and sign s</span>
        <span class="n">Dpos</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
        <span class="n">sgn</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">D</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># adjB = Binv * D = integer</span>
        <span class="n">adjB</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Binv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">D</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="c1"># compute u&#39; = sgn*adjB * tr and P&#39; = sgn*adjB * C</span>
        <span class="n">F</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cols_idx</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">comb</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
        <span class="c1"># Build C</span>
        <span class="n">C</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">F</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">rdim</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">adjB</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">tr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sgn</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">numerator</span> <span class="o">//</span> <span class="p">(</span><span class="n">sgn</span> <span class="o">*</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
        <span class="n">Pmat</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">d</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">adjB</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">sgn</span> <span class="o">*</span> <span class="n">s</span>
                <span class="n">Pmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">numerator</span> <span class="o">//</span> <span class="n">val</span><span class="o">.</span><span class="n">denominator</span><span class="p">)</span>
        <span class="c1"># Now constraints: u - P z must be &gt;= 0 and divisible by Dpos</span>
        <span class="c1"># Precompute column sums for cost slope</span>
        <span class="n">p_sums</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">Pmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">))</span> <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">)]</span>
        <span class="c1"># Order variables to reduce branching: ones with upper bounds small first</span>
        <span class="n">ubs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="n">Pmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
            <span class="c1"># upper bound from positive entries</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">a</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># no positive entries: restrict by Dpos for congruence; also cost slope positive =&gt; prefer small</span>
                <span class="n">ub</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Dpos</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span> <span class="k">if</span> <span class="n">Dpos</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">ubs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ub</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">j</span><span class="p">:</span> <span class="n">ubs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        <span class="n">P_ord</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Pmat</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">order</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="n">w_ord</span> <span class="o">=</span> <span class="p">[</span><span class="n">weights</span><span class="p">[</span><span class="n">F</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">order</span><span class="p">]</span>
        <span class="n">p_ord</span> <span class="o">=</span> <span class="p">[</span><span class="n">p_sums</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">order</span><span class="p">]</span>
        <span class="c1"># DFS</span>
        <span class="n">S_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
        <span class="n">wPmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">comb</span><span class="p">)</span> <span class="k">if</span> <span class="n">comb</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">best_here</span> <span class="o">=</span> <span class="n">best_total</span>

        <span class="c1"># simple memo: map tuple(u) to best zsum seen</span>
        <span class="n">memo</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">uvec</span><span class="p">,</span> <span class="n">zsum</span><span class="p">,</span> <span class="n">zw_sum</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">best_here</span>
            <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">uvec</span><span class="p">))</span>
            <span class="n">prev</span> <span class="o">=</span> <span class="n">memo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">prev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prev</span> <span class="o">&lt;=</span> <span class="n">zsum</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">memo</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">zsum</span>
            <span class="c1"># compute lower bound on remaining cost</span>
            <span class="c1"># counters left at least approximated by minimal pivots sum bound: remaining sum counters = ? Hard; use wmax bound with total counters left ~ &lt;= sum(uvec)/Dpos? Not exact.</span>
            <span class="c1"># Use: minimal pivot presses &gt;= ceil( sum( (u_i mod Dpos?)/Dpos ) )? We&#39;ll use crude bound 0.</span>
            <span class="c1"># But we can use row-wise LB: For any row i, need x_P_i &gt;= ceil(uvec[i]/Dpos) - sum positive future contributions? We&#39;ll just omit for simplicity.</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">P_ord</span><span class="p">):</span>
                <span class="c1"># check divisibility and compute x_P</span>
                <span class="n">xsum</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                    <span class="n">ui</span> <span class="o">=</span> <span class="n">uvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ui</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span>
                    <span class="k">if</span> <span class="n">Dpos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span>
                    <span class="k">if</span> <span class="n">ui</span> <span class="o">%</span> <span class="n">Dpos</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">return</span>
                    <span class="n">xsum</span> <span class="o">+=</span> <span class="n">ui</span> <span class="o">//</span> <span class="n">Dpos</span>
                <span class="n">total</span> <span class="o">=</span> <span class="n">zsum</span> <span class="o">+</span> <span class="n">xsum</span>
                <span class="k">if</span> <span class="n">total</span> <span class="o">&lt;</span> <span class="n">best_here</span><span class="p">:</span>
                    <span class="n">best_here</span> <span class="o">=</span> <span class="n">total</span>
                <span class="k">return</span>
            <span class="c1"># compute ub for this var</span>
            <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="n">P_ord</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">has_pos</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">has_pos</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">lim</span> <span class="o">=</span> <span class="n">uvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">a</span>
                    <span class="k">if</span> <span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lim</span> <span class="o">&lt;</span> <span class="n">ub</span><span class="p">:</span>
                        <span class="n">ub</span> <span class="o">=</span> <span class="n">lim</span>
            <span class="k">if</span> <span class="n">ub</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># no positive entries: cap by Dpos-1 for congruence search</span>
                <span class="n">ub</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Dpos</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
            <span class="c1"># iterate values; try ones that improve cost slope first</span>
            <span class="n">slope</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">p_ord</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="n">Dpos</span><span class="p">)</span>
            <span class="c1"># If slope &lt; 0, bigger z helps; else smaller better</span>
            <span class="k">if</span> <span class="n">slope</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rng</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">ub</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rng</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ub</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">rng</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">zsum</span> <span class="o">+</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="n">best_here</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="c1"># update uvec</span>
                <span class="k">if</span> <span class="n">z</span><span class="p">:</span>
                    <span class="n">newu</span> <span class="o">=</span> <span class="n">uvec</span><span class="p">[:]</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
                        <span class="n">newu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">z</span>
                        <span class="c1"># Since at end we require newu &gt;= 0, but intermediate can be negative if future vars have negative a to increase; we&#39;ll prune if any newu &lt; -Dpos to avoid deep negatives</span>
                        <span class="k">if</span> <span class="n">newu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">Dpos</span><span class="p">:</span>
                            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                        <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newu</span> <span class="o">=</span> <span class="n">uvec</span>
                <span class="n">dfs</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newu</span><span class="p">,</span> <span class="n">zsum</span><span class="o">+</span><span class="n">z</span><span class="p">,</span> <span class="n">zw_sum</span> <span class="o">+</span> <span class="n">w_ord</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">*</span><span class="n">z</span><span class="p">)</span>
                <span class="c1"># light prune</span>
                <span class="k">if</span> <span class="n">best_here</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span>
        <span class="n">dfs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[:],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">best_here</span> <span class="o">&lt;</span> <span class="n">best_total</span><span class="p">:</span>
            <span class="n">best_total</span> <span class="o">=</span> <span class="n">best_here</span>
        <span class="c1"># early exit if equals LP lower bound maybe; skip</span>
    <span class="k">return</span> <span class="n">best_total</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">buttons</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">machine_cost</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">v</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="solver_p2_try_basespy"> solver_p2_try_bases.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T16:27:16.507242</li>
<li><strong>Duration</strong>: 6.19s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout_6">Stdout</h3>
<div class="highlight"><pre><span></span><code>15631
</code></pre></div>
<h3 id="code_17">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fractions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Fraction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">combinations</span>


<span class="k">def</span><span class="w"> </span><span class="nf">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="n">m2</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">jolts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">m2</span><span class="p">:</span>
        <span class="n">jolts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
    <span class="n">buttons</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
    <span class="k">return</span> <span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span>


<span class="k">def</span><span class="w"> </span><span class="nf">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idxs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">buttons</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">A</span>


<span class="k">def</span><span class="w"> </span><span class="nf">independent_rows</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">Fraction</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">A</span><span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">basis</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">m</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">r</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
            <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">c</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        <span class="n">basis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>
        <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">basis</span>


<span class="k">def</span><span class="w"> </span><span class="nf">bareiss_det</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[:]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">M</span><span class="p">]</span>
    <span class="n">det_sign</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">prev</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">det_sign</span> <span class="o">=</span> <span class="o">-</span><span class="n">det_sign</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
                <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">pivv</span> <span class="o">-</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">A</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">//</span> <span class="n">prev</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="n">pivv</span>
    <span class="k">return</span> <span class="n">det_sign</span> <span class="o">*</span> <span class="n">A</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">invert_frac</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">I</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Fraction</span><span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">j</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">piv</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">while</span> <span class="n">piv</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">piv</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">piv</span> <span class="o">!=</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">piv</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">piv</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">pivv</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">u</span> <span class="o">!=</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">pivv</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                    <span class="n">M</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">I</span><span class="p">[</span><span class="n">u</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">I</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="n">d</span>
    <span class="k">return</span> <span class="n">I</span>


<span class="k">def</span><span class="w"> </span><span class="nf">solve_machine</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">build_A</span><span class="p">(</span><span class="n">jolts</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jolts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="c1"># remove zero columns</span>
    <span class="n">k0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">keep</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k0</span><span class="p">)</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">))]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keep</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">k0</span><span class="p">:</span>
        <span class="n">A</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">keep</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span>
    <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">m</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="c1"># infeasible quick</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">jolts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="c1"># row basis</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">independent_rows</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">Ar</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="n">tr</span> <span class="o">=</span> <span class="p">[</span><span class="n">jolts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">R</span><span class="p">]</span>
    <span class="n">rdim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rdim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="n">cols_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
    <span class="n">best_total</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># If square (d=0), solve directly</span>
    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="n">rdim</span><span class="p">:</span>
        <span class="c1"># invert and solve</span>
        <span class="n">Binv</span> <span class="o">=</span> <span class="n">invert_frac</span><span class="p">(</span><span class="n">Ar</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Binv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">rdim</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">Binv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">tr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">denominator</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
            <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="c1"># try all bases</span>
    <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">cols_idx</span><span class="p">,</span> <span class="n">rdim</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">comb</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">bareiss_det</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">D</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
        <span class="n">Binv</span> <span class="o">=</span> <span class="n">invert_frac</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Binv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">F</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">cols_idx</span> <span class="k">if</span> <span class="n">j</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">comb</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">F</span><span class="p">)</span>
        <span class="c1"># Build C</span>
        <span class="n">C</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Ar</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">F</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="c1"># Compute adjB = Binv * D as integers</span>
        <span class="n">adjB</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Binv</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">D</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="c1"># u = adjB * tr</span>
        <span class="n">u</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">rdim</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="n">adjB</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">tr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">denominator</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="n">u</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># P = adjB * C (integer)</span>
        <span class="n">P</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">d</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">Fraction</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="n">adjB</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">t</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">denominator</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># d could be up to 3</span>
        <span class="c1"># Solve by DFS with safe upper bounds using only positive coefficients, but try multiple orders and keep best across bases</span>
        <span class="c1"># Precompute per free var upper bounds naive</span>
        <span class="n">pos_rows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
            <span class="n">rows_pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)</span> <span class="k">if</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">pos_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows_pos</span><span class="p">)</span>
        <span class="c1"># choose order by increasing naive ub</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
        <span class="c1"># We&#39;ll just try default order and reversed as heuristic</span>
        <span class="k">for</span> <span class="n">ord_choice</span> <span class="ow">in</span> <span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">order</span><span class="p">))):</span>
            <span class="n">best</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># DFS</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">dfs</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">uvec</span><span class="p">,</span> <span class="n">cost_z</span><span class="p">):</span>
                <span class="k">nonlocal</span> <span class="n">best</span>
                <span class="c1"># Lower bound: even if we stop here, pivot y sum minimal is ceil(sum(uvec)/D)</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">ceil</span>
                <span class="n">lb</span> <span class="o">=</span> <span class="n">cost_z</span> <span class="o">+</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">uvec</span><span class="p">)</span> <span class="o">+</span> <span class="n">D</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">D</span>
                <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">lb</span> <span class="o">&gt;=</span> <span class="n">best</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="n">d</span><span class="p">:</span>
                    <span class="c1"># Check divisibility and nonnegativity</span>
                    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">uvec</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="n">val</span> <span class="o">%</span> <span class="n">D</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="k">return</span>
                    <span class="n">ysum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">val</span><span class="o">//</span><span class="n">D</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">uvec</span><span class="p">)</span>
                    <span class="n">cand</span> <span class="o">=</span> <span class="n">cost_z</span> <span class="o">+</span> <span class="n">ysum</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">best</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">cand</span> <span class="o">&lt;</span> <span class="n">best</span><span class="p">):</span>
                        <span class="n">best</span> <span class="o">=</span> <span class="n">cand</span>
                    <span class="k">return</span>
                <span class="n">jj</span> <span class="o">=</span> <span class="n">ord_choice</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">rows_pos_j</span> <span class="o">=</span> <span class="n">pos_rows</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span>
                <span class="c1"># compute ub based on positive rows</span>
                <span class="n">ub</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">uvec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">//</span> <span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rows_pos_j</span><span class="p">),</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># if ub is very large, cap it by 100 as heuristic</span>
                <span class="n">ub</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ub</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ub</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="n">ub</span> <span class="o">=</span> <span class="mi">200</span>
                <span class="c1"># Try values 0..ub</span>
                <span class="n">col</span> <span class="o">=</span> <span class="p">[</span><span class="n">P</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">jj</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">)]</span>
                <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ub</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="c1"># quick bound: if best exists and cost_z+z &gt;= best, break</span>
                    <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cost_z</span> <span class="o">+</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="n">best</span><span class="p">:</span>
                        <span class="k">break</span>
                    <span class="k">if</span> <span class="n">z</span><span class="p">:</span>
                        <span class="n">newu</span> <span class="o">=</span> <span class="n">uvec</span><span class="p">[:]</span>
                        <span class="n">ok2</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rdim</span><span class="p">):</span>
                            <span class="n">newu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">col</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">z</span>
                            <span class="c1"># allow negative intermediate; final check later</span>
                            <span class="c1"># But prune if too negative (&lt; -D) to avoid huge corrections</span>
                            <span class="k">if</span> <span class="n">newu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">D</span><span class="o">*</span><span class="mi">2</span><span class="p">:</span>
                                <span class="n">ok2</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok2</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">newu</span> <span class="o">=</span> <span class="n">uvec</span>
                    <span class="n">dfs</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">newu</span><span class="p">,</span> <span class="n">cost_z</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">dfs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">u</span><span class="p">[:],</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">best_total</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">best</span> <span class="o">&lt;</span> <span class="n">best_total</span><span class="p">:</span>
                    <span class="n">best_total</span> <span class="o">=</span> <span class="n">best</span>
    <span class="k">if</span> <span class="n">best_total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># fallback greedy upper bound</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">best_total</span>


<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">t</span><span class="p">,</span> <span class="n">buttons</span> <span class="o">=</span> <span class="n">parse_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">solve_machine</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">buttons</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">v</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<h2 id="viz_generatepy"> viz_generate.py</h2>
<ul>
<li><strong>Timestamp</strong>: 2025-12-10T16:28:59.692768</li>
<li><strong>Duration</strong>: 4.08s</li>
<li><strong>Exit Code</strong>: 0</li>
</ul>
<h3 id="stdout_7">Stdout</h3>
<div class="highlight"><pre><span></span><code>saved viz_buttons.png
</code></pre></div>
<h3 id="code_18">Code</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">lines</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;input.txt&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
<span class="c1"># pick a representative machine: with mid number of counters and buttons</span>
<span class="n">cands</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="k">continue</span>
    <span class="n">m2</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m2</span><span class="p">:</span> <span class="k">continue</span>
    <span class="n">t</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
    <span class="n">m</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">buttons</span><span class="o">=</span><span class="p">[</span><span class="n">grp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">)]</span>
    <span class="n">k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)</span>
    <span class="n">cands</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">m</span><span class="o">-</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">7</span><span class="p">),</span> <span class="n">line</span><span class="p">))</span>

<span class="n">cands</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="n">line</span><span class="o">=</span><span class="n">cands</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
<span class="c1"># parse chosen line</span>
<span class="n">m2</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\{([^}]*)\}&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">)</span>
<span class="n">t</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m2</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
<span class="n">m</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="n">buttons</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(([^)]*)\)&quot;</span><span class="p">,</span><span class="n">line</span><span class="p">):</span>
    <span class="n">s</span><span class="o">=</span><span class="n">grp</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
        <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">buttons</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>

<span class="c1"># Build bipartite graph: counters and buttons</span>
<span class="n">G</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">bipartite</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">buttons</span><span class="p">)):</span>
    <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;B</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">bipartite</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">buttons</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span>
        <span class="k">if</span> <span class="mi">0</span><span class="o">&lt;=</span><span class="n">i</span><span class="o">&lt;</span><span class="n">m</span><span class="p">:</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;C</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;B</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">colors</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">G</span><span class="p">:</span>
    <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#6fa8dc&#39;</span> <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;#f6b26b&#39;</span><span class="p">)</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;#999999&#39;</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="mi">700</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;  :    &#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;viz_buttons.png&#39;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;saved viz_buttons.png&#39;</span><span class="p">)</span>
</code></pre></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.indexes", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>